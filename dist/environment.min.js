!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):t.Environment=r()}(this,function(){"use strict";function t(t,i,n){"object"==typeof i&&(n=i,i=null);var a,s=this;if(!(t instanceof Function)){a=[];for(var o in t)t.hasOwnProperty(o)&&a.push(o)}var u=function(i){if(s.apply(this,arguments),t instanceof Function?r(this,t.call(this,i)):e(this,t,a),this.constructor===u)for(var n=u.__initializers__,o=0;o<n.length;o++)n[o].apply(this,arguments)};u.__super__=s,s.__initializers__?u.__initializers__=s.__initializers__.slice():u.__initializers__=[],i&&u.__initializers__.push(i);var h=function(){};return h.prototype=s.prototype,u.prototype=new h,u.prototype.constructor=u,r(u.prototype,n),u.extend=s.extend,u.derive=s.extend,u}function r(t,r){if(r)for(var e in r)r.hasOwnProperty(e)&&(t[e]=r[e])}function e(t,r,e){for(var i=0;i<e.length;i++){var n=e[i];t[n]=r[n]}}function i(t,r){this.action=t,this.context=r}function n(t){function r(r){var i=t.getExtension(r);i||(i=t.getExtension("MOZ_"+r)),i||(i=t.getExtension("WEBKIT_"+r)),e[r]=i}for(var e={},i={},n=0;n<O.length;n++)r(O[n]);for(n=0;n<b.length;n++){var a=b[n];i[a]=t.getParameter(t[a])}this.getExtension=function(t){return t in e||r(t),e[t]},this.getParameter=function(t){return i[t]}}function a(t,r,e){return t<r?r:t>e?e:t}function s(){return{locations:{},attriblocations:{}}}function o(t,r,e){if(!t.getShaderParameter(r,t.COMPILE_STATUS))return[t.getShaderInfoLog(r),u(e)].join("\n")}function u(t){for(var r=t.split("\n"),e=0,i=r.length;e<i;e++)r[e]=e+1+": "+r[e];return r.join("\n")}function h(t,r){if(r.castShadow&&!t.castShadow)return!0}function c(t){return"CANVAS"===t.nodeName||"VIDEO"===t.nodeName||t.complete}function _(t){var r=t[1][0]-t[0][0],e=t[1][1]-t[0][1];return Math.sqrt(r*r+e*e)}function l(t){return[(t[0][0]+t[1][0])/2,(t[0][1]+t[1][1])/2]}function f(t){return Array.isArray(t)||(t=[t,t]),t}function d(t){return t/180*Math.PI}function m(t,r,e){this.availableAttributes=t,this.availableAttributeSymbols=r,this.indicesBuffer=e,this.vao=null}function y(t){return{byte:C.Int8Array,ubyte:C.Uint8Array,short:C.Int16Array,ushort:C.Uint16Array}[t]||C.Float32Array}function p(t){return"attr_"+t}function v(t,r,e,i){switch(this.name=t,this.type=r,this.size=e,this.semantic=i||"",this.value=null,e){case 1:this.get=function(t){return this.value[t]},this.set=function(t,r){this.value[t]=r},this.copy=function(t,r){this.value[t]=this.value[t]};break;case 2:this.get=function(t,r){var e=this.value;return r[0]=e[2*t],r[1]=e[2*t+1],r},this.set=function(t,r){var e=this.value;e[2*t]=r[0],e[2*t+1]=r[1]},this.copy=function(t,r){var e=this.value;r*=2,e[t*=2]=e[r],e[t+1]=e[r+1]};break;case 3:this.get=function(t,r){var e=3*t,i=this.value;return r[0]=i[e],r[1]=i[e+1],r[2]=i[e+2],r},this.set=function(t,r){var e=3*t,i=this.value;i[e]=r[0],i[e+1]=r[1],i[e+2]=r[2]},this.copy=function(t,r){var e=this.value;r*=3,e[t*=3]=e[r],e[t+1]=e[r+1],e[t+2]=e[r+2]};break;case 4:this.get=function(t,r){var e=this.value,i=4*t;return r[0]=e[i],r[1]=e[i+1],r[2]=e[i+2],r[3]=e[i+3],r},this.set=function(t,r){var e=this.value,i=4*t;e[i]=r[0],e[i+1]=r[1],e[i+2]=r[2],e[i+3]=r[3]},this.copy=function(t,r){var e=this.value;r*=4,e[t*=4]=e[r],e[t+1]=e[r+1],e[t+2]=e[r+2],e[t+3]=e[r+3]}}}function E(t,r,e,i,n){this.name=t,this.type=r,this.buffer=e,this.size=i,this.semantic=n,this.symbol="",this.needsRemove=!1}function T(t){this.buffer=t,this.count=0}function g(t,r,e){Wr.identity();var i=new Vr({widthSegments:r,heightSegments:e});switch(t){case"px":K.translate(Wr,Wr,B.POSITIVE_X),K.rotateY(Wr,Wr,Math.PI/2);break;case"nx":K.translate(Wr,Wr,B.NEGATIVE_X),K.rotateY(Wr,Wr,-Math.PI/2);break;case"py":K.translate(Wr,Wr,B.POSITIVE_Y),K.rotateX(Wr,Wr,-Math.PI/2);break;case"ny":K.translate(Wr,Wr,B.NEGATIVE_Y),K.rotateX(Wr,Wr,Math.PI/2);break;case"pz":K.translate(Wr,Wr,B.POSITIVE_Z);break;case"nz":K.translate(Wr,Wr,B.NEGATIVE_Z),K.rotateY(Wr,Wr,Math.PI)}return i.applyTransform(Wr),i}function A(t,r){var e=(r=r||{}).devicePixelRatio||window.devicePixelRatio;this._renderer=new Mt({devicePixelRatio:e}),this._root=t,this._scene=new rr,this._skybox=new Gr({scene:this._scene}),this._camera=new $t,this._cubemap=null;var i=void 0!==window.orientation||r.mobile?mr:cr;this._control=new i({target:this._camera,domElement:this._root}),t.appendChild(this._renderer.canvas),this.resize()}var R={extend:t,derive:t},S={trigger:function(t){if(this.hasOwnProperty("__handlers__")&&this.__handlers__.hasOwnProperty(t)){var r=this.__handlers__[t],e=r.length,i=-1,n=arguments;switch(n.length){case 1:for(;++i<e;)r[i].action.call(r[i].context);return;case 2:for(;++i<e;)r[i].action.call(r[i].context,n[1]);return;case 3:for(;++i<e;)r[i].action.call(r[i].context,n[1],n[2]);return;case 4:for(;++i<e;)r[i].action.call(r[i].context,n[1],n[2],n[3]);return;case 5:for(;++i<e;)r[i].action.call(r[i].context,n[1],n[2],n[3],n[4]);return;default:for(;++i<e;)r[i].action.apply(r[i].context,Array.prototype.slice.call(n,1));return}}},on:function(t,r,e){if(t&&r){var n=this.__handlers__||(this.__handlers__={});if(n[t]){if(this.has(t,r))return}else n[t]=[];var a=new i(r,e||this);return n[t].push(a),this}},once:function(t,r,e){function i(){n.off(t,i),r.apply(this,arguments)}if(t&&r){var n=this;return this.on(t,i,e)}},before:function(t,r,e){if(t&&r)return t="before"+t,this.on(t,r,e)},after:function(t,r,e){if(t&&r)return t="after"+t,this.on(t,r,e)},success:function(t,r){return this.once("success",t,r)},error:function(t,r){return this.once("error",t,r)},off:function(t,r){var e=this.__handlers__||(this.__handlers__={});{if(r){if(e[t]){for(var i=e[t],n=[],a=0;a<i.length;a++)r&&i[a].action!==r&&n.push(i[a]);e[t]=n}return this}e[t]=[]}},has:function(t,r){var e=this.__handlers__;if(!e||!e[t])return!1;for(var i=e[t],n=0;n<i.length;n++)if(i[n].action===r)return!0}},I=0,N=Array.prototype.forEach,x={genGUID:function(){return++I},relative2absolute:function(t,r){if(!r||t.match(/^\//))return t;for(var e=t.split("/"),i=r.split("/"),n=e[0];"."===n||".."===n;)".."===n&&i.pop(),e.shift(),n=e[0];return i.join("/")+"/"+e.join("/")},extend:function(t,r){if(r)for(var e in r)r.hasOwnProperty(e)&&(t[e]=r[e]);return t},defaults:function(t,r){if(r)for(var e in r)void 0===t[e]&&(t[e]=r[e]);return t},extendWithPropList:function(t,r,e){if(r)for(var i=0;i<e.length;i++){var n=e[i];t[n]=r[n]}return t},defaultsWithPropList:function(t,r,e){if(r)for(var i=0;i<e.length;i++){var n=e[i];null==t[n]&&(t[n]=r[n])}return t},each:function(t,r,e){if(t&&r)if(t.forEach&&t.forEach===N)t.forEach(r,e);else if(t.length===+t.length)for(var i=0,n=t.length;i<n;i++)r.call(e,t[i],i,t);else for(var a in t)t.hasOwnProperty(a)&&r.call(e,t[a],a,t)},isObject:function(t){return t===Object(t)},isArray:function(t){return Array.isArray(t)},isArrayLike:function(t){return!!t&&t.length===+t.length},clone:function(t){if(x.isObject(t)){if(x.isArray(t))return t.slice();if(x.isArrayLike(t)){for(var r=new t.constructor(t.length),e=0;e<t.length;e++)r[e]=t[e];return r}return x.extend({},t)}return t}},M=function(){this.__GUID__=x.genGUID()};M.__initializers__=[function(t){x.extend(this,t)}],x.extend(M,R),x.extend(M.prototype,S);var O=["OES_texture_float","OES_texture_half_float","OES_texture_float_linear","OES_texture_half_float_linear","OES_standard_derivatives","OES_vertex_array_object","OES_element_index_uint","WEBGL_compressed_texture_s3tc","WEBGL_depth_texture","EXT_texture_filter_anisotropic","EXT_shader_texture_lod","WEBGL_draw_buffers","EXT_frag_depth","EXT_sRGB"],b=["MAX_TEXTURE_SIZE","MAX_CUBE_MAP_TEXTURE_SIZE"],P={DEPTH_BUFFER_BIT:256,STENCIL_BUFFER_BIT:1024,COLOR_BUFFER_BIT:16384,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773,DST_COLOR:774,ONE_MINUS_DST_COLOR:775,SRC_ALPHA_SATURATE:776,FUNC_ADD:32774,BLEND_EQUATION:32777,BLEND_EQUATION_RGB:32777,BLEND_EQUATION_ALPHA:34877,FUNC_SUBTRACT:32778,FUNC_REVERSE_SUBTRACT:32779,BLEND_DST_RGB:32968,BLEND_SRC_RGB:32969,BLEND_DST_ALPHA:32970,BLEND_SRC_ALPHA:32971,CONSTANT_COLOR:32769,ONE_MINUS_CONSTANT_COLOR:32770,CONSTANT_ALPHA:32771,ONE_MINUS_CONSTANT_ALPHA:32772,BLEND_COLOR:32773,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,ARRAY_BUFFER_BINDING:34964,ELEMENT_ARRAY_BUFFER_BINDING:34965,STREAM_DRAW:35040,STATIC_DRAW:35044,DYNAMIC_DRAW:35048,BUFFER_SIZE:34660,BUFFER_USAGE:34661,CURRENT_VERTEX_ATTRIB:34342,FRONT:1028,BACK:1029,FRONT_AND_BACK:1032,CULL_FACE:2884,BLEND:3042,DITHER:3024,STENCIL_TEST:2960,DEPTH_TEST:2929,SCISSOR_TEST:3089,POLYGON_OFFSET_FILL:32823,SAMPLE_ALPHA_TO_COVERAGE:32926,SAMPLE_COVERAGE:32928,NO_ERROR:0,INVALID_ENUM:1280,INVALID_VALUE:1281,INVALID_OPERATION:1282,OUT_OF_MEMORY:1285,CW:2304,CCW:2305,LINE_WIDTH:2849,ALIASED_POINT_SIZE_RANGE:33901,ALIASED_LINE_WIDTH_RANGE:33902,CULL_FACE_MODE:2885,FRONT_FACE:2886,DEPTH_RANGE:2928,DEPTH_WRITEMASK:2930,DEPTH_CLEAR_VALUE:2931,DEPTH_FUNC:2932,STENCIL_CLEAR_VALUE:2961,STENCIL_FUNC:2962,STENCIL_FAIL:2964,STENCIL_PASS_DEPTH_FAIL:2965,STENCIL_PASS_DEPTH_PASS:2966,STENCIL_REF:2967,STENCIL_VALUE_MASK:2963,STENCIL_WRITEMASK:2968,STENCIL_BACK_FUNC:34816,STENCIL_BACK_FAIL:34817,STENCIL_BACK_PASS_DEPTH_FAIL:34818,STENCIL_BACK_PASS_DEPTH_PASS:34819,STENCIL_BACK_REF:36003,STENCIL_BACK_VALUE_MASK:36004,STENCIL_BACK_WRITEMASK:36005,VIEWPORT:2978,SCISSOR_BOX:3088,COLOR_CLEAR_VALUE:3106,COLOR_WRITEMASK:3107,UNPACK_ALIGNMENT:3317,PACK_ALIGNMENT:3333,MAX_TEXTURE_SIZE:3379,MAX_VIEWPORT_DIMS:3386,SUBPIXEL_BITS:3408,RED_BITS:3410,GREEN_BITS:3411,BLUE_BITS:3412,ALPHA_BITS:3413,DEPTH_BITS:3414,STENCIL_BITS:3415,POLYGON_OFFSET_UNITS:10752,POLYGON_OFFSET_FACTOR:32824,TEXTURE_BINDING_2D:32873,SAMPLE_BUFFERS:32936,SAMPLES:32937,SAMPLE_COVERAGE_VALUE:32938,SAMPLE_COVERAGE_INVERT:32939,COMPRESSED_TEXTURE_FORMATS:34467,DONT_CARE:4352,FASTEST:4353,NICEST:4354,GENERATE_MIPMAP_HINT:33170,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DEPTH_COMPONENT:6402,ALPHA:6406,RGB:6407,RGBA:6408,LUMINANCE:6409,LUMINANCE_ALPHA:6410,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,FRAGMENT_SHADER:35632,VERTEX_SHADER:35633,MAX_VERTEX_ATTRIBS:34921,MAX_VERTEX_UNIFORM_VECTORS:36347,MAX_VARYING_VECTORS:36348,MAX_COMBINED_TEXTURE_IMAGE_UNITS:35661,MAX_VERTEX_TEXTURE_IMAGE_UNITS:35660,MAX_TEXTURE_IMAGE_UNITS:34930,MAX_FRAGMENT_UNIFORM_VECTORS:36349,SHADER_TYPE:35663,DELETE_STATUS:35712,LINK_STATUS:35714,VALIDATE_STATUS:35715,ATTACHED_SHADERS:35717,ACTIVE_UNIFORMS:35718,ACTIVE_ATTRIBUTES:35721,SHADING_LANGUAGE_VERSION:35724,CURRENT_PROGRAM:35725,NEVER:512,LESS:513,EQUAL:514,LEQUAL:515,GREATER:516,NOTEQUAL:517,GEQUAL:518,ALWAYS:519,KEEP:7680,REPLACE:7681,INCR:7682,DECR:7683,INVERT:5386,INCR_WRAP:34055,DECR_WRAP:34056,VENDOR:7936,RENDERER:7937,VERSION:7938,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,TEXTURE_2D:3553,TEXTURE:5890,TEXTURE_CUBE_MAP:34067,TEXTURE_BINDING_CUBE_MAP:34068,TEXTURE_CUBE_MAP_POSITIVE_X:34069,TEXTURE_CUBE_MAP_NEGATIVE_X:34070,TEXTURE_CUBE_MAP_POSITIVE_Y:34071,TEXTURE_CUBE_MAP_NEGATIVE_Y:34072,TEXTURE_CUBE_MAP_POSITIVE_Z:34073,TEXTURE_CUBE_MAP_NEGATIVE_Z:34074,MAX_CUBE_MAP_TEXTURE_SIZE:34076,TEXTURE0:33984,TEXTURE1:33985,TEXTURE2:33986,TEXTURE3:33987,TEXTURE4:33988,TEXTURE5:33989,TEXTURE6:33990,TEXTURE7:33991,TEXTURE8:33992,TEXTURE9:33993,TEXTURE10:33994,TEXTURE11:33995,TEXTURE12:33996,TEXTURE13:33997,TEXTURE14:33998,TEXTURE15:33999,TEXTURE16:34e3,TEXTURE17:34001,TEXTURE18:34002,TEXTURE19:34003,TEXTURE20:34004,TEXTURE21:34005,TEXTURE22:34006,TEXTURE23:34007,TEXTURE24:34008,TEXTURE25:34009,TEXTURE26:34010,TEXTURE27:34011,TEXTURE28:34012,TEXTURE29:34013,TEXTURE30:34014,TEXTURE31:34015,ACTIVE_TEXTURE:34016,REPEAT:10497,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,VERTEX_ATTRIB_ARRAY_ENABLED:34338,VERTEX_ATTRIB_ARRAY_SIZE:34339,VERTEX_ATTRIB_ARRAY_STRIDE:34340,VERTEX_ATTRIB_ARRAY_TYPE:34341,VERTEX_ATTRIB_ARRAY_NORMALIZED:34922,VERTEX_ATTRIB_ARRAY_POINTER:34373,VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:34975,COMPILE_STATUS:35713,LOW_FLOAT:36336,MEDIUM_FLOAT:36337,HIGH_FLOAT:36338,LOW_INT:36339,MEDIUM_INT:36340,HIGH_INT:36341,FRAMEBUFFER:36160,RENDERBUFFER:36161,RGBA4:32854,RGB5_A1:32855,RGB565:36194,DEPTH_COMPONENT16:33189,STENCIL_INDEX:6401,STENCIL_INDEX8:36168,DEPTH_STENCIL:34041,RENDERBUFFER_WIDTH:36162,RENDERBUFFER_HEIGHT:36163,RENDERBUFFER_INTERNAL_FORMAT:36164,RENDERBUFFER_RED_SIZE:36176,RENDERBUFFER_GREEN_SIZE:36177,RENDERBUFFER_BLUE_SIZE:36178,RENDERBUFFER_ALPHA_SIZE:36179,RENDERBUFFER_DEPTH_SIZE:36180,RENDERBUFFER_STENCIL_SIZE:36181,FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE:36048,FRAMEBUFFER_ATTACHMENT_OBJECT_NAME:36049,FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL:36050,FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE:36051,COLOR_ATTACHMENT0:36064,DEPTH_ATTACHMENT:36096,STENCIL_ATTACHMENT:36128,DEPTH_STENCIL_ATTACHMENT:33306,NONE:0,FRAMEBUFFER_COMPLETE:36053,FRAMEBUFFER_INCOMPLETE_ATTACHMENT:36054,FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:36055,FRAMEBUFFER_INCOMPLETE_DIMENSIONS:36057,FRAMEBUFFER_UNSUPPORTED:36061,FRAMEBUFFER_BINDING:36006,RENDERBUFFER_BINDING:36007,MAX_RENDERBUFFER_SIZE:34024,INVALID_FRAMEBUFFER_OPERATION:1286,UNPACK_FLIP_Y_WEBGL:37440,UNPACK_PREMULTIPLY_ALPHA_WEBGL:37441,CONTEXT_LOST_WEBGL:37442,UNPACK_COLORSPACE_CONVERSION_WEBGL:37443,BROWSER_DEFAULT_WEBGL:37444},w=!0;try{var L=document.createElement("canvas");if(!(L.getContext("webgl")||L.getContext("experimental-webgl")))throw new Error}catch(t){w=!1}var C={};C.supportWebGL=function(){return w},C.Int8Array="undefined"==typeof Int8Array?Array:Int8Array,C.Uint8Array="undefined"==typeof Uint8Array?Array:Uint8Array,C.Uint16Array="undefined"==typeof Uint16Array?Array:Uint16Array,C.Uint32Array="undefined"==typeof Uint32Array?Array:Uint32Array,C.Int16Array="undefined"==typeof Int16Array?Array:Int16Array,C.Float32Array="undefined"==typeof Float32Array?Array:Float32Array,C.Float64Array="undefined"==typeof Float64Array?Array:Float64Array;"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var D=function(t,r){return r={exports:{}},t(r,r.exports),r.exports}(function(t,r){!function(t){var e={};e.exports=r,function(t){if(!r)var r=1e-6;if(!e)var e="undefined"!=typeof Float32Array?Float32Array:Array;if(!i)var i=Math.random;var n={};n.setMatrixArrayType=function(t){e=t},void 0!==t&&(t.glMatrix=n);var a=Math.PI/180;n.toRadian=function(t){return t*a};var s={};s.create=function(){var t=new e(2);return t[0]=0,t[1]=0,t},s.clone=function(t){var r=new e(2);return r[0]=t[0],r[1]=t[1],r},s.fromValues=function(t,r){var i=new e(2);return i[0]=t,i[1]=r,i},s.copy=function(t,r){return t[0]=r[0],t[1]=r[1],t},s.set=function(t,r,e){return t[0]=r,t[1]=e,t},s.add=function(t,r,e){return t[0]=r[0]+e[0],t[1]=r[1]+e[1],t},s.subtract=function(t,r,e){return t[0]=r[0]-e[0],t[1]=r[1]-e[1],t},s.sub=s.subtract,s.multiply=function(t,r,e){return t[0]=r[0]*e[0],t[1]=r[1]*e[1],t},s.mul=s.multiply,s.divide=function(t,r,e){return t[0]=r[0]/e[0],t[1]=r[1]/e[1],t},s.div=s.divide,s.min=function(t,r,e){return t[0]=Math.min(r[0],e[0]),t[1]=Math.min(r[1],e[1]),t},s.max=function(t,r,e){return t[0]=Math.max(r[0],e[0]),t[1]=Math.max(r[1],e[1]),t},s.scale=function(t,r,e){return t[0]=r[0]*e,t[1]=r[1]*e,t},s.scaleAndAdd=function(t,r,e,i){return t[0]=r[0]+e[0]*i,t[1]=r[1]+e[1]*i,t},s.distance=function(t,r){var e=r[0]-t[0],i=r[1]-t[1];return Math.sqrt(e*e+i*i)},s.dist=s.distance,s.squaredDistance=function(t,r){var e=r[0]-t[0],i=r[1]-t[1];return e*e+i*i},s.sqrDist=s.squaredDistance,s.length=function(t){var r=t[0],e=t[1];return Math.sqrt(r*r+e*e)},s.len=s.length,s.squaredLength=function(t){var r=t[0],e=t[1];return r*r+e*e},s.sqrLen=s.squaredLength,s.negate=function(t,r){return t[0]=-r[0],t[1]=-r[1],t},s.inverse=function(t,r){return t[0]=1/r[0],t[1]=1/r[1],t},s.normalize=function(t,r){var e=r[0],i=r[1],n=e*e+i*i;return n>0&&(n=1/Math.sqrt(n),t[0]=r[0]*n,t[1]=r[1]*n),t},s.dot=function(t,r){return t[0]*r[0]+t[1]*r[1]},s.cross=function(t,r,e){var i=r[0]*e[1]-r[1]*e[0];return t[0]=t[1]=0,t[2]=i,t},s.lerp=function(t,r,e,i){var n=r[0],a=r[1];return t[0]=n+i*(e[0]-n),t[1]=a+i*(e[1]-a),t},s.random=function(t,r){r=r||1;var e=2*i()*Math.PI;return t[0]=Math.cos(e)*r,t[1]=Math.sin(e)*r,t},s.transformMat2=function(t,r,e){var i=r[0],n=r[1];return t[0]=e[0]*i+e[2]*n,t[1]=e[1]*i+e[3]*n,t},s.transformMat2d=function(t,r,e){var i=r[0],n=r[1];return t[0]=e[0]*i+e[2]*n+e[4],t[1]=e[1]*i+e[3]*n+e[5],t},s.transformMat3=function(t,r,e){var i=r[0],n=r[1];return t[0]=e[0]*i+e[3]*n+e[6],t[1]=e[1]*i+e[4]*n+e[7],t},s.transformMat4=function(t,r,e){var i=r[0],n=r[1];return t[0]=e[0]*i+e[4]*n+e[12],t[1]=e[1]*i+e[5]*n+e[13],t},s.forEach=function(){var t=s.create();return function(r,e,i,n,a,s){var o,u;for(e||(e=2),i||(i=0),u=n?Math.min(n*e+i,r.length):r.length,o=i;o<u;o+=e)t[0]=r[o],t[1]=r[o+1],a(t,t,s),r[o]=t[0],r[o+1]=t[1];return r}}(),s.str=function(t){return"vec2("+t[0]+", "+t[1]+")"},void 0!==t&&(t.vec2=s);var o={};o.create=function(){var t=new e(3);return t[0]=0,t[1]=0,t[2]=0,t},o.clone=function(t){var r=new e(3);return r[0]=t[0],r[1]=t[1],r[2]=t[2],r},o.fromValues=function(t,r,i){var n=new e(3);return n[0]=t,n[1]=r,n[2]=i,n},o.copy=function(t,r){return t[0]=r[0],t[1]=r[1],t[2]=r[2],t},o.set=function(t,r,e,i){return t[0]=r,t[1]=e,t[2]=i,t},o.add=function(t,r,e){return t[0]=r[0]+e[0],t[1]=r[1]+e[1],t[2]=r[2]+e[2],t},o.subtract=function(t,r,e){return t[0]=r[0]-e[0],t[1]=r[1]-e[1],t[2]=r[2]-e[2],t},o.sub=o.subtract,o.multiply=function(t,r,e){return t[0]=r[0]*e[0],t[1]=r[1]*e[1],t[2]=r[2]*e[2],t},o.mul=o.multiply,o.divide=function(t,r,e){return t[0]=r[0]/e[0],t[1]=r[1]/e[1],t[2]=r[2]/e[2],t},o.div=o.divide,o.min=function(t,r,e){return t[0]=Math.min(r[0],e[0]),t[1]=Math.min(r[1],e[1]),t[2]=Math.min(r[2],e[2]),t},o.max=function(t,r,e){return t[0]=Math.max(r[0],e[0]),t[1]=Math.max(r[1],e[1]),t[2]=Math.max(r[2],e[2]),t},o.scale=function(t,r,e){return t[0]=r[0]*e,t[1]=r[1]*e,t[2]=r[2]*e,t},o.scaleAndAdd=function(t,r,e,i){return t[0]=r[0]+e[0]*i,t[1]=r[1]+e[1]*i,t[2]=r[2]+e[2]*i,t},o.distance=function(t,r){var e=r[0]-t[0],i=r[1]-t[1],n=r[2]-t[2];return Math.sqrt(e*e+i*i+n*n)},o.dist=o.distance,o.squaredDistance=function(t,r){var e=r[0]-t[0],i=r[1]-t[1],n=r[2]-t[2];return e*e+i*i+n*n},o.sqrDist=o.squaredDistance,o.length=function(t){var r=t[0],e=t[1],i=t[2];return Math.sqrt(r*r+e*e+i*i)},o.len=o.length,o.squaredLength=function(t){var r=t[0],e=t[1],i=t[2];return r*r+e*e+i*i},o.sqrLen=o.squaredLength,o.negate=function(t,r){return t[0]=-r[0],t[1]=-r[1],t[2]=-r[2],t},o.inverse=function(t,r){return t[0]=1/r[0],t[1]=1/r[1],t[2]=1/r[2],t},o.normalize=function(t,r){var e=r[0],i=r[1],n=r[2],a=e*e+i*i+n*n;return a>0&&(a=1/Math.sqrt(a),t[0]=r[0]*a,t[1]=r[1]*a,t[2]=r[2]*a),t},o.dot=function(t,r){return t[0]*r[0]+t[1]*r[1]+t[2]*r[2]},o.cross=function(t,r,e){var i=r[0],n=r[1],a=r[2],s=e[0],o=e[1],u=e[2];return t[0]=n*u-a*o,t[1]=a*s-i*u,t[2]=i*o-n*s,t},o.lerp=function(t,r,e,i){var n=r[0],a=r[1],s=r[2];return t[0]=n+i*(e[0]-n),t[1]=a+i*(e[1]-a),t[2]=s+i*(e[2]-s),t},o.random=function(t,r){r=r||1;var e=2*i()*Math.PI,n=2*i()-1,a=Math.sqrt(1-n*n)*r;return t[0]=Math.cos(e)*a,t[1]=Math.sin(e)*a,t[2]=n*r,t},o.transformMat4=function(t,r,e){var i=r[0],n=r[1],a=r[2],s=e[3]*i+e[7]*n+e[11]*a+e[15];return s=s||1,t[0]=(e[0]*i+e[4]*n+e[8]*a+e[12])/s,t[1]=(e[1]*i+e[5]*n+e[9]*a+e[13])/s,t[2]=(e[2]*i+e[6]*n+e[10]*a+e[14])/s,t},o.transformMat3=function(t,r,e){var i=r[0],n=r[1],a=r[2];return t[0]=i*e[0]+n*e[3]+a*e[6],t[1]=i*e[1]+n*e[4]+a*e[7],t[2]=i*e[2]+n*e[5]+a*e[8],t},o.transformQuat=function(t,r,e){var i=r[0],n=r[1],a=r[2],s=e[0],o=e[1],u=e[2],h=e[3],c=h*i+o*a-u*n,_=h*n+u*i-s*a,l=h*a+s*n-o*i,f=-s*i-o*n-u*a;return t[0]=c*h+f*-s+_*-u-l*-o,t[1]=_*h+f*-o+l*-s-c*-u,t[2]=l*h+f*-u+c*-o-_*-s,t},o.rotateX=function(t,r,e,i){var n=[],a=[];return n[0]=r[0]-e[0],n[1]=r[1]-e[1],n[2]=r[2]-e[2],a[0]=n[0],a[1]=n[1]*Math.cos(i)-n[2]*Math.sin(i),a[2]=n[1]*Math.sin(i)+n[2]*Math.cos(i),t[0]=a[0]+e[0],t[1]=a[1]+e[1],t[2]=a[2]+e[2],t},o.rotateY=function(t,r,e,i){var n=[],a=[];return n[0]=r[0]-e[0],n[1]=r[1]-e[1],n[2]=r[2]-e[2],a[0]=n[2]*Math.sin(i)+n[0]*Math.cos(i),a[1]=n[1],a[2]=n[2]*Math.cos(i)-n[0]*Math.sin(i),t[0]=a[0]+e[0],t[1]=a[1]+e[1],t[2]=a[2]+e[2],t},o.rotateZ=function(t,r,e,i){var n=[],a=[];return n[0]=r[0]-e[0],n[1]=r[1]-e[1],n[2]=r[2]-e[2],a[0]=n[0]*Math.cos(i)-n[1]*Math.sin(i),a[1]=n[0]*Math.sin(i)+n[1]*Math.cos(i),a[2]=n[2],t[0]=a[0]+e[0],t[1]=a[1]+e[1],t[2]=a[2]+e[2],t},o.forEach=function(){var t=o.create();return function(r,e,i,n,a,s){var o,u;for(e||(e=3),i||(i=0),u=n?Math.min(n*e+i,r.length):r.length,o=i;o<u;o+=e)t[0]=r[o],t[1]=r[o+1],t[2]=r[o+2],a(t,t,s),r[o]=t[0],r[o+1]=t[1],r[o+2]=t[2];return r}}(),o.angle=function(t,r){var e=o.fromValues(t[0],t[1],t[2]),i=o.fromValues(r[0],r[1],r[2]);o.normalize(e,e),o.normalize(i,i);var n=o.dot(e,i);return n>1?0:Math.acos(n)},o.str=function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},void 0!==t&&(t.vec3=o);var u={};u.create=function(){var t=new e(4);return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t},u.clone=function(t){var r=new e(4);return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r},u.fromValues=function(t,r,i,n){var a=new e(4);return a[0]=t,a[1]=r,a[2]=i,a[3]=n,a},u.copy=function(t,r){return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t},u.set=function(t,r,e,i,n){return t[0]=r,t[1]=e,t[2]=i,t[3]=n,t},u.add=function(t,r,e){return t[0]=r[0]+e[0],t[1]=r[1]+e[1],t[2]=r[2]+e[2],t[3]=r[3]+e[3],t},u.subtract=function(t,r,e){return t[0]=r[0]-e[0],t[1]=r[1]-e[1],t[2]=r[2]-e[2],t[3]=r[3]-e[3],t},u.sub=u.subtract,u.multiply=function(t,r,e){return t[0]=r[0]*e[0],t[1]=r[1]*e[1],t[2]=r[2]*e[2],t[3]=r[3]*e[3],t},u.mul=u.multiply,u.divide=function(t,r,e){return t[0]=r[0]/e[0],t[1]=r[1]/e[1],t[2]=r[2]/e[2],t[3]=r[3]/e[3],t},u.div=u.divide,u.min=function(t,r,e){return t[0]=Math.min(r[0],e[0]),t[1]=Math.min(r[1],e[1]),t[2]=Math.min(r[2],e[2]),t[3]=Math.min(r[3],e[3]),t},u.max=function(t,r,e){return t[0]=Math.max(r[0],e[0]),t[1]=Math.max(r[1],e[1]),t[2]=Math.max(r[2],e[2]),t[3]=Math.max(r[3],e[3]),t},u.scale=function(t,r,e){return t[0]=r[0]*e,t[1]=r[1]*e,t[2]=r[2]*e,t[3]=r[3]*e,t},u.scaleAndAdd=function(t,r,e,i){return t[0]=r[0]+e[0]*i,t[1]=r[1]+e[1]*i,t[2]=r[2]+e[2]*i,t[3]=r[3]+e[3]*i,t},u.distance=function(t,r){var e=r[0]-t[0],i=r[1]-t[1],n=r[2]-t[2],a=r[3]-t[3];return Math.sqrt(e*e+i*i+n*n+a*a)},u.dist=u.distance,u.squaredDistance=function(t,r){var e=r[0]-t[0],i=r[1]-t[1],n=r[2]-t[2],a=r[3]-t[3];return e*e+i*i+n*n+a*a},u.sqrDist=u.squaredDistance,u.length=function(t){var r=t[0],e=t[1],i=t[2],n=t[3];return Math.sqrt(r*r+e*e+i*i+n*n)},u.len=u.length,u.squaredLength=function(t){var r=t[0],e=t[1],i=t[2],n=t[3];return r*r+e*e+i*i+n*n},u.sqrLen=u.squaredLength,u.negate=function(t,r){return t[0]=-r[0],t[1]=-r[1],t[2]=-r[2],t[3]=-r[3],t},u.inverse=function(t,r){return t[0]=1/r[0],t[1]=1/r[1],t[2]=1/r[2],t[3]=1/r[3],t},u.normalize=function(t,r){var e=r[0],i=r[1],n=r[2],a=r[3],s=e*e+i*i+n*n+a*a;return s>0&&(s=1/Math.sqrt(s),t[0]=r[0]*s,t[1]=r[1]*s,t[2]=r[2]*s,t[3]=r[3]*s),t},u.dot=function(t,r){return t[0]*r[0]+t[1]*r[1]+t[2]*r[2]+t[3]*r[3]},u.lerp=function(t,r,e,i){var n=r[0],a=r[1],s=r[2],o=r[3];return t[0]=n+i*(e[0]-n),t[1]=a+i*(e[1]-a),t[2]=s+i*(e[2]-s),t[3]=o+i*(e[3]-o),t},u.random=function(t,r){return r=r||1,t[0]=i(),t[1]=i(),t[2]=i(),t[3]=i(),u.normalize(t,t),u.scale(t,t,r),t},u.transformMat4=function(t,r,e){var i=r[0],n=r[1],a=r[2],s=r[3];return t[0]=e[0]*i+e[4]*n+e[8]*a+e[12]*s,t[1]=e[1]*i+e[5]*n+e[9]*a+e[13]*s,t[2]=e[2]*i+e[6]*n+e[10]*a+e[14]*s,t[3]=e[3]*i+e[7]*n+e[11]*a+e[15]*s,t},u.transformQuat=function(t,r,e){var i=r[0],n=r[1],a=r[2],s=e[0],o=e[1],u=e[2],h=e[3],c=h*i+o*a-u*n,_=h*n+u*i-s*a,l=h*a+s*n-o*i,f=-s*i-o*n-u*a;return t[0]=c*h+f*-s+_*-u-l*-o,t[1]=_*h+f*-o+l*-s-c*-u,t[2]=l*h+f*-u+c*-o-_*-s,t},u.forEach=function(){var t=u.create();return function(r,e,i,n,a,s){var o,u;for(e||(e=4),i||(i=0),u=n?Math.min(n*e+i,r.length):r.length,o=i;o<u;o+=e)t[0]=r[o],t[1]=r[o+1],t[2]=r[o+2],t[3]=r[o+3],a(t,t,s),r[o]=t[0],r[o+1]=t[1],r[o+2]=t[2],r[o+3]=t[3];return r}}(),u.str=function(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},void 0!==t&&(t.vec4=u);var h={};h.create=function(){var t=new e(4);return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},h.clone=function(t){var r=new e(4);return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r},h.copy=function(t,r){return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t},h.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},h.transpose=function(t,r){if(t===r){var e=r[1];t[1]=r[2],t[2]=e}else t[0]=r[0],t[1]=r[2],t[2]=r[1],t[3]=r[3];return t},h.invert=function(t,r){var e=r[0],i=r[1],n=r[2],a=r[3],s=e*a-n*i;return s?(s=1/s,t[0]=a*s,t[1]=-i*s,t[2]=-n*s,t[3]=e*s,t):null},h.adjoint=function(t,r){var e=r[0];return t[0]=r[3],t[1]=-r[1],t[2]=-r[2],t[3]=e,t},h.determinant=function(t){return t[0]*t[3]-t[2]*t[1]},h.multiply=function(t,r,e){var i=r[0],n=r[1],a=r[2],s=r[3],o=e[0],u=e[1],h=e[2],c=e[3];return t[0]=i*o+a*u,t[1]=n*o+s*u,t[2]=i*h+a*c,t[3]=n*h+s*c,t},h.mul=h.multiply,h.rotate=function(t,r,e){var i=r[0],n=r[1],a=r[2],s=r[3],o=Math.sin(e),u=Math.cos(e);return t[0]=i*u+a*o,t[1]=n*u+s*o,t[2]=i*-o+a*u,t[3]=n*-o+s*u,t},h.scale=function(t,r,e){var i=r[0],n=r[1],a=r[2],s=r[3],o=e[0],u=e[1];return t[0]=i*o,t[1]=n*o,t[2]=a*u,t[3]=s*u,t},h.str=function(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},h.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2))},h.LDU=function(t,r,e,i){return t[2]=i[2]/i[0],e[0]=i[0],e[1]=i[1],e[3]=i[3]-t[2]*e[1],[t,r,e]},void 0!==t&&(t.mat2=h);var c={};c.create=function(){var t=new e(6);return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},c.clone=function(t){var r=new e(6);return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=t[5],r},c.copy=function(t,r){return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5],t},c.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},c.invert=function(t,r){var e=r[0],i=r[1],n=r[2],a=r[3],s=r[4],o=r[5],u=e*a-i*n;return u?(u=1/u,t[0]=a*u,t[1]=-i*u,t[2]=-n*u,t[3]=e*u,t[4]=(n*o-a*s)*u,t[5]=(i*s-e*o)*u,t):null},c.determinant=function(t){return t[0]*t[3]-t[1]*t[2]},c.multiply=function(t,r,e){var i=r[0],n=r[1],a=r[2],s=r[3],o=r[4],u=r[5],h=e[0],c=e[1],_=e[2],l=e[3],f=e[4],d=e[5];return t[0]=i*h+a*c,t[1]=n*h+s*c,t[2]=i*_+a*l,t[3]=n*_+s*l,t[4]=i*f+a*d+o,t[5]=n*f+s*d+u,t},c.mul=c.multiply,c.rotate=function(t,r,e){var i=r[0],n=r[1],a=r[2],s=r[3],o=r[4],u=r[5],h=Math.sin(e),c=Math.cos(e);return t[0]=i*c+a*h,t[1]=n*c+s*h,t[2]=i*-h+a*c,t[3]=n*-h+s*c,t[4]=o,t[5]=u,t},c.scale=function(t,r,e){var i=r[0],n=r[1],a=r[2],s=r[3],o=r[4],u=r[5],h=e[0],c=e[1];return t[0]=i*h,t[1]=n*h,t[2]=a*c,t[3]=s*c,t[4]=o,t[5]=u,t},c.translate=function(t,r,e){var i=r[0],n=r[1],a=r[2],s=r[3],o=r[4],u=r[5],h=e[0],c=e[1];return t[0]=i,t[1]=n,t[2]=a,t[3]=s,t[4]=i*h+a*c+o,t[5]=n*h+s*c+u,t},c.str=function(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"},c.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+1)},void 0!==t&&(t.mat2d=c);var _={};_.create=function(){var t=new e(9);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},_.fromMat4=function(t,r){return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[4],t[4]=r[5],t[5]=r[6],t[6]=r[8],t[7]=r[9],t[8]=r[10],t},_.clone=function(t){var r=new e(9);return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[8]=t[8],r},_.copy=function(t,r){return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5],t[6]=r[6],t[7]=r[7],t[8]=r[8],t},_.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},_.transpose=function(t,r){if(t===r){var e=r[1],i=r[2],n=r[5];t[1]=r[3],t[2]=r[6],t[3]=e,t[5]=r[7],t[6]=i,t[7]=n}else t[0]=r[0],t[1]=r[3],t[2]=r[6],t[3]=r[1],t[4]=r[4],t[5]=r[7],t[6]=r[2],t[7]=r[5],t[8]=r[8];return t},_.invert=function(t,r){var e=r[0],i=r[1],n=r[2],a=r[3],s=r[4],o=r[5],u=r[6],h=r[7],c=r[8],_=c*s-o*h,l=-c*a+o*u,f=h*a-s*u,d=e*_+i*l+n*f;return d?(d=1/d,t[0]=_*d,t[1]=(-c*i+n*h)*d,t[2]=(o*i-n*s)*d,t[3]=l*d,t[4]=(c*e-n*u)*d,t[5]=(-o*e+n*a)*d,t[6]=f*d,t[7]=(-h*e+i*u)*d,t[8]=(s*e-i*a)*d,t):null},_.adjoint=function(t,r){var e=r[0],i=r[1],n=r[2],a=r[3],s=r[4],o=r[5],u=r[6],h=r[7],c=r[8];return t[0]=s*c-o*h,t[1]=n*h-i*c,t[2]=i*o-n*s,t[3]=o*u-a*c,t[4]=e*c-n*u,t[5]=n*a-e*o,t[6]=a*h-s*u,t[7]=i*u-e*h,t[8]=e*s-i*a,t},_.determinant=function(t){var r=t[0],e=t[1],i=t[2],n=t[3],a=t[4],s=t[5],o=t[6],u=t[7],h=t[8];return r*(h*a-s*u)+e*(-h*n+s*o)+i*(u*n-a*o)},_.multiply=function(t,r,e){var i=r[0],n=r[1],a=r[2],s=r[3],o=r[4],u=r[5],h=r[6],c=r[7],_=r[8],l=e[0],f=e[1],d=e[2],m=e[3],y=e[4],p=e[5],v=e[6],E=e[7],T=e[8];return t[0]=l*i+f*s+d*h,t[1]=l*n+f*o+d*c,t[2]=l*a+f*u+d*_,t[3]=m*i+y*s+p*h,t[4]=m*n+y*o+p*c,t[5]=m*a+y*u+p*_,t[6]=v*i+E*s+T*h,t[7]=v*n+E*o+T*c,t[8]=v*a+E*u+T*_,t},_.mul=_.multiply,_.translate=function(t,r,e){var i=r[0],n=r[1],a=r[2],s=r[3],o=r[4],u=r[5],h=r[6],c=r[7],_=r[8],l=e[0],f=e[1];return t[0]=i,t[1]=n,t[2]=a,t[3]=s,t[4]=o,t[5]=u,t[6]=l*i+f*s+h,t[7]=l*n+f*o+c,t[8]=l*a+f*u+_,t},_.rotate=function(t,r,e){var i=r[0],n=r[1],a=r[2],s=r[3],o=r[4],u=r[5],h=r[6],c=r[7],_=r[8],l=Math.sin(e),f=Math.cos(e);return t[0]=f*i+l*s,t[1]=f*n+l*o,t[2]=f*a+l*u,t[3]=f*s-l*i,t[4]=f*o-l*n,t[5]=f*u-l*a,t[6]=h,t[7]=c,t[8]=_,t},_.scale=function(t,r,e){var i=e[0],n=e[1];return t[0]=i*r[0],t[1]=i*r[1],t[2]=i*r[2],t[3]=n*r[3],t[4]=n*r[4],t[5]=n*r[5],t[6]=r[6],t[7]=r[7],t[8]=r[8],t},_.fromMat2d=function(t,r){return t[0]=r[0],t[1]=r[1],t[2]=0,t[3]=r[2],t[4]=r[3],t[5]=0,t[6]=r[4],t[7]=r[5],t[8]=1,t},_.fromQuat=function(t,r){var e=r[0],i=r[1],n=r[2],a=r[3],s=e+e,o=i+i,u=n+n,h=e*s,c=i*s,_=i*o,l=n*s,f=n*o,d=n*u,m=a*s,y=a*o,p=a*u;return t[0]=1-_-d,t[3]=c-p,t[6]=l+y,t[1]=c+p,t[4]=1-h-d,t[7]=f-m,t[2]=l-y,t[5]=f+m,t[8]=1-h-_,t},_.normalFromMat4=function(t,r){var e=r[0],i=r[1],n=r[2],a=r[3],s=r[4],o=r[5],u=r[6],h=r[7],c=r[8],_=r[9],l=r[10],f=r[11],d=r[12],m=r[13],y=r[14],p=r[15],v=e*o-i*s,E=e*u-n*s,T=e*h-a*s,g=i*u-n*o,A=i*h-a*o,R=n*h-a*u,S=c*m-_*d,I=c*y-l*d,N=c*p-f*d,x=_*y-l*m,M=_*p-f*m,O=l*p-f*y,b=v*O-E*M+T*x+g*N-A*I+R*S;return b?(b=1/b,t[0]=(o*O-u*M+h*x)*b,t[1]=(u*N-s*O-h*I)*b,t[2]=(s*M-o*N+h*S)*b,t[3]=(n*M-i*O-a*x)*b,t[4]=(e*O-n*N+a*I)*b,t[5]=(i*N-e*M-a*S)*b,t[6]=(m*R-y*A+p*g)*b,t[7]=(y*T-d*R-p*E)*b,t[8]=(d*A-m*T+p*v)*b,t):null},_.str=function(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"},_.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2))},void 0!==t&&(t.mat3=_);var l={};l.create=function(){var t=new e(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},l.clone=function(t){var r=new e(16);return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15],r},l.copy=function(t,r){return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5],t[6]=r[6],t[7]=r[7],t[8]=r[8],t[9]=r[9],t[10]=r[10],t[11]=r[11],t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15],t},l.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},l.transpose=function(t,r){if(t===r){var e=r[1],i=r[2],n=r[3],a=r[6],s=r[7],o=r[11];t[1]=r[4],t[2]=r[8],t[3]=r[12],t[4]=e,t[6]=r[9],t[7]=r[13],t[8]=i,t[9]=a,t[11]=r[14],t[12]=n,t[13]=s,t[14]=o}else t[0]=r[0],t[1]=r[4],t[2]=r[8],t[3]=r[12],t[4]=r[1],t[5]=r[5],t[6]=r[9],t[7]=r[13],t[8]=r[2],t[9]=r[6],t[10]=r[10],t[11]=r[14],t[12]=r[3],t[13]=r[7],t[14]=r[11],t[15]=r[15];return t},l.invert=function(t,r){var e=r[0],i=r[1],n=r[2],a=r[3],s=r[4],o=r[5],u=r[6],h=r[7],c=r[8],_=r[9],l=r[10],f=r[11],d=r[12],m=r[13],y=r[14],p=r[15],v=e*o-i*s,E=e*u-n*s,T=e*h-a*s,g=i*u-n*o,A=i*h-a*o,R=n*h-a*u,S=c*m-_*d,I=c*y-l*d,N=c*p-f*d,x=_*y-l*m,M=_*p-f*m,O=l*p-f*y,b=v*O-E*M+T*x+g*N-A*I+R*S;return b?(b=1/b,t[0]=(o*O-u*M+h*x)*b,t[1]=(n*M-i*O-a*x)*b,t[2]=(m*R-y*A+p*g)*b,t[3]=(l*A-_*R-f*g)*b,t[4]=(u*N-s*O-h*I)*b,t[5]=(e*O-n*N+a*I)*b,t[6]=(y*T-d*R-p*E)*b,t[7]=(c*R-l*T+f*E)*b,t[8]=(s*M-o*N+h*S)*b,t[9]=(i*N-e*M-a*S)*b,t[10]=(d*A-m*T+p*v)*b,t[11]=(_*T-c*A-f*v)*b,t[12]=(o*I-s*x-u*S)*b,t[13]=(e*x-i*I+n*S)*b,t[14]=(m*E-d*g-y*v)*b,t[15]=(c*g-_*E+l*v)*b,t):null},l.adjoint=function(t,r){var e=r[0],i=r[1],n=r[2],a=r[3],s=r[4],o=r[5],u=r[6],h=r[7],c=r[8],_=r[9],l=r[10],f=r[11],d=r[12],m=r[13],y=r[14],p=r[15];return t[0]=o*(l*p-f*y)-_*(u*p-h*y)+m*(u*f-h*l),t[1]=-(i*(l*p-f*y)-_*(n*p-a*y)+m*(n*f-a*l)),t[2]=i*(u*p-h*y)-o*(n*p-a*y)+m*(n*h-a*u),t[3]=-(i*(u*f-h*l)-o*(n*f-a*l)+_*(n*h-a*u)),t[4]=-(s*(l*p-f*y)-c*(u*p-h*y)+d*(u*f-h*l)),t[5]=e*(l*p-f*y)-c*(n*p-a*y)+d*(n*f-a*l),t[6]=-(e*(u*p-h*y)-s*(n*p-a*y)+d*(n*h-a*u)),t[7]=e*(u*f-h*l)-s*(n*f-a*l)+c*(n*h-a*u),t[8]=s*(_*p-f*m)-c*(o*p-h*m)+d*(o*f-h*_),t[9]=-(e*(_*p-f*m)-c*(i*p-a*m)+d*(i*f-a*_)),t[10]=e*(o*p-h*m)-s*(i*p-a*m)+d*(i*h-a*o),t[11]=-(e*(o*f-h*_)-s*(i*f-a*_)+c*(i*h-a*o)),t[12]=-(s*(_*y-l*m)-c*(o*y-u*m)+d*(o*l-u*_)),t[13]=e*(_*y-l*m)-c*(i*y-n*m)+d*(i*l-n*_),t[14]=-(e*(o*y-u*m)-s*(i*y-n*m)+d*(i*u-n*o)),t[15]=e*(o*l-u*_)-s*(i*l-n*_)+c*(i*u-n*o),t},l.determinant=function(t){var r=t[0],e=t[1],i=t[2],n=t[3],a=t[4],s=t[5],o=t[6],u=t[7],h=t[8],c=t[9],_=t[10],l=t[11],f=t[12],d=t[13],m=t[14],y=t[15];return(r*s-e*a)*(_*y-l*m)-(r*o-i*a)*(c*y-l*d)+(r*u-n*a)*(c*m-_*d)+(e*o-i*s)*(h*y-l*f)-(e*u-n*s)*(h*m-_*f)+(i*u-n*o)*(h*d-c*f)},l.multiply=function(t,r,e){var i=r[0],n=r[1],a=r[2],s=r[3],o=r[4],u=r[5],h=r[6],c=r[7],_=r[8],l=r[9],f=r[10],d=r[11],m=r[12],y=r[13],p=r[14],v=r[15],E=e[0],T=e[1],g=e[2],A=e[3];return t[0]=E*i+T*o+g*_+A*m,t[1]=E*n+T*u+g*l+A*y,t[2]=E*a+T*h+g*f+A*p,t[3]=E*s+T*c+g*d+A*v,E=e[4],T=e[5],g=e[6],A=e[7],t[4]=E*i+T*o+g*_+A*m,t[5]=E*n+T*u+g*l+A*y,t[6]=E*a+T*h+g*f+A*p,t[7]=E*s+T*c+g*d+A*v,E=e[8],T=e[9],g=e[10],A=e[11],t[8]=E*i+T*o+g*_+A*m,t[9]=E*n+T*u+g*l+A*y,t[10]=E*a+T*h+g*f+A*p,t[11]=E*s+T*c+g*d+A*v,E=e[12],T=e[13],g=e[14],A=e[15],t[12]=E*i+T*o+g*_+A*m,t[13]=E*n+T*u+g*l+A*y,t[14]=E*a+T*h+g*f+A*p,t[15]=E*s+T*c+g*d+A*v,t},l.multiplyAffine=function(t,r,e){var i=r[0],n=r[1],a=r[2],s=r[4],o=r[5],u=r[6],h=r[8],c=r[9],_=r[10],l=r[12],f=r[13],d=r[14],m=e[0],y=e[1],p=e[2];return t[0]=m*i+y*s+p*h,t[1]=m*n+y*o+p*c,t[2]=m*a+y*u+p*_,m=e[4],y=e[5],p=e[6],t[4]=m*i+y*s+p*h,t[5]=m*n+y*o+p*c,t[6]=m*a+y*u+p*_,m=e[8],y=e[9],p=e[10],t[8]=m*i+y*s+p*h,t[9]=m*n+y*o+p*c,t[10]=m*a+y*u+p*_,m=e[12],y=e[13],p=e[14],t[12]=m*i+y*s+p*h+l,t[13]=m*n+y*o+p*c+f,t[14]=m*a+y*u+p*_+d,t},l.mul=l.multiply,l.mulAffine=l.multiplyAffine,l.translate=function(t,r,e){var i,n,a,s,o,u,h,c,_,l,f,d,m=e[0],y=e[1],p=e[2];return r===t?(t[12]=r[0]*m+r[4]*y+r[8]*p+r[12],t[13]=r[1]*m+r[5]*y+r[9]*p+r[13],t[14]=r[2]*m+r[6]*y+r[10]*p+r[14],t[15]=r[3]*m+r[7]*y+r[11]*p+r[15]):(i=r[0],n=r[1],a=r[2],s=r[3],o=r[4],u=r[5],h=r[6],c=r[7],_=r[8],l=r[9],f=r[10],d=r[11],t[0]=i,t[1]=n,t[2]=a,t[3]=s,t[4]=o,t[5]=u,t[6]=h,t[7]=c,t[8]=_,t[9]=l,t[10]=f,t[11]=d,t[12]=i*m+o*y+_*p+r[12],t[13]=n*m+u*y+l*p+r[13],t[14]=a*m+h*y+f*p+r[14],t[15]=s*m+c*y+d*p+r[15]),t},l.scale=function(t,r,e){var i=e[0],n=e[1],a=e[2];return t[0]=r[0]*i,t[1]=r[1]*i,t[2]=r[2]*i,t[3]=r[3]*i,t[4]=r[4]*n,t[5]=r[5]*n,t[6]=r[6]*n,t[7]=r[7]*n,t[8]=r[8]*a,t[9]=r[9]*a,t[10]=r[10]*a,t[11]=r[11]*a,t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15],t},l.rotate=function(t,e,i,n){var a,s,o,u,h,c,_,l,f,d,m,y,p,v,E,T,g,A,R,S,I,N,x,M,O=n[0],b=n[1],P=n[2],w=Math.sqrt(O*O+b*b+P*P);return Math.abs(w)<r?null:(w=1/w,O*=w,b*=w,P*=w,a=Math.sin(i),s=Math.cos(i),o=1-s,u=e[0],h=e[1],c=e[2],_=e[3],l=e[4],f=e[5],d=e[6],m=e[7],y=e[8],p=e[9],v=e[10],E=e[11],T=O*O*o+s,g=b*O*o+P*a,A=P*O*o-b*a,R=O*b*o-P*a,S=b*b*o+s,I=P*b*o+O*a,N=O*P*o+b*a,x=b*P*o-O*a,M=P*P*o+s,t[0]=u*T+l*g+y*A,t[1]=h*T+f*g+p*A,t[2]=c*T+d*g+v*A,t[3]=_*T+m*g+E*A,t[4]=u*R+l*S+y*I,t[5]=h*R+f*S+p*I,t[6]=c*R+d*S+v*I,t[7]=_*R+m*S+E*I,t[8]=u*N+l*x+y*M,t[9]=h*N+f*x+p*M,t[10]=c*N+d*x+v*M,t[11]=_*N+m*x+E*M,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)},l.rotateX=function(t,r,e){var i=Math.sin(e),n=Math.cos(e),a=r[4],s=r[5],o=r[6],u=r[7],h=r[8],c=r[9],_=r[10],l=r[11];return r!==t&&(t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15]),t[4]=a*n+h*i,t[5]=s*n+c*i,t[6]=o*n+_*i,t[7]=u*n+l*i,t[8]=h*n-a*i,t[9]=c*n-s*i,t[10]=_*n-o*i,t[11]=l*n-u*i,t},l.rotateY=function(t,r,e){var i=Math.sin(e),n=Math.cos(e),a=r[0],s=r[1],o=r[2],u=r[3],h=r[8],c=r[9],_=r[10],l=r[11];return r!==t&&(t[4]=r[4],t[5]=r[5],t[6]=r[6],t[7]=r[7],t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15]),t[0]=a*n-h*i,t[1]=s*n-c*i,t[2]=o*n-_*i,t[3]=u*n-l*i,t[8]=a*i+h*n,t[9]=s*i+c*n,t[10]=o*i+_*n,t[11]=u*i+l*n,t},l.rotateZ=function(t,r,e){var i=Math.sin(e),n=Math.cos(e),a=r[0],s=r[1],o=r[2],u=r[3],h=r[4],c=r[5],_=r[6],l=r[7];return r!==t&&(t[8]=r[8],t[9]=r[9],t[10]=r[10],t[11]=r[11],t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15]),t[0]=a*n+h*i,t[1]=s*n+c*i,t[2]=o*n+_*i,t[3]=u*n+l*i,t[4]=h*n-a*i,t[5]=c*n-s*i,t[6]=_*n-o*i,t[7]=l*n-u*i,t},l.fromRotationTranslation=function(t,r,e){var i=r[0],n=r[1],a=r[2],s=r[3],o=i+i,u=n+n,h=a+a,c=i*o,_=i*u,l=i*h,f=n*u,d=n*h,m=a*h,y=s*o,p=s*u,v=s*h;return t[0]=1-(f+m),t[1]=_+v,t[2]=l-p,t[3]=0,t[4]=_-v,t[5]=1-(c+m),t[6]=d+y,t[7]=0,t[8]=l+p,t[9]=d-y,t[10]=1-(c+f),t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t},l.fromQuat=function(t,r){var e=r[0],i=r[1],n=r[2],a=r[3],s=e+e,o=i+i,u=n+n,h=e*s,c=i*s,_=i*o,l=n*s,f=n*o,d=n*u,m=a*s,y=a*o,p=a*u;return t[0]=1-_-d,t[1]=c+p,t[2]=l-y,t[3]=0,t[4]=c-p,t[5]=1-h-d,t[6]=f+m,t[7]=0,t[8]=l+y,t[9]=f-m,t[10]=1-h-_,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},l.frustum=function(t,r,e,i,n,a,s){var o=1/(e-r),u=1/(n-i),h=1/(a-s);return t[0]=2*a*o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*a*u,t[6]=0,t[7]=0,t[8]=(e+r)*o,t[9]=(n+i)*u,t[10]=(s+a)*h,t[11]=-1,t[12]=0,t[13]=0,t[14]=s*a*2*h,t[15]=0,t},l.perspective=function(t,r,e,i,n){var a=1/Math.tan(r/2),s=1/(i-n);return t[0]=a/e,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(n+i)*s,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*n*i*s,t[15]=0,t},l.ortho=function(t,r,e,i,n,a,s){var o=1/(r-e),u=1/(i-n),h=1/(a-s);return t[0]=-2*o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*u,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*h,t[11]=0,t[12]=(r+e)*o,t[13]=(n+i)*u,t[14]=(s+a)*h,t[15]=1,t},l.lookAt=function(t,e,i,n){var a,s,o,u,h,c,_,f,d,m,y=e[0],p=e[1],v=e[2],E=n[0],T=n[1],g=n[2],A=i[0],R=i[1],S=i[2];return Math.abs(y-A)<r&&Math.abs(p-R)<r&&Math.abs(v-S)<r?l.identity(t):(_=y-A,f=p-R,d=v-S,m=1/Math.sqrt(_*_+f*f+d*d),_*=m,f*=m,d*=m,a=T*d-g*f,s=g*_-E*d,o=E*f-T*_,(m=Math.sqrt(a*a+s*s+o*o))?(a*=m=1/m,s*=m,o*=m):(a=0,s=0,o=0),u=f*o-d*s,h=d*a-_*o,c=_*s-f*a,(m=Math.sqrt(u*u+h*h+c*c))?(u*=m=1/m,h*=m,c*=m):(u=0,h=0,c=0),t[0]=a,t[1]=u,t[2]=_,t[3]=0,t[4]=s,t[5]=h,t[6]=f,t[7]=0,t[8]=o,t[9]=c,t[10]=d,t[11]=0,t[12]=-(a*y+s*p+o*v),t[13]=-(u*y+h*p+c*v),t[14]=-(_*y+f*p+d*v),t[15]=1,t)},l.str=function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},l.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2)+Math.pow(t[9],2)+Math.pow(t[10],2)+Math.pow(t[11],2)+Math.pow(t[12],2)+Math.pow(t[13],2)+Math.pow(t[14],2)+Math.pow(t[15],2))},void 0!==t&&(t.mat4=l);var f={};f.create=function(){var t=new e(4);return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},f.rotationTo=function(){var t=o.create(),r=o.fromValues(1,0,0),e=o.fromValues(0,1,0);return function(i,n,a){var s=o.dot(n,a);return s<-.999999?(o.cross(t,r,n),o.length(t)<1e-6&&o.cross(t,e,n),o.normalize(t,t),f.setAxisAngle(i,t,Math.PI),i):s>.999999?(i[0]=0,i[1]=0,i[2]=0,i[3]=1,i):(o.cross(t,n,a),i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=1+s,f.normalize(i,i))}}(),f.setAxes=function(){var t=_.create();return function(r,e,i,n){return t[0]=i[0],t[3]=i[1],t[6]=i[2],t[1]=n[0],t[4]=n[1],t[7]=n[2],t[2]=-e[0],t[5]=-e[1],t[8]=-e[2],f.normalize(r,f.fromMat3(r,t))}}(),f.clone=u.clone,f.fromValues=u.fromValues,f.copy=u.copy,f.set=u.set,f.identity=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},f.setAxisAngle=function(t,r,e){e*=.5;var i=Math.sin(e);return t[0]=i*r[0],t[1]=i*r[1],t[2]=i*r[2],t[3]=Math.cos(e),t},f.add=u.add,f.multiply=function(t,r,e){var i=r[0],n=r[1],a=r[2],s=r[3],o=e[0],u=e[1],h=e[2],c=e[3];return t[0]=i*c+s*o+n*h-a*u,t[1]=n*c+s*u+a*o-i*h,t[2]=a*c+s*h+i*u-n*o,t[3]=s*c-i*o-n*u-a*h,t},f.mul=f.multiply,f.scale=u.scale,f.rotateX=function(t,r,e){e*=.5;var i=r[0],n=r[1],a=r[2],s=r[3],o=Math.sin(e),u=Math.cos(e);return t[0]=i*u+s*o,t[1]=n*u+a*o,t[2]=a*u-n*o,t[3]=s*u-i*o,t},f.rotateY=function(t,r,e){e*=.5;var i=r[0],n=r[1],a=r[2],s=r[3],o=Math.sin(e),u=Math.cos(e);return t[0]=i*u-a*o,t[1]=n*u+s*o,t[2]=a*u+i*o,t[3]=s*u-n*o,t},f.rotateZ=function(t,r,e){e*=.5;var i=r[0],n=r[1],a=r[2],s=r[3],o=Math.sin(e),u=Math.cos(e);return t[0]=i*u+n*o,t[1]=n*u-i*o,t[2]=a*u+s*o,t[3]=s*u-a*o,t},f.calculateW=function(t,r){var e=r[0],i=r[1],n=r[2];return t[0]=e,t[1]=i,t[2]=n,t[3]=Math.sqrt(Math.abs(1-e*e-i*i-n*n)),t},f.dot=u.dot,f.lerp=u.lerp,f.slerp=function(t,r,e,i){var n,a,s,o,u,h=r[0],c=r[1],_=r[2],l=r[3],f=e[0],d=e[1],m=e[2],y=e[3];return(a=h*f+c*d+_*m+l*y)<0&&(a=-a,f=-f,d=-d,m=-m,y=-y),1-a>1e-6?(n=Math.acos(a),s=Math.sin(n),o=Math.sin((1-i)*n)/s,u=Math.sin(i*n)/s):(o=1-i,u=i),t[0]=o*h+u*f,t[1]=o*c+u*d,t[2]=o*_+u*m,t[3]=o*l+u*y,t},f.invert=function(t,r){var e=r[0],i=r[1],n=r[2],a=r[3],s=e*e+i*i+n*n+a*a,o=s?1/s:0;return t[0]=-e*o,t[1]=-i*o,t[2]=-n*o,t[3]=a*o,t},f.conjugate=function(t,r){return t[0]=-r[0],t[1]=-r[1],t[2]=-r[2],t[3]=r[3],t},f.length=u.length,f.len=f.length,f.squaredLength=u.squaredLength,f.sqrLen=f.squaredLength,f.normalize=u.normalize,f.fromMat3=function(t,r){var e,i=r[0]+r[4]+r[8];if(i>0)e=Math.sqrt(i+1),t[3]=.5*e,e=.5/e,t[0]=(r[5]-r[7])*e,t[1]=(r[6]-r[2])*e,t[2]=(r[1]-r[3])*e;else{var n=0;r[4]>r[0]&&(n=1),r[8]>r[3*n+n]&&(n=2);var a=(n+1)%3,s=(n+2)%3;e=Math.sqrt(r[3*n+n]-r[3*a+a]-r[3*s+s]+1),t[n]=.5*e,e=.5/e,t[3]=(r[3*a+s]-r[3*s+a])*e,t[a]=(r[3*a+n]+r[3*n+a])*e,t[s]=(r[3*s+n]+r[3*n+s])*e}return t},f.str=function(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},void 0!==t&&(t.quat=f)}(e.exports)}()}),U=D.vec3,B=function(t,r,e){t=t||0,r=r||0,e=e||0,this._array=U.fromValues(t,r,e),this._dirty=!0};B.prototype={constructor:B,add:function(t){return U.add(this._array,this._array,t._array),this._dirty=!0,this},set:function(t,r,e){return this._array[0]=t,this._array[1]=r,this._array[2]=e,this._dirty=!0,this},setArray:function(t){return this._array[0]=t[0],this._array[1]=t[1],this._array[2]=t[2],this._dirty=!0,this},clone:function(){return new B(this.x,this.y,this.z)},copy:function(t){return U.copy(this._array,t._array),this._dirty=!0,this},cross:function(t,r){return U.cross(this._array,t._array,r._array),this._dirty=!0,this},dist:function(t){return U.dist(this._array,t._array)},distance:function(t){return U.distance(this._array,t._array)},div:function(t){return U.div(this._array,this._array,t._array),this._dirty=!0,this},divide:function(t){return U.divide(this._array,this._array,t._array),this._dirty=!0,this},dot:function(t){return U.dot(this._array,t._array)},len:function(){return U.len(this._array)},length:function(){return U.length(this._array)},lerp:function(t,r,e){return U.lerp(this._array,t._array,r._array,e),this._dirty=!0,this},min:function(t){return U.min(this._array,this._array,t._array),this._dirty=!0,this},max:function(t){return U.max(this._array,this._array,t._array),this._dirty=!0,this},mul:function(t){return U.mul(this._array,this._array,t._array),this._dirty=!0,this},multiply:function(t){return U.multiply(this._array,this._array,t._array),this._dirty=!0,this},negate:function(){return U.negate(this._array,this._array),this._dirty=!0,this},normalize:function(){return U.normalize(this._array,this._array),this._dirty=!0,this},random:function(t){return U.random(this._array,t),this._dirty=!0,this},scale:function(t){return U.scale(this._array,this._array,t),this._dirty=!0,this},scaleAndAdd:function(t,r){return U.scaleAndAdd(this._array,this._array,t._array,r),this._dirty=!0,this},sqrDist:function(t){return U.sqrDist(this._array,t._array)},squaredDistance:function(t){return U.squaredDistance(this._array,t._array)},sqrLen:function(){return U.sqrLen(this._array)},squaredLength:function(){return U.squaredLength(this._array)},sub:function(t){return U.sub(this._array,this._array,t._array),this._dirty=!0,this},subtract:function(t){return U.subtract(this._array,this._array,t._array),this._dirty=!0,this},transformMat3:function(t){return U.transformMat3(this._array,this._array,t._array),this._dirty=!0,this},transformMat4:function(t){return U.transformMat4(this._array,this._array,t._array),this._dirty=!0,this},transformQuat:function(t){return U.transformQuat(this._array,this._array,t._array),this._dirty=!0,this},applyProjection:function(t){var r=this._array;if(0===(t=t._array)[15]){var e=-1/r[2];r[0]=t[0]*r[0]*e,r[1]=t[5]*r[1]*e,r[2]=(t[10]*r[2]+t[14])*e}else r[0]=t[0]*r[0]+t[12],r[1]=t[5]*r[1]+t[13],r[2]=t[10]*r[2]+t[14];return this._dirty=!0,this},eulerFromQuat:function(t,r){B.eulerFromQuat(this,t,r)},eulerFromMat3:function(t,r){B.eulerFromMat3(this,t,r)},toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"},toArray:function(){return Array.prototype.slice.call(this._array)}};var F=Object.defineProperty;if(F){var V=B.prototype;F(V,"x",{get:function(){return this._array[0]},set:function(t){this._array[0]=t,this._dirty=!0}}),F(V,"y",{get:function(){return this._array[1]},set:function(t){this._array[1]=t,this._dirty=!0}}),F(V,"z",{get:function(){return this._array[2]},set:function(t){this._array[2]=t,this._dirty=!0}})}B.add=function(t,r,e){return U.add(t._array,r._array,e._array),t._dirty=!0,t},B.set=function(t,r,e,i){U.set(t._array,r,e,i),t._dirty=!0},B.copy=function(t,r){return U.copy(t._array,r._array),t._dirty=!0,t},B.cross=function(t,r,e){return U.cross(t._array,r._array,e._array),t._dirty=!0,t},B.dist=function(t,r){return U.distance(t._array,r._array)},B.distance=B.dist,B.div=function(t,r,e){return U.divide(t._array,r._array,e._array),t._dirty=!0,t},B.divide=B.div,B.dot=function(t,r){return U.dot(t._array,r._array)},B.len=function(t){return U.length(t._array)},B.lerp=function(t,r,e,i){return U.lerp(t._array,r._array,e._array,i),t._dirty=!0,t},B.min=function(t,r,e){return U.min(t._array,r._array,e._array),t._dirty=!0,t},B.max=function(t,r,e){return U.max(t._array,r._array,e._array),t._dirty=!0,t},B.mul=function(t,r,e){return U.multiply(t._array,r._array,e._array),t._dirty=!0,t},B.multiply=B.mul,B.negate=function(t,r){return U.negate(t._array,r._array),t._dirty=!0,t},B.normalize=function(t,r){return U.normalize(t._array,r._array),t._dirty=!0,t},B.random=function(t,r){return U.random(t._array,r),t._dirty=!0,t},B.scale=function(t,r,e){return U.scale(t._array,r._array,e),t._dirty=!0,t},B.scaleAndAdd=function(t,r,e,i){return U.scaleAndAdd(t._array,r._array,e._array,i),t._dirty=!0,t},B.sqrDist=function(t,r){return U.sqrDist(t._array,r._array)},B.squaredDistance=B.sqrDist,B.sqrLen=function(t){return U.sqrLen(t._array)},B.squaredLength=B.sqrLen,B.sub=function(t,r,e){return U.subtract(t._array,r._array,e._array),t._dirty=!0,t},B.subtract=B.sub,B.transformMat3=function(t,r,e){return U.transformMat3(t._array,r._array,e._array),t._dirty=!0,t},B.transformMat4=function(t,r,e){return U.transformMat4(t._array,r._array,e._array),t._dirty=!0,t},B.transformQuat=function(t,r,e){return U.transformQuat(t._array,r._array,e._array),t._dirty=!0,t};var W=Math.atan2,X=Math.asin,G=Math.abs;B.eulerFromQuat=function(t,r,e){t._dirty=!0,r=r._array;var i=t._array,n=r[0],s=r[1],o=r[2],u=r[3],h=n*n,c=s*s,_=o*o,l=u*u;switch(e=(e||"XYZ").toUpperCase()){case"XYZ":i[0]=W(2*(n*u-s*o),l-h-c+_),i[1]=X(a(2*(n*o+s*u),-1,1)),i[2]=W(2*(o*u-n*s),l+h-c-_);break;case"YXZ":i[0]=X(a(2*(n*u-s*o),-1,1)),i[1]=W(2*(n*o+s*u),l-h-c+_),i[2]=W(2*(n*s+o*u),l-h+c-_);break;case"ZXY":i[0]=X(a(2*(n*u+s*o),-1,1)),i[1]=W(2*(s*u-o*n),l-h-c+_),i[2]=W(2*(o*u-n*s),l-h+c-_);break;case"ZYX":i[0]=W(2*(n*u+o*s),l-h-c+_),i[1]=X(a(2*(s*u-n*o),-1,1)),i[2]=W(2*(n*s+o*u),l+h-c-_);break;case"YZX":i[0]=W(2*(n*u-o*s),l-h+c-_),i[1]=W(2*(s*u-n*o),l+h-c-_),i[2]=X(a(2*(n*s+o*u),-1,1));break;case"XZY":i[0]=W(2*(n*u+s*o),l-h+c-_),i[1]=W(2*(n*o+s*u),l+h-c-_),i[2]=X(a(2*(o*u-n*s),-1,1));break;default:console.warn("Unkown order: "+e)}return t},B.eulerFromMat3=function(t,r,e){var i=r._array,n=i[0],s=i[3],o=i[6],u=i[1],h=i[4],c=i[7],_=i[2],l=i[5],f=i[8],d=t._array;switch(e=(e||"XYZ").toUpperCase()){case"XYZ":d[1]=X(a(o,-1,1)),G(o)<.99999?(d[0]=W(-c,f),d[2]=W(-s,n)):(d[0]=W(l,h),d[2]=0);break;case"YXZ":d[0]=X(-a(c,-1,1)),G(c)<.99999?(d[1]=W(o,f),d[2]=W(u,h)):(d[1]=W(-_,n),d[2]=0);break;case"ZXY":d[0]=X(a(l,-1,1)),G(l)<.99999?(d[1]=W(-_,f),d[2]=W(-s,h)):(d[1]=0,d[2]=W(u,n));break;case"ZYX":d[1]=X(-a(_,-1,1)),G(_)<.99999?(d[0]=W(l,f),d[2]=W(u,n)):(d[0]=0,d[2]=W(-s,h));break;case"YZX":d[2]=X(a(u,-1,1)),G(u)<.99999?(d[0]=W(-c,h),d[1]=W(-_,n)):(d[0]=0,d[1]=W(o,f));break;case"XZY":d[2]=X(-a(s,-1,1)),G(s)<.99999?(d[0]=W(l,h),d[1]=W(o,n)):(d[0]=W(-c,f),d[1]=0);break;default:console.warn("Unkown order: "+e)}return t._dirty=!0,t},B.POSITIVE_X=new B(1,0,0),B.NEGATIVE_X=new B(-1,0,0),B.POSITIVE_Y=new B(0,1,0),B.NEGATIVE_Y=new B(0,-1,0),B.POSITIVE_Z=new B(0,0,1),B.NEGATIVE_Z=new B(0,0,-1),B.UP=new B(0,1,0),B.ZERO=new B(0,0,0);var k=D.vec3,H=k.copy,q=k.set,z=function(t,r){this.min=t||new B(1/0,1/0,1/0),this.max=r||new B(-1/0,-1/0,-1/0)};z.prototype={constructor:z,updateFromVertices:function(t){if(t.length>0){var r=this.min,e=this.max,i=r._array,n=e._array;H(i,t[0]),H(n,t[0]);for(var a=1;a<t.length;a++){var s=t[a];s[0]<i[0]&&(i[0]=s[0]),s[1]<i[1]&&(i[1]=s[1]),s[2]<i[2]&&(i[2]=s[2]),s[0]>n[0]&&(n[0]=s[0]),s[1]>n[1]&&(n[1]=s[1]),s[2]>n[2]&&(n[2]=s[2])}r._dirty=!0,e._dirty=!0}},union:function(t){var r=this.min,e=this.max;return k.min(r._array,r._array,t.min._array),k.max(e._array,e._array,t.max._array),r._dirty=!0,e._dirty=!0,this},intersection:function(t){var r=this.min,e=this.max;return k.max(r._array,r._array,t.min._array),k.min(e._array,e._array,t.max._array),r._dirty=!0,e._dirty=!0,this},intersectBoundingBox:function(t){var r=this.min._array,e=this.max._array,i=t.min._array,n=t.max._array;return!(r[0]>n[0]||r[1]>n[1]||r[2]>n[2]||e[0]<i[0]||e[1]<i[1]||e[2]<i[2])},containBoundingBox:function(t){var r=this.min._array,e=this.max._array,i=t.min._array,n=t.max._array;return r[0]<=i[0]&&r[1]<=i[1]&&r[2]<=i[2]&&e[0]>=n[0]&&e[1]>=n[1]&&e[2]>=n[2]},containPoint:function(t){var r=this.min._array,e=this.max._array,i=t._array;return r[0]<=i[0]&&r[1]<=i[1]&&r[2]<=i[2]&&e[0]>=i[0]&&e[1]>=i[1]&&e[2]>=i[2]},isFinite:function(){var t=this.min._array,r=this.max._array;return isFinite(t[0])&&isFinite(t[1])&&isFinite(t[2])&&isFinite(r[0])&&isFinite(r[1])&&isFinite(r[2])},applyTransform:function(){var t=k.create(),r=k.create(),e=k.create(),i=k.create(),n=k.create(),a=k.create();return function(s){var o=this.min._array,u=this.max._array,h=s._array;return t[0]=h[0]*o[0],t[1]=h[1]*o[0],t[2]=h[2]*o[0],r[0]=h[0]*u[0],r[1]=h[1]*u[0],r[2]=h[2]*u[0],e[0]=h[4]*o[1],e[1]=h[5]*o[1],e[2]=h[6]*o[1],i[0]=h[4]*u[1],i[1]=h[5]*u[1],i[2]=h[6]*u[1],n[0]=h[8]*o[2],n[1]=h[9]*o[2],n[2]=h[10]*o[2],a[0]=h[8]*u[2],a[1]=h[9]*u[2],a[2]=h[10]*u[2],o[0]=Math.min(t[0],r[0])+Math.min(e[0],i[0])+Math.min(n[0],a[0])+h[12],o[1]=Math.min(t[1],r[1])+Math.min(e[1],i[1])+Math.min(n[1],a[1])+h[13],o[2]=Math.min(t[2],r[2])+Math.min(e[2],i[2])+Math.min(n[2],a[2])+h[14],u[0]=Math.max(t[0],r[0])+Math.max(e[0],i[0])+Math.max(n[0],a[0])+h[12],u[1]=Math.max(t[1],r[1])+Math.max(e[1],i[1])+Math.max(n[1],a[1])+h[13],u[2]=Math.max(t[2],r[2])+Math.max(e[2],i[2])+Math.max(n[2],a[2])+h[14],this.min._dirty=!0,this.max._dirty=!0,this}}(),applyProjection:function(t){var r=this.min._array,e=this.max._array,i=t._array,n=r[0],a=r[1],s=r[2],o=e[0],u=e[1],h=r[2],c=e[0],_=e[1],l=e[2];if(1===i[15])r[0]=i[0]*n+i[12],r[1]=i[5]*a+i[13],e[2]=i[10]*s+i[14],e[0]=i[0]*c+i[12],e[1]=i[5]*_+i[13],r[2]=i[10]*l+i[14];else{var f=-1/s;r[0]=i[0]*n*f,r[1]=i[5]*a*f,e[2]=(i[10]*s+i[14])*f,f=-1/h,e[0]=i[0]*o*f,e[1]=i[5]*u*f,f=-1/l,r[2]=(i[10]*l+i[14])*f}return this.min._dirty=!0,this.max._dirty=!0,this},updateVertices:function(){if(!(t=this.vertices)){for(var t=[],r=0;r<8;r++)t[r]=k.fromValues(0,0,0);this.vertices=t}var e=this.min._array,i=this.max._array;return q(t[0],e[0],e[1],e[2]),q(t[1],e[0],i[1],e[2]),q(t[2],i[0],e[1],e[2]),q(t[3],i[0],i[1],e[2]),q(t[4],e[0],e[1],i[2]),q(t[5],e[0],i[1],i[2]),q(t[6],i[0],e[1],i[2]),q(t[7],i[0],i[1],i[2]),this},copy:function(t){var r=this.min,e=this.max;return H(r._array,t.min._array),H(e._array,t.max._array),r._dirty=!0,e._dirty=!0,this},clone:function(){var t=new z;return t.copy(this),t}};var j=D.mat4,Y=D.vec3,Z=D.mat3,J=D.quat,K=function(){this._axisX=new B,this._axisY=new B,this._axisZ=new B,this._array=j.create(),this._dirty=!0};K.prototype={constructor:K,setArray:function(t){for(var r=0;r<this._array.length;r++)this._array[r]=t[r];return this._dirty=!0,this},adjoint:function(){return j.adjoint(this._array,this._array),this._dirty=!0,this},clone:function(){return(new K).copy(this)},copy:function(t){return j.copy(this._array,t._array),this._dirty=!0,this},determinant:function(){return j.determinant(this._array)},fromQuat:function(t){return j.fromQuat(this._array,t._array),this._dirty=!0,this},fromRotationTranslation:function(t,r){return j.fromRotationTranslation(this._array,t._array,r._array),this._dirty=!0,this},fromMat2d:function(t){return K.fromMat2d(this,t),this},frustum:function(t,r,e,i,n,a){return j.frustum(this._array,t,r,e,i,n,a),this._dirty=!0,this},identity:function(){return j.identity(this._array),this._dirty=!0,this},invert:function(){return j.invert(this._array,this._array),this._dirty=!0,this},lookAt:function(t,r,e){return j.lookAt(this._array,t._array,r._array,e._array),this._dirty=!0,this},mul:function(t){return j.mul(this._array,this._array,t._array),this._dirty=!0,this},mulLeft:function(t){return j.mul(this._array,t._array,this._array),this._dirty=!0,this},multiply:function(t){return j.multiply(this._array,this._array,t._array),this._dirty=!0,this},multiplyLeft:function(t){return j.multiply(this._array,t._array,this._array),this._dirty=!0,this},ortho:function(t,r,e,i,n,a){return j.ortho(this._array,t,r,e,i,n,a),this._dirty=!0,this},perspective:function(t,r,e,i){return j.perspective(this._array,t,r,e,i),this._dirty=!0,this},rotate:function(t,r){return j.rotate(this._array,this._array,t,r._array),this._dirty=!0,this},rotateX:function(t){return j.rotateX(this._array,this._array,t),this._dirty=!0,this},rotateY:function(t){return j.rotateY(this._array,this._array,t),this._dirty=!0,this},rotateZ:function(t){return j.rotateZ(this._array,this._array,t),this._dirty=!0,this},scale:function(t){return j.scale(this._array,this._array,t._array),this._dirty=!0,this},translate:function(t){return j.translate(this._array,this._array,t._array),this._dirty=!0,this},transpose:function(){return j.transpose(this._array,this._array),this._dirty=!0,this},decomposeMatrix:function(){var t=Y.create(),r=Y.create(),e=Y.create(),i=Z.create();return function(n,a,s){var o=this._array;Y.set(t,o[0],o[1],o[2]),Y.set(r,o[4],o[5],o[6]),Y.set(e,o[8],o[9],o[10]);var u=Y.length(t),h=Y.length(r),c=Y.length(e);this.determinant()<0&&(u=-u),n&&n.set(u,h,c),s.set(o[12],o[13],o[14]),Z.fromMat4(i,o),i[0]/=u,i[1]/=u,i[2]/=u,i[3]/=h,i[4]/=h,i[5]/=h,i[6]/=c,i[7]/=c,i[8]/=c,J.fromMat3(a._array,i),J.normalize(a._array,a._array),a._dirty=!0,s._dirty=!0}}(),toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"},toArray:function(){return Array.prototype.slice.call(this._array)}};var Q=Object.defineProperty;if(Q){var $=K.prototype;Q($,"z",{get:function(){var t=this._array;return this._axisZ.set(t[8],t[9],t[10]),this._axisZ},set:function(t){var r=this._array;t=t._array,r[8]=t[0],r[9]=t[1],r[10]=t[2],this._dirty=!0}}),Q($,"y",{get:function(){var t=this._array;return this._axisY.set(t[4],t[5],t[6]),this._axisY},set:function(t){var r=this._array;t=t._array,r[4]=t[0],r[5]=t[1],r[6]=t[2],this._dirty=!0}}),Q($,"x",{get:function(){var t=this._array;return this._axisX.set(t[0],t[1],t[2]),this._axisX},set:function(t){var r=this._array;t=t._array,r[0]=t[0],r[1]=t[1],r[2]=t[2],this._dirty=!0}})}K.adjoint=function(t,r){return j.adjoint(t._array,r._array),t._dirty=!0,t},K.copy=function(t,r){return j.copy(t._array,r._array),t._dirty=!0,t},K.determinant=function(t){return j.determinant(t._array)},K.identity=function(t){return j.identity(t._array),t._dirty=!0,t},K.ortho=function(t,r,e,i,n,a,s){return j.ortho(t._array,r,e,i,n,a,s),t._dirty=!0,t},K.perspective=function(t,r,e,i,n){return j.perspective(t._array,r,e,i,n),t._dirty=!0,t},K.lookAt=function(t,r,e,i){return j.lookAt(t._array,r._array,e._array,i._array),t._dirty=!0,t},K.invert=function(t,r){return j.invert(t._array,r._array),t._dirty=!0,t},K.mul=function(t,r,e){return j.mul(t._array,r._array,e._array),t._dirty=!0,t},K.multiply=K.mul,K.fromQuat=function(t,r){return j.fromQuat(t._array,r._array),t._dirty=!0,t},K.fromRotationTranslation=function(t,r,e){return j.fromRotationTranslation(t._array,r._array,e._array),t._dirty=!0,t},K.fromMat2d=function(t,r){t._dirty=!0;var r=r._array;return(t=t._array)[0]=r[0],t[4]=r[2],t[12]=r[4],t[1]=r[1],t[5]=r[3],t[13]=r[5],t},K.rotate=function(t,r,e,i){return j.rotate(t._array,r._array,e,i._array),t._dirty=!0,t},K.rotateX=function(t,r,e){return j.rotateX(t._array,r._array,e),t._dirty=!0,t},K.rotateY=function(t,r,e){return j.rotateY(t._array,r._array,e),t._dirty=!0,t},K.rotateZ=function(t,r,e){return j.rotateZ(t._array,r._array,e),t._dirty=!0,t},K.scale=function(t,r,e){return j.scale(t._array,r._array,e._array),t._dirty=!0,t},K.transpose=function(t,r){return j.transpose(t._array,r._array),t._dirty=!0,t},K.translate=function(t,r,e){return j.translate(t._array,r._array,e._array),t._dirty=!0,t};var tt=function(){this._contextId=0,this._caches=[],this._context={}};(tt.prototype={use:function(t,r){var e=this._caches;e[t]||(e[t]={},r&&(e[t]=r())),this._contextId=t,this._context=e[t]},put:function(t,r){this._context[t]=r},get:function(t){return this._context[t]},dirty:function(t){var r="__dt__"+(t=t||"");this.put(r,!0)},dirtyAll:function(t){for(var r="__dt__"+(t=t||""),e=this._caches,i=0;i<e.length;i++)e[i]&&(e[i][r]=!0)},fresh:function(t){var r="__dt__"+(t=t||"");this.put(r,!1)},freshAll:function(t){for(var r="__dt__"+(t=t||""),e=this._caches,i=0;i<e.length;i++)e[i]&&(e[i][r]=!1)},isDirty:function(t){var r="__dt__"+(t=t||""),e=this._context;return!e.hasOwnProperty(r)||!0===e[r]},deleteContext:function(t){delete this._caches[t],this._context={}},delete:function(t){delete this._context[t]},clearAll:function(){this._caches={}},getContext:function(){return this._context},eachContext:function(t,r){Object.keys(this._caches).forEach(function(e){t&&t.call(r,e)})},miss:function(t){return!this._context.hasOwnProperty(t)}}).constructor=tt;var rt=D.mat2,et=D.mat3,it=D.mat4,nt=/uniform\s+(bool|float|int|vec2|vec3|vec4|ivec2|ivec3|ivec4|mat2|mat3|mat4|sampler2D|samplerCube)\s+([\w\,]+)?(\[.*?\])?\s*(:\s*([\S\s]+?))?;/g,at=/attribute\s+(float|int|vec2|vec3|vec4)\s+(\w*)\s*(:\s*(\w+))?;/g,st=/#define\s+(\w+)?(\s+[\w-.]+)?\s*;?\s*\n/g,ot=/for\s*?\(int\s*?_idx_\s*\=\s*([\w-]+)\;\s*_idx_\s*<\s*([\w-]+);\s*_idx_\s*\+\+\s*\)\s*\{\{([\s\S]+?)(?=\}\})\}\}/g,ut={bool:"1i",int:"1i",sampler2D:"t",samplerCube:"t",float:"1f",vec2:"2f",vec3:"3f",vec4:"4f",ivec2:"2i",ivec3:"3i",ivec4:"4i",mat2:"m2",mat3:"m3",mat4:"m4"},ht={bool:function(){return!0},int:function(){return 0},float:function(){return 0},sampler2D:function(){return null},samplerCube:function(){return null},vec2:function(){return[0,0]},vec3:function(){return[0,0,0]},vec4:function(){return[0,0,0,0]},ivec2:function(){return[0,0]},ivec3:function(){return[0,0,0]},ivec4:function(){return[0,0,0,0]},mat2:function(){return rt.create()},mat3:function(){return et.create()},mat4:function(){return it.create()},array:function(){return[]}},ct=["POSITION","NORMAL","BINORMAL","TANGENT","TEXCOORD","TEXCOORD_0","TEXCOORD_1","COLOR","JOINT","WEIGHT"],_t=["SKIN_MATRIX","VIEWPORT_SIZE","VIEWPORT","DEVICEPIXELRATIO","WINDOW_SIZE","NEAR","FAR","TIME"],lt=["WORLD","VIEW","PROJECTION","WORLDVIEW","VIEWPROJECTION","WORLDVIEWPROJECTION","WORLDINVERSE","VIEWINVERSE","PROJECTIONINVERSE","WORLDVIEWINVERSE","VIEWPROJECTIONINVERSE","WORLDVIEWPROJECTIONINVERSE","WORLDTRANSPOSE","VIEWTRANSPOSE","PROJECTIONTRANSPOSE","WORLDVIEWTRANSPOSE","VIEWPROJECTIONTRANSPOSE","WORLDVIEWPROJECTIONTRANSPOSE","WORLDINVERSETRANSPOSE","VIEWINVERSETRANSPOSE","PROJECTIONINVERSETRANSPOSE","WORLDVIEWINVERSETRANSPOSE","VIEWPROJECTIONINVERSETRANSPOSE","WORLDVIEWPROJECTIONINVERSETRANSPOSE"],ft={},dt=M.extend(function(){return{vertex:"",fragment:"",precision:"highp",attribSemantics:{},matrixSemantics:{},uniformSemantics:{},matrixSemanticKeys:[],uniformTemplates:{},attributeTemplates:{},vertexDefines:{},fragmentDefines:{},extensions:["OES_standard_derivatives","EXT_shader_texture_lod"],lightGroup:0,lightNumber:{},_textureSlot:0,_attacheMaterialNumber:0,_uniformList:[],_textureStatus:{},_vertexProcessed:"",_fragmentProcessed:"",_currentLocationsMap:{}}},function(){this._cache=new tt,this._codeDirty=!0,this._updateShaderString()},{isEqual:function(t){return!!t&&(this===t?!this._codeDirty:(t._codeDirty&&t._updateShaderString(),this._codeDirty&&this._updateShaderString(),!(t._vertexProcessed!==this._vertexProcessed||t._fragmentProcessed!==this._fragmentProcessed)))},setVertex:function(t){this.vertex=t,this._updateShaderString(),this.dirty()},setFragment:function(t){this.fragment=t,this._updateShaderString(),this.dirty()},bind:function(t){var r=this._cache,e=t.gl;if(r.use(t.__GUID__,s),this._currentLocationsMap=r.get("locations"),this._textureSlot=0,this._codeDirty&&this._updateShaderString(),r.isDirty("program")){var i=this._buildProgram(e,this._vertexProcessed,this._fragmentProcessed);if(r.fresh("program"),i)return i}e.useProgram(r.get("program"))},dirty:function(){var t=this._cache;this._codeDirty=!0,t.dirtyAll("program");for(var r=0;r<t._caches.length;r++)if(t._caches[r]){var e=t._caches[r];e.locations={},e.attriblocations={}}},_updateShaderString:function(t){this.vertex===this._vertexPrev&&this.fragment===this._fragmentPrev||(this._parseImport(),this.attribSemantics={},this.matrixSemantics={},this._textureStatus={},this._parseUniforms(),this._parseAttributes(),this._parseDefines(),this._vertexPrev=this.vertex,this._fragmentPrev=this.fragment),this._addDefineExtensionAndPrecision(t),this._vertexProcessed=this._unrollLoop(this._vertexProcessed,this.vertexDefines),this._fragmentProcessed=this._unrollLoop(this._fragmentProcessed,this.fragmentDefines),this._codeDirty=!1},define:function(t,r,e){var i=this.vertexDefines,n=this.fragmentDefines;"vertex"!==t&&"fragment"!==t&&"both"!==t&&arguments.length<3&&(e=r,r=t,t="both"),e=null!=e?e:null,"vertex"!==t&&"both"!==t||i[r]!==e&&(i[r]=e,this.dirty()),"fragment"!==t&&"both"!==t||n[r]!==e&&(n[r]=e,"both"!==t&&this.dirty())},undefine:function(t,r){"vertex"!==t&&"fragment"!==t&&"both"!==t&&arguments.length<2&&(r=t,t="both"),"vertex"!==t&&"both"!==t||this.isDefined("vertex",r)&&(delete this.vertexDefines[r],this.dirty()),"fragment"!==t&&"both"!==t||this.isDefined("fragment",r)&&(delete this.fragmentDefines[r],"both"!==t&&this.dirty())},isDefined:function(t,r){switch(t){case"vertex":return void 0!==this.vertexDefines[r];case"fragment":return void 0!==this.fragmentDefines[r]}},getDefine:function(t,r){switch(t){case"vertex":return this.vertexDefines[r];case"fragment":return this.fragmentDefines[r]}},enableTexture:function(t){if(Array.isArray(t))for(var r=0;r<t.length;r++)this.enableTexture(t[r]);else{var e=this._textureStatus[t];e&&(e.enabled||(e.enabled=!0,this.dirty()))}},enableTexturesAll:function(){var t=this._textureStatus;for(var r in t)t[r].enabled=!0;this.dirty()},disableTexture:function(t){if(Array.isArray(t))for(var r=0;r<t.length;r++)this.disableTexture(t[r]);else{var e=this._textureStatus[t];e&&(!e.enabled||(e.enabled=!1,this.dirty()))}},disableTexturesAll:function(){var t=this._textureStatus;for(var r in t)t[r].enabled=!1;this.dirty()},isTextureEnabled:function(t){var r=this._textureStatus;return!!r[t]&&r[t].enabled},getEnabledTextures:function(){var t=[],r=this._textureStatus;for(var e in r)r[e].enabled&&t.push(e);return t},hasUniform:function(t){var r=this._currentLocationsMap[t];return null!==r&&void 0!==r},currentTextureSlot:function(){return this._textureSlot},resetTextureSlot:function(t){this._textureSlot=t||0},takeCurrentTextureSlot:function(t,r){var e=this._textureSlot;return this.useTextureSlot(t,r,e),this._textureSlot++,e},useTextureSlot:function(t,r,e){r&&(t.gl.activeTexture(t.gl.TEXTURE0+e),r.isRenderable()?r.bind(t):r.unbind(t))},setUniform:function(t,r,e,i){var n=this._currentLocationsMap[e];if(null===n||void 0===n)return!1;switch(r){case"m4":t.uniformMatrix4fv(n,!1,i);break;case"2i":t.uniform2i(n,i[0],i[1]);break;case"2f":t.uniform2f(n,i[0],i[1]);break;case"3i":t.uniform3i(n,i[0],i[1],i[2]);break;case"3f":t.uniform3f(n,i[0],i[1],i[2]);break;case"4i":t.uniform4i(n,i[0],i[1],i[2],i[3]);break;case"4f":t.uniform4f(n,i[0],i[1],i[2],i[3]);break;case"1i":t.uniform1i(n,i);break;case"1f":t.uniform1f(n,i);break;case"1fv":t.uniform1fv(n,i);break;case"1iv":t.uniform1iv(n,i);break;case"2iv":t.uniform2iv(n,i);break;case"2fv":t.uniform2fv(n,i);break;case"3iv":t.uniform3iv(n,i);break;case"3fv":t.uniform3fv(n,i);break;case"4iv":t.uniform4iv(n,i);break;case"4fv":t.uniform4fv(n,i);break;case"m2":case"m2v":t.uniformMatrix2fv(n,!1,i);break;case"m3":case"m3v":t.uniformMatrix3fv(n,!1,i);break;case"m4v":if(Array.isArray(i)){for(var a=new C.Float32Array(16*i.length),s=0,o=0;o<i.length;o++)for(var u=i[o],h=0;h<16;h++)a[s++]=u[h];t.uniformMatrix4fv(n,!1,a)}else i instanceof C.Float32Array&&t.uniformMatrix4fv(n,!1,i)}return!0},setUniformOfSemantic:function(t,r,e){var i=this.uniformSemantics[r];return!!i&&this.setUniform(t,i.type,i.symbol,e)},enableAttributes:function(t,r,e){var i,n=t.gl,a=this._cache.get("program"),s=this._cache.get("attriblocations");(i=e?e.__enabledAttributeList:ft[t.__GUID__])||(i=e?e.__enabledAttributeList=[]:ft[t.__GUID__]=[]);for(var o=[],u=0;u<r.length;u++){var h=r[u];if(this.attributeTemplates[h]){var c=s[h];if(void 0===c){if(-1===(c=n.getAttribLocation(a,h))){o[u]=-1;continue}s[h]=c}o[u]=c,i[c]?i[c]=2:i[c]=1}else o[u]=-1}for(u=0;u<i.length;u++)switch(i[u]){case 1:n.enableVertexAttribArray(u),i[u]=3;break;case 2:i[u]=3;break;case 3:n.disableVertexAttribArray(u),i[u]=0}return o},_parseImport:function(){this._vertexProcessedWithoutDefine=dt.parseImport(this.vertex),this._fragmentProcessedWithoutDefine=dt.parseImport(this.fragment)},_addDefineExtensionAndPrecision:function(t){t=t||this.extensions;for(var r=[],e=0;e<t.length;e++)r.push("#extension GL_"+t[e]+" : enable");var i=this._getDefineStr(this.vertexDefines);this._vertexProcessed=i+"\n"+this._vertexProcessedWithoutDefine;var n=(i=this._getDefineStr(this.fragmentDefines))+"\n"+this._fragmentProcessedWithoutDefine;this._fragmentProcessed=r.join("\n")+"\n"+["precision",this.precision,"float"].join(" ")+";\n"+["precision",this.precision,"int"].join(" ")+";\n"+["precision",this.precision,"sampler2D"].join(" ")+";\n"+n},_getDefineStr:function(t){var r=this.lightNumber,e=this._textureStatus,i=[];for(var n in r){var a=r[n];a>0&&i.push("#define "+n.toUpperCase()+"_COUNT "+a)}for(var s in e)e[s].enabled&&i.push("#define "+s.toUpperCase()+"_ENABLED");for(var s in t){var o=t[s];null===o?i.push("#define "+s):i.push("#define "+s+" "+o.toString())}return i.join("\n")},_unrollLoop:function(t,r){var e={};for(var i in this.lightNumber)e[i+"_COUNT"]=this.lightNumber[i];return t.replace(ot,function(t,i,n,a){var s="";isNaN(i)&&(i=i in r?r[i]:e[i]),isNaN(n)&&(n=n in r?r[n]:e[n]);for(var o=parseInt(i);o<parseInt(n);o++)s+="{"+a.replace(/float\s*\(\s*_idx_\s*\)/g,o.toFixed(1)).replace(/_idx_/g,o)+"}";return s})},_parseUniforms:function(){function t(t,n,a,s,o,u){if(n&&a){var h,c=ut[n],_=!0;if(c){if(e._uniformList.push(a),"sampler2D"!==n&&"samplerCube"!==n||(e._textureStatus[a]={enabled:!1,shaderType:i}),s&&(c+="v"),u)if(ct.indexOf(u)>=0)e.attribSemantics[u]={symbol:a,type:c},_=!1;else if(lt.indexOf(u)>=0){var l=!1,f=u;u.match(/TRANSPOSE$/)&&(l=!0,f=u.slice(0,-9)),e.matrixSemantics[u]={symbol:a,type:c,isTranspose:l,semanticNoTranspose:f},_=!1}else if(_t.indexOf(u)>=0)e.uniformSemantics[u]={symbol:a,type:c},_=!1;else if("unconfigurable"===u)_=!1;else{if(!(h=e._parseDefaultValue(n,u)))throw new Error('Unkown semantic "'+u+'"');u=""}_&&(r[a]={type:c,value:s?ht.array:h||ht[n],semantic:u||null})}return["uniform",n,a,s].join(" ")+";\n"}}var r={},e=this,i="vertex";this._uniformList=[],this._vertexProcessedWithoutDefine=this._vertexProcessedWithoutDefine.replace(nt,t),i="fragment",this._fragmentProcessedWithoutDefine=this._fragmentProcessedWithoutDefine.replace(nt,t),e.matrixSemanticKeys=Object.keys(this.matrixSemantics),this.uniformTemplates=r},_parseDefaultValue:function(t,r){var e=/\[\s*(.*)\s*\]/;{if("vec2"!==t&&"vec3"!==t&&"vec4"!==t)return"bool"===t?function(){return"true"===r.toLowerCase()}:"float"===t?function(){return parseFloat(r)}:"int"===t?function(){return parseInt(r)}:void 0;var i=e.exec(r)[1];if(i){var n=i.split(/\s*,\s*/);return function(){return new C.Float32Array(n)}}}},createUniforms:function(){var t={};for(var r in this.uniformTemplates){var e=this.uniformTemplates[r];t[r]={type:e.type,value:e.value()}}return t},attached:function(){this._attacheMaterialNumber++},detached:function(){this._attacheMaterialNumber--},isAttachedToAny:function(){return 0!==this._attacheMaterialNumber},_parseAttributes:function(){var t={},r=this;this._vertexProcessedWithoutDefine=this._vertexProcessedWithoutDefine.replace(at,function(e,i,n,a,s){if(i&&n){var o=1;switch(i){case"vec4":o=4;break;case"vec3":o=3;break;case"vec2":o=2;break;case"float":o=1}if(t[n]={type:"float",size:o,semantic:s||null},s){if(ct.indexOf(s)<0)throw new Error('Unkown semantic "'+s+'"');r.attribSemantics[s]={symbol:n,type:i}}}return["attribute",i,n].join(" ")+";\n"}),this.attributeTemplates=t},_parseDefines:function(){function t(t,i,n){var a="vertex"===e?r.vertexDefines:r.fragmentDefines;return a[i]||(a[i]="false"!=n&&("true"==n||(n?isNaN(parseFloat(n))?n:parseFloat(n):null))),""}var r=this,e="vertex";this._vertexProcessedWithoutDefine=this._vertexProcessedWithoutDefine.replace(st,t),e="fragment",this._fragmentProcessedWithoutDefine=this._fragmentProcessedWithoutDefine.replace(st,t)},_buildProgram:function(t,r,e){var i=this._cache;i.get("program")&&t.deleteProgram(i.get("program"));var n=t.createProgram(),a=t.createShader(t.VERTEX_SHADER);t.shaderSource(a,r),t.compileShader(a);var s=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(s,e),t.compileShader(s);var u=o(t,a,r);if(u)return u;if(u=o(t,s,e))return u;if(t.attachShader(n,a),t.attachShader(n,s),this.attribSemantics.POSITION)t.bindAttribLocation(n,0,this.attribSemantics.POSITION.symbol);else{var h=Object.keys(this.attributeTemplates);t.bindAttribLocation(n,0,h[0])}if(t.linkProgram(n),!t.getProgramParameter(n,t.LINK_STATUS))return"Could not link program\nVALIDATE_STATUS: "+t.getProgramParameter(n,t.VALIDATE_STATUS)+", gl error ["+t.getError()+"]";for(var c=0;c<this._uniformList.length;c++){var _=this._uniformList[c];i.get("locations")[_]=t.getUniformLocation(n,_)}t.deleteShader(a),t.deleteShader(s),i.put("program",n)},clone:function(){var t=new dt({vertex:this.vertex,fragment:this.fragment,vertexDefines:x.clone(this.vertexDefines),fragmentDefines:x.clone(this.fragmentDefines)});for(var r in this._textureStatus)t._textureStatus[r]=x.clone(this._textureStatus[r]);return t},dispose:function(t){var r=this._cache;r.use(t.__GUID__);var e=r.get("program");e&&t.gl.deleteProgram(e),r.deleteContext(t.__GUID__),this._locations={}}}),mt=/(@import)\s*([0-9a-zA-Z_\-\.]*)/g;dt.parseImport=function(t){return t=t.replace(mt,function(t,r,e){return(t=dt.source(e))?dt.parseImport(t):(console.error('Shader chunk "'+e+'" not existed in library'),"")})};var yt=/(@export)\s*([0-9a-zA-Z_\-\.]*)\s*\n([\s\S]*?)@end/g;dt.import=function(t){t.replace(yt,function(t,r,e,i){if(i=i.replace(/(^[\s\t\xa0\u3000]+)|([\u3000\xa0\s\t]+\x24)/g,"")){for(var n,a=e.split("."),s=dt.codes,o=0;o<a.length-1;)s[n=a[o++]]||(s[n]={}),s=s[n];s[n=a[o]]=i}return i})},dt.codes={},dt.source=function(t){for(var r=t.split("."),e=dt.codes,i=0;e&&i<r.length;)e=e[r[i++]];return"string"!=typeof e?(console.error('Shader "'+t+'" not existed in library'),""):e};var pt=M.extend({width:512,height:512,type:P.UNSIGNED_BYTE,format:P.RGBA,wrapS:P.REPEAT,wrapT:P.REPEAT,minFilter:P.LINEAR_MIPMAP_LINEAR,magFilter:P.LINEAR,useMipmap:!0,anisotropic:1,flipY:!0,unpackAlignment:4,premultiplyAlpha:!1,dynamic:!1,NPOT:!1},function(){this._cache=new tt},{getWebGLTexture:function(t){var r=t.gl,e=this._cache;return e.use(t.__GUID__),e.miss("webgl_texture")&&e.put("webgl_texture",r.createTexture()),this.dynamic?this.update(t):e.isDirty()&&(this.update(t),e.fresh()),e.get("webgl_texture")},bind:function(){},unbind:function(){},dirty:function(){this._cache&&this._cache.dirtyAll()},update:function(t){},updateCommon:function(t){var r=t.gl;r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,this.flipY),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),r.pixelStorei(r.UNPACK_ALIGNMENT,this.unpackAlignment),this.format===P.DEPTH_COMPONENT&&(this.useMipmap=!1);var e=t.getGLExtension("EXT_sRGB");this.format!==pt.SRGB||e||(this.format=pt.RGB),this.format!==pt.SRGB_ALPHA||e||(this.format=pt.RGBA),this.NPOT=!this.isPowerOfTwo()},getAvailableWrapS:function(){return this.NPOT?P.CLAMP_TO_EDGE:this.wrapS},getAvailableWrapT:function(){return this.NPOT?P.CLAMP_TO_EDGE:this.wrapT},getAvailableMinFilter:function(){var t=this.minFilter;return this.NPOT||!this.useMipmap?t==P.NEAREST_MIPMAP_NEAREST||t==P.NEAREST_MIPMAP_LINEAR?P.NEAREST:t==P.LINEAR_MIPMAP_LINEAR||t==P.LINEAR_MIPMAP_NEAREST?P.LINEAR:t:t},getAvailableMagFilter:function(){return this.magFilter},nextHighestPowerOfTwo:function(t){--t;for(var r=1;r<32;r<<=1)t|=t>>r;return t+1},dispose:function(t){var r=this._cache;r.use(t.__GUID__);var e=r.get("webgl_texture");e&&t.gl.deleteTexture(e),r.deleteContext(t.__GUID__)},isRenderable:function(){},isPowerOfTwo:function(){}});Object.defineProperty(pt.prototype,"width",{get:function(){return this._width},set:function(t){this._width=t}}),Object.defineProperty(pt.prototype,"height",{get:function(){return this._height},set:function(t){this._height=t}}),pt.BYTE=P.BYTE,pt.UNSIGNED_BYTE=P.UNSIGNED_BYTE,pt.SHORT=P.SHORT,pt.UNSIGNED_SHORT=P.UNSIGNED_SHORT,pt.INT=P.INT,pt.UNSIGNED_INT=P.UNSIGNED_INT,pt.FLOAT=P.FLOAT,pt.HALF_FLOAT=36193,pt.UNSIGNED_INT_24_8_WEBGL=34042,pt.DEPTH_COMPONENT=P.DEPTH_COMPONENT,pt.DEPTH_STENCIL=P.DEPTH_STENCIL,pt.ALPHA=P.ALPHA,pt.RGB=P.RGB,pt.RGBA=P.RGBA,pt.LUMINANCE=P.LUMINANCE,pt.LUMINANCE_ALPHA=P.LUMINANCE_ALPHA,pt.SRGB=35904,pt.SRGB_ALPHA=35906,pt.COMPRESSED_RGB_S3TC_DXT1_EXT=33776,pt.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777,pt.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778,pt.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779,pt.NEAREST=P.NEAREST,pt.LINEAR=P.LINEAR,pt.NEAREST_MIPMAP_NEAREST=P.NEAREST_MIPMAP_NEAREST,pt.LINEAR_MIPMAP_NEAREST=P.LINEAR_MIPMAP_NEAREST,pt.NEAREST_MIPMAP_LINEAR=P.NEAREST_MIPMAP_LINEAR,pt.LINEAR_MIPMAP_LINEAR=P.LINEAR_MIPMAP_LINEAR,pt.REPEAT=P.REPEAT,pt.CLAMP_TO_EDGE=P.CLAMP_TO_EDGE,pt.MIRRORED_REPEAT=P.MIRRORED_REPEAT;var vt=M.extend({name:"",depthTest:!0,depthMask:!0,transparent:!1,blend:null,_enabledUniforms:null},function(){this.name||(this.name="MATERIAL_"+this.__GUID__),this.shader&&this.attachShader(this.shader),this.uniforms||(this.uniforms={})},{bind:function(t,r,e,i){for(var n=t.gl,a=(r=r||this.shader).currentTextureSlot(),s=0;s<this._enabledUniforms.length;s++){o=this._enabledUniforms[s];if((h=this.uniforms[o].value)instanceof pt)h.__slot=-1;else if(Array.isArray(h))for(f=0;f<h.length;f++)h[f]instanceof pt&&(h[f].__slot=-1)}for(s=0;s<this._enabledUniforms.length;s++){var o=this._enabledUniforms[s],u=this.uniforms[o],h=u.value;if(null!==h)if(h instanceof pt)if(h.__slot<0){var c=r.currentTextureSlot(),_=r.setUniform(n,"1i",o,c);if(!_)continue;r.takeCurrentTextureSlot(t,h),h.__slot=c}else r.setUniform(n,"1i",o,h.__slot);else if(Array.isArray(h)){if(0===h.length)continue;if(h[0]instanceof pt){if(!r.hasUniform(o))continue;for(var l=[],f=0;f<h.length;f++){var d=h[f];if(d.__slot<0){c=r.currentTextureSlot();l.push(c),r.takeCurrentTextureSlot(t,d),d.__slot=c}else l.push(d.__slot)}r.setUniform(n,"1iv",o,l)}else r.setUniform(n,u.type,o,h)}else r.setUniform(n,u.type,o,h);else if("t"===u.type){c=r.currentTextureSlot();(_=r.setUniform(n,"1i",o,c))&&r.takeCurrentTextureSlot(t,null)}}r.resetTextureSlot(a)},setUniform:function(t,r){void 0===r&&console.warn('Uniform value "'+t+'" is undefined');var e=this.uniforms[t];e&&(e.value=r)},setUniforms:function(t){for(var r in t){var e=t[r];this.setUniform(r,e)}},isUniformEnabled:function(t){return this._enabledUniforms.indexOf(t)>=0},set:function(t,r){if("object"==typeof t)for(var e in t){var i=t[e];this.set(e,i)}else{var n=this.uniforms[t];n&&(void 0===r&&(console.warn('Uniform value "'+t+'" is undefined'),r=null),n.value=r)}},get:function(t){var r=this.uniforms[t];if(r)return r.value},attachShader:function(t,r){this.shader&&this.shader.detached();var e=this.uniforms;this.uniforms=t.createUniforms(),this.shader=t;var i=this.uniforms;if(this._enabledUniforms=Object.keys(i),this._enabledUniforms.sort(),r)for(var n in e)i[n]&&(i[n].value=e[n].value);t.attached()},detachShader:function(){this.shader.detached(),this.shader=null,this.uniforms={}},clone:function(){var t=new this.constructor({name:this.name,shader:this.shader});for(var r in this.uniforms)t.uniforms[r].value=this.uniforms[r].value;return t.depthTest=this.depthTest,t.depthMask=this.depthMask,t.transparent=this.transparent,t.blend=this.blend,t},dispose:function(t,r){if(r)for(var e in this.uniforms){var i=this.uniforms[e].value;if(i)if(i instanceof pt)i.dispose(t);else if(Array.isArray(i))for(var n=0;n<i.length;n++)i[n]instanceof pt&&i[n].dispose(t)}var a=this.shader;a&&(this.detachShader(),a.isAttachedToAny()||a.dispose(t))}}),Et=D.vec2,Tt=function(t,r){t=t||0,r=r||0,this._array=Et.fromValues(t,r),this._dirty=!0};if(Tt.prototype={constructor:Tt,add:function(t){return Et.add(this._array,this._array,t._array),this._dirty=!0,this},set:function(t,r){return this._array[0]=t,this._array[1]=r,this._dirty=!0,this},setArray:function(t){return this._array[0]=t[0],this._array[1]=t[1],this._dirty=!0,this},clone:function(){return new Tt(this.x,this.y)},copy:function(t){return Et.copy(this._array,t._array),this._dirty=!0,this},cross:function(t,r){return Et.cross(t._array,this._array,r._array),t._dirty=!0,this},dist:function(t){return Et.dist(this._array,t._array)},distance:function(t){return Et.distance(this._array,t._array)},div:function(t){return Et.div(this._array,this._array,t._array),this._dirty=!0,this},divide:function(t){return Et.divide(this._array,this._array,t._array),this._dirty=!0,this},dot:function(t){return Et.dot(this._array,t._array)},len:function(){return Et.len(this._array)},length:function(){return Et.length(this._array)},lerp:function(t,r,e){return Et.lerp(this._array,t._array,r._array,e),this._dirty=!0,this},min:function(t){return Et.min(this._array,this._array,t._array),this._dirty=!0,this},max:function(t){return Et.max(this._array,this._array,t._array),this._dirty=!0,this},mul:function(t){return Et.mul(this._array,this._array,t._array),this._dirty=!0,this},multiply:function(t){return Et.multiply(this._array,this._array,t._array),this._dirty=!0,this},negate:function(){return Et.negate(this._array,this._array),this._dirty=!0,this},normalize:function(){return Et.normalize(this._array,this._array),this._dirty=!0,this},random:function(t){return Et.random(this._array,t),this._dirty=!0,this},scale:function(t){return Et.scale(this._array,this._array,t),this._dirty=!0,this},scaleAndAdd:function(t,r){return Et.scaleAndAdd(this._array,this._array,t._array,r),this._dirty=!0,this},sqrDist:function(t){return Et.sqrDist(this._array,t._array)},squaredDistance:function(t){return Et.squaredDistance(this._array,t._array)},sqrLen:function(){return Et.sqrLen(this._array)},squaredLength:function(){return Et.squaredLength(this._array)},sub:function(t){return Et.sub(this._array,this._array,t._array),this._dirty=!0,this},subtract:function(t){return Et.subtract(this._array,this._array,t._array),this._dirty=!0,this},transformMat2:function(t){return Et.transformMat2(this._array,this._array,t._array),this._dirty=!0,this},transformMat2d:function(t){return Et.transformMat2d(this._array,this._array,t._array),this._dirty=!0,this},transformMat3:function(t){return Et.transformMat3(this._array,this._array,t._array),this._dirty=!0,this},transformMat4:function(t){return Et.transformMat4(this._array,this._array,t._array),this._dirty=!0,this},toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"},toArray:function(){return Array.prototype.slice.call(this._array)}},Object.defineProperty){var gt=Tt.prototype;Object.defineProperty(gt,"x",{get:function(){return this._array[0]},set:function(t){this._array[0]=t,this._dirty=!0}}),Object.defineProperty(gt,"y",{get:function(){return this._array[1]},set:function(t){this._array[1]=t,this._dirty=!0}})}Tt.add=function(t,r,e){return Et.add(t._array,r._array,e._array),t._dirty=!0,t},Tt.set=function(t,r,e){return Et.set(t._array,r,e),t._dirty=!0,t},Tt.copy=function(t,r){return Et.copy(t._array,r._array),t._dirty=!0,t},Tt.cross=function(t,r,e){return Et.cross(t._array,r._array,e._array),t._dirty=!0,t},Tt.dist=function(t,r){return Et.distance(t._array,r._array)},Tt.distance=Tt.dist,Tt.div=function(t,r,e){return Et.divide(t._array,r._array,e._array),t._dirty=!0,t},Tt.divide=Tt.div,Tt.dot=function(t,r){return Et.dot(t._array,r._array)},Tt.len=function(t){return Et.length(t._array)},Tt.lerp=function(t,r,e,i){return Et.lerp(t._array,r._array,e._array,i),t._dirty=!0,t},Tt.min=function(t,r,e){return Et.min(t._array,r._array,e._array),t._dirty=!0,t},Tt.max=function(t,r,e){return Et.max(t._array,r._array,e._array),t._dirty=!0,t},Tt.mul=function(t,r,e){return Et.multiply(t._array,r._array,e._array),t._dirty=!0,t},Tt.multiply=Tt.mul,Tt.negate=function(t,r){return Et.negate(t._array,r._array),t._dirty=!0,t},Tt.normalize=function(t,r){return Et.normalize(t._array,r._array),t._dirty=!0,t},Tt.random=function(t,r){return Et.random(t._array,r),t._dirty=!0,t},Tt.scale=function(t,r,e){return Et.scale(t._array,r._array,e),t._dirty=!0,t},Tt.scaleAndAdd=function(t,r,e,i){return Et.scaleAndAdd(t._array,r._array,e._array,i),t._dirty=!0,t},Tt.sqrDist=function(t,r){return Et.sqrDist(t._array,r._array)},Tt.squaredDistance=Tt.sqrDist,Tt.sqrLen=function(t){return Et.sqrLen(t._array)},Tt.squaredLength=Tt.sqrLen,Tt.sub=function(t,r,e){return Et.subtract(t._array,r._array,e._array),t._dirty=!0,t},Tt.subtract=Tt.sub,Tt.transformMat2=function(t,r,e){return Et.transformMat2(t._array,r._array,e._array),t._dirty=!0,t},Tt.transformMat2d=function(t,r,e){return Et.transformMat2d(t._array,r._array,e._array),t._dirty=!0,t},Tt.transformMat3=function(t,r,e){return Et.transformMat3(t._array,r._array,e._array),t._dirty=!0,t},Tt.transformMat4=function(t,r,e){return Et.transformMat4(t._array,r._array,e._array),t._dirty=!0,t};var At=":unconfigurable;",Rt=["@export qtek.header.directional_light","uniform vec3 directionalLightDirection[DIRECTIONAL_LIGHT_COUNT]"+At,"uniform vec3 directionalLightColor[DIRECTIONAL_LIGHT_COUNT]"+At,"@end","@export qtek.header.ambient_light","uniform vec3 ambientLightColor[AMBIENT_LIGHT_COUNT]"+At,"@end","@export qtek.header.ambient_sh_light","uniform vec3 ambientSHLightColor[AMBIENT_SH_LIGHT_COUNT]"+At,"uniform vec3 ambientSHLightCoefficients[AMBIENT_SH_LIGHT_COUNT * 9]"+At,"vec3 calcAmbientSHLight(int idx, vec3 N) {\n    int offset = 9 * idx;\n    return ambientSHLightCoefficients[0]\n        + ambientSHLightCoefficients[1] * N.x\n        + ambientSHLightCoefficients[2] * N.y\n        + ambientSHLightCoefficients[3] * N.z\n        + ambientSHLightCoefficients[4] * N.x * N.z\n        + ambientSHLightCoefficients[5] * N.z * N.y\n        + ambientSHLightCoefficients[6] * N.y * N.x\n        + ambientSHLightCoefficients[7] * (3.0 * N.z * N.z - 1.0)\n        + ambientSHLightCoefficients[8] * (N.x * N.x - N.y * N.y);\n}","@end","@export qtek.header.ambient_cubemap_light","uniform vec3 ambientCubemapLightColor[AMBIENT_CUBEMAP_LIGHT_COUNT]"+At,"uniform samplerCube ambientCubemapLightCubemap[AMBIENT_CUBEMAP_LIGHT_COUNT]"+At,"uniform sampler2D ambientCubemapLightBRDFLookup[AMBIENT_CUBEMAP_LIGHT_COUNT]"+At,"@end","@export qtek.header.point_light","uniform vec3 pointLightPosition[POINT_LIGHT_COUNT]"+At,"uniform float pointLightRange[POINT_LIGHT_COUNT]"+At,"uniform vec3 pointLightColor[POINT_LIGHT_COUNT]"+At,"@end","@export qtek.header.spot_light","uniform vec3 spotLightPosition[SPOT_LIGHT_COUNT]"+At,"uniform vec3 spotLightDirection[SPOT_LIGHT_COUNT]"+At,"uniform float spotLightRange[SPOT_LIGHT_COUNT]"+At,"uniform float spotLightUmbraAngleCosine[SPOT_LIGHT_COUNT]"+At,"uniform float spotLightPenumbraAngleCosine[SPOT_LIGHT_COUNT]"+At,"uniform float spotLightFalloffFactor[SPOT_LIGHT_COUNT]"+At,"uniform vec3 spotLightColor[SPOT_LIGHT_COUNT]"+At,"@end"].join("\n");dt.import(Rt),dt.import("@export qtek.prez.vertex\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nattribute vec3 position : POSITION;\n@import qtek.chunk.skinning_header\nvoid main()\n{\n    vec3 skinnedPosition = position;\n#ifdef SKINNING\n    @import qtek.chunk.skin_matrix\n    skinnedPosition = (skinMatrixWS * vec4(position, 1.0)).xyz;\n#endif\n    gl_Position = worldViewProjection * vec4(skinnedPosition, 1.0);\n}\n@end\n@export qtek.prez.fragment\nvoid main()\n{\n    gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n@end");var St=D.mat4,It=D.vec3,Nt=St.create,xt={},Mt=M.extend(function(){return{canvas:null,_width:100,_height:100,devicePixelRatio:window.devicePixelRatio||1,clearColor:[0,0,0,0],clearBit:17664,alpha:!0,depth:!0,stencil:!1,antialias:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!1,throwError:!0,gl:null,viewport:{},__currentFrameBuffer:null,_viewportStack:[],_clearStack:[],_sceneRendering:null}},function(){this.canvas||(this.canvas=document.createElement("canvas"));var t=this.canvas;try{var r={alpha:this.alpha,depth:this.depth,stencil:this.stencil,antialias:this.antialias,premultipliedAlpha:this.premultipliedAlpha,preserveDrawingBuffer:this.preserveDrawingBuffer};if(this.gl=t.getContext("webgl",r)||t.getContext("experimental-webgl",r),!this.gl)throw new Error;this._glinfo=new n(this.gl),this.gl.targetRenderer&&console.error("Already created a renderer"),this.gl.targetRenderer=this,this.resize()}catch(t){throw"Error creating WebGL Context "+t}},{resize:function(t,r){var e=this.canvas,i=this.devicePixelRatio;null!=t?(e.style.width=t+"px",e.style.height=r+"px",e.width=t*i,e.height=r*i,this._width=t,this._height=r):(this._width=e.width/i,this._height=e.height/i),this.setViewport(0,0,this._width,this._height)},getWidth:function(){return this._width},getHeight:function(){return this._height},getViewportAspect:function(){var t=this.viewport;return t.width/t.height},setDevicePixelRatio:function(t){this.devicePixelRatio=t,this.resize(this._width,this._height)},getDevicePixelRatio:function(){return this.devicePixelRatio},getGLExtension:function(t){return this._glinfo.getExtension(t)},getGLParameter:function(t){return this._glinfo.getParameter(t)},setViewport:function(t,r,e,i,n){if("object"==typeof t){var a=t;t=a.x,r=a.y,e=a.width,i=a.height,n=a.devicePixelRatio}n=n||this.devicePixelRatio,this.gl.viewport(t*n,r*n,e*n,i*n),this.viewport={x:t,y:r,width:e,height:i,devicePixelRatio:n}},saveViewport:function(){this._viewportStack.push(this.viewport)},restoreViewport:function(){this._viewportStack.length>0&&this.setViewport(this._viewportStack.pop())},saveClear:function(){this._clearStack.push({clearBit:this.clearBit,clearColor:this.clearColor})},restoreClear:function(){if(this._clearStack.length>0){var t=this._clearStack.pop();this.clearColor=t.clearColor,this.clearBit=t.clearBit}},bindSceneRendering:function(t){this._sceneRendering=t},beforeRenderObject:function(){},afterRenderObject:function(){},render:function(t,r,e,i){var n=this.gl;this._sceneRendering=t;var a=this.clearColor;if(this.clearBit){n.colorMask(!0,!0,!0,!0),n.depthMask(!0);var s=this.viewport,o=!1,u=s.devicePixelRatio;(s.width!==this._width||s.height!==this._height||u&&u!==this.devicePixelRatio||s.x||s.y)&&(o=!0,n.enable(n.SCISSOR_TEST),n.scissor(s.x*u,s.y*u,s.width*u,s.height*u)),n.clearColor(a[0],a[1],a[2],a[3]),n.clear(this.clearBit),o&&n.disable(n.SCISSOR_TEST)}e||t.update(!1),r.getScene()||r.update(!0);for(var h=t.opaqueQueue,c=t.transparentQueue,_=t.material,l=0;l<h.length;l++)(f=h[l].material).updateShader&&f.updateShader(this);for(l=0;l<c.length;l++){var f=c[l].material;f.updateShader&&f.updateShader(this)}if(t.trigger("beforerender",this,t,r),c.length>0)for(var d=Nt(),m=It.create(),l=0;l<c.length;l++){var y=c[l];St.multiplyAffine(d,r.viewMatrix._array,y.worldTransform._array),It.transformMat4(m,y.position._array,d),y.__depth=m[2]}h.sort(this.opaqueSortFunc),c.sort(this.transparentSortFunc),t.trigger("beforerender:opaque",this,h),t.viewBoundingBoxLastFrame.min.set(1/0,1/0,1/0),t.viewBoundingBoxLastFrame.max.set(-1/0,-1/0,-1/0),n.disable(n.BLEND),n.enable(n.DEPTH_TEST);var p=this.renderQueue(h,r,_,i);t.trigger("afterrender:opaque",this,h,p),t.trigger("beforerender:transparent",this,c),n.enable(n.BLEND);var v=this.renderQueue(c,r,_);t.trigger("afterrender:transparent",this,c,v);var E={};for(var T in p)E[T]=p[T]+v[T];return t.trigger("afterrender",this,t,r,E),this._sceneRendering=null,E},resetRenderStatus:function(){this._currentShader=null},ifRenderObject:function(t){return!0},renderQueue:function(t,r,e,i){var n={triangleCount:0,vertexCount:0,drawCallCount:0,meshCount:t.length,renderedMeshCount:0},a=this.viewport,s=a.devicePixelRatio,o=[a.x*s,a.y*s,a.width*s,a.height*s],u=this.devicePixelRatio,h=this.__currentFrameBuffer?[this.__currentFrameBuffer.getTextureWidth(),this.__currentFrameBuffer.getTextureHeight()]:[this._width*u,this._height*u],c=[o[2],o[3]],_=Date.now();St.copy(Ot.VIEW,r.viewMatrix._array),St.copy(Ot.PROJECTION,r.projectionMatrix._array),St.multiply(Ot.VIEWPROJECTION,r.projectionMatrix._array,Ot.VIEW),St.copy(Ot.VIEWINVERSE,r.worldTransform._array),St.invert(Ot.PROJECTIONINVERSE,Ot.PROJECTION),St.invert(Ot.VIEWPROJECTIONINVERSE,Ot.VIEWPROJECTION);var l,f,d,m=this.gl,y=this._sceneRendering;i?d=this._renderPreZ(t,y,r):(d=t,m.depthFunc(m.LESS));for(var p,v,E,T,g,A=0;A<d.length;A++){var R=d[A];if(this.ifRenderObject(R)){var S=R.geometry,I=R.isSkinnedMesh()?Ot.IDENTITY:R.worldTransform._array;if(St.multiplyAffine(Ot.WORLDVIEW,Ot.VIEW,I),!S.boundingBox||i||!this.isFrustumCulled(R,y,r,Ot.WORLDVIEW,Ot.PROJECTION)){var N=e||R.material,x=N.shader;if(St.copy(Ot.WORLD,I),St.multiply(Ot.WORLDVIEWPROJECTION,Ot.VIEWPROJECTION,I),(x.matrixSemantics.WORLDINVERSE||x.matrixSemantics.WORLDINVERSETRANSPOSE)&&St.invert(Ot.WORLDINVERSE,I),(x.matrixSemantics.WORLDVIEWINVERSE||x.matrixSemantics.WORLDVIEWINVERSETRANSPOSE)&&St.invert(Ot.WORLDVIEWINVERSE,Ot.WORLDVIEW),(x.matrixSemantics.WORLDVIEWPROJECTIONINVERSE||x.matrixSemantics.WORLDVIEWPROJECTIONINVERSETRANSPOSE)&&St.invert(Ot.WORLDVIEWPROJECTIONINVERSE,Ot.WORLDVIEWPROJECTION),R.beforeRender(this),this.beforeRenderObject(R,l,f),!x.isEqual(f)){y&&y.isShaderLightNumberChanged(x)&&y.setShaderLightNumber(x);var M=x.bind(this);if(M){if(xt[x.__GUID__])continue;if(xt[x.__GUID__]=!0,this.throwError)throw new Error(M);this.trigger("error",M)}x.setUniformOfSemantic(m,"VIEWPORT",o),x.setUniformOfSemantic(m,"WINDOW_SIZE",h),x.setUniformOfSemantic(m,"NEAR",r.near),x.setUniformOfSemantic(m,"FAR",r.far),x.setUniformOfSemantic(m,"DEVICEPIXELRATIO",s),x.setUniformOfSemantic(m,"TIME",_),x.setUniformOfSemantic(m,"VIEWPORT_SIZE",c),y&&y.setLightUniforms(x,this)}else x=f;l!==N&&(i||(N.depthTest!==p&&(N.depthTest?m.enable(m.DEPTH_TEST):m.disable(m.DEPTH_TEST),p=N.depthTest),N.depthMask!==v&&(m.depthMask(N.depthMask),v=N.depthMask)),N.bind(this,x,l,f),l=N,N.transparent&&(N.blend?N.blend(m):(m.blendEquationSeparate(m.FUNC_ADD,m.FUNC_ADD),m.blendFuncSeparate(m.SRC_ALPHA,m.ONE_MINUS_SRC_ALPHA,m.ONE,m.ONE_MINUS_SRC_ALPHA))));for(var O=x.matrixSemanticKeys,b=0;b<O.length;b++){var P=O[b],w=x.matrixSemantics[P],L=Ot[P];if(w.isTranspose){var C=Ot[w.semanticNoTranspose];St.transpose(L,C)}x.setUniform(m,w.type,w.symbol,L)}R.cullFace!==T&&(T=R.cullFace,m.cullFace(T)),R.frontFace!==g&&(g=R.frontFace,m.frontFace(g)),R.culling!==E&&((E=R.culling)?m.enable(m.CULL_FACE):m.disable(m.CULL_FACE));var D=R.render(this,x);D&&(n.triangleCount+=D.triangleCount,n.vertexCount+=D.vertexCount,n.drawCallCount+=D.drawCallCount,n.renderedMeshCount++),this.afterRenderObject(R,D),R.afterRender(this,D),f=x}}}return n},_renderPreZ:function(t,r,e){var i=this.gl,n=this._prezMaterial||new vt({shader:new dt({vertex:dt.source("qtek.prez.vertex"),fragment:dt.source("qtek.prez.fragment")})});this._prezMaterial=n;var a,s,o,u=n.shader,h=[];u.bind(this),i.colorMask(!1,!1,!1,!1),i.depthMask(!0),i.enable(i.DEPTH_TEST);for(var c=0;c<t.length;c++){var _=t[c];if(this.ifRenderObject(_)){var l=_.isSkinnedMesh()?Ot.IDENTITY:_.worldTransform._array,f=_.geometry;if(St.multiplyAffine(Ot.WORLDVIEW,Ot.VIEW,l),!(f.boundingBox&&this.isFrustumCulled(_,r,e,Ot.WORLDVIEW,Ot.PROJECTION)||(h.push(_),_.skeleton||_.ignorePreZ))){St.multiply(Ot.WORLDVIEWPROJECTION,Ot.VIEWPROJECTION,l),_.cullFace!==s&&(s=_.cullFace,i.cullFace(s)),_.frontFace!==o&&(o=_.frontFace,i.frontFace(o)),_.culling!==a&&((a=_.culling)?i.enable(i.CULL_FACE):i.disable(i.CULL_FACE));var d=u.matrixSemantics.WORLDVIEWPROJECTION;u.setUniform(i,d.type,d.symbol,Ot.WORLDVIEWPROJECTION),_.render(this,n.shader)}}}return i.depthFunc(i.LEQUAL),i.colorMask(!0,!0,!0,!0),i.depthMask(!0),h},isFrustumCulled:function(){var t=new z,r=new K;return function(e,i,n,a,s){var o=e.boundingBox||e.geometry.boundingBox;if(r._array=a,t.copy(o),t.applyTransform(r),i&&e.isRenderable()&&e.castShadow&&i.viewBoundingBoxLastFrame.union(t),e.frustumCulling&&!e.isSkinnedMesh()){if(!t.intersectBoundingBox(n.frustum.boundingBox))return!0;r._array=s,t.max._array[2]>0&&t.min._array[2]<0&&(t.max._array[2]=-1e-20),t.applyProjection(r);var u=t.min._array,h=t.max._array;if(h[0]<-1||u[0]>1||h[1]<-1||u[1]>1||h[2]<-1||u[2]>1)return!0}return!1}}(),disposeScene:function(t){this.disposeNode(t,!0,!0),t.dispose()},disposeNode:function(t,r,e){var i={};t.getParent()&&t.getParent().remove(t),t.traverse(function(t){t.geometry&&r&&t.geometry.dispose(this),t.material&&(i[t.material.__GUID__]=t.material),t.dispose&&t.dispose(this)},this);for(var n in i)i[n].dispose(this,e)},disposeShader:function(t){t.dispose(this)},disposeGeometry:function(t){t.dispose(this)},disposeTexture:function(t){t.dispose(this)},disposeFrameBuffer:function(t){t.dispose(this)},dispose:function(){},screenToNDC:function(t,r,e){e||(e=new Tt),r=this._height-r;var i=this.viewport,n=e._array;return n[0]=(t-i.x)/i.width,n[0]=2*n[0]-1,n[1]=(r-i.y)/i.height,n[1]=2*n[1]-1,e}});Mt.opaqueSortFunc=Mt.prototype.opaqueSortFunc=function(t,r){return t.renderOrder===r.renderOrder?t.material.shader===r.material.shader?t.material===r.material?t.geometry.__GUID__-r.geometry.__GUID__:t.material.__GUID__-r.material.__GUID__:t.material.shader.__GUID__-r.material.shader.__GUID__:t.renderOrder-r.renderOrder},Mt.transparentSortFunc=Mt.prototype.transparentSortFunc=function(t,r){return t.renderOrder===r.renderOrder?t.__depth===r.__depth?t.material.shader===r.material.shader?t.material===r.material?t.geometry.__GUID__-r.geometry.__GUID__:t.material.__GUID__-r.material.__GUID__:t.material.shader.__GUID__-r.material.shader.__GUID__:t.__depth-r.__depth:t.renderOrder-r.renderOrder};var Ot={IDENTITY:Nt(),WORLD:Nt(),VIEW:Nt(),PROJECTION:Nt(),WORLDVIEW:Nt(),VIEWPROJECTION:Nt(),WORLDVIEWPROJECTION:Nt(),WORLDINVERSE:Nt(),VIEWINVERSE:Nt(),PROJECTIONINVERSE:Nt(),WORLDVIEWINVERSE:Nt(),VIEWPROJECTIONINVERSE:Nt(),WORLDVIEWPROJECTIONINVERSE:Nt(),WORLDTRANSPOSE:Nt(),VIEWTRANSPOSE:Nt(),PROJECTIONTRANSPOSE:Nt(),WORLDVIEWTRANSPOSE:Nt(),VIEWPROJECTIONTRANSPOSE:Nt(),WORLDVIEWPROJECTIONTRANSPOSE:Nt(),WORLDINVERSETRANSPOSE:Nt(),VIEWINVERSETRANSPOSE:Nt(),PROJECTIONINVERSETRANSPOSE:Nt(),WORLDVIEWINVERSETRANSPOSE:Nt(),VIEWPROJECTIONINVERSETRANSPOSE:Nt(),WORLDVIEWPROJECTIONINVERSETRANSPOSE:Nt()};Mt.COLOR_BUFFER_BIT=P.COLOR_BUFFER_BIT,Mt.DEPTH_BUFFER_BIT=P.DEPTH_BUFFER_BIT,Mt.STENCIL_BUFFER_BIT=P.STENCIL_BUFFER_BIT;var bt=D.quat,Pt=function(t,r,e,i){t=t||0,r=r||0,e=e||0,i=void 0===i?1:i,this._array=bt.fromValues(t,r,e,i),this._dirty=!0};Pt.prototype={constructor:Pt,add:function(t){return bt.add(this._array,this._array,t._array),this._dirty=!0,this},calculateW:function(){return bt.calculateW(this._array,this._array),this._dirty=!0,this},set:function(t,r,e,i){return this._array[0]=t,this._array[1]=r,this._array[2]=e,this._array[3]=i,this._dirty=!0,this},setArray:function(t){return this._array[0]=t[0],this._array[1]=t[1],this._array[2]=t[2],this._array[3]=t[3],this._dirty=!0,this},clone:function(){return new Pt(this.x,this.y,this.z,this.w)},conjugate:function(){return bt.conjugate(this._array,this._array),this._dirty=!0,this},copy:function(t){return bt.copy(this._array,t._array),this._dirty=!0,this},dot:function(t){return bt.dot(this._array,t._array)},fromMat3:function(t){return bt.fromMat3(this._array,t._array),this._dirty=!0,this},fromMat4:function(){var t=D.mat3,r=t.create();return function(e){return t.fromMat4(r,e._array),t.transpose(r,r),bt.fromMat3(this._array,r),this._dirty=!0,this}}(),identity:function(){return bt.identity(this._array),this._dirty=!0,this},invert:function(){return bt.invert(this._array,this._array),this._dirty=!0,this},len:function(){return bt.len(this._array)},length:function(){return bt.length(this._array)},lerp:function(t,r,e){return bt.lerp(this._array,t._array,r._array,e),this._dirty=!0,this},mul:function(t){return bt.mul(this._array,this._array,t._array),this._dirty=!0,this},mulLeft:function(t){return bt.multiply(this._array,t._array,this._array),this._dirty=!0,this},multiply:function(t){return bt.multiply(this._array,this._array,t._array),this._dirty=!0,this},multiplyLeft:function(t){return bt.multiply(this._array,t._array,this._array),this._dirty=!0,this},normalize:function(){return bt.normalize(this._array,this._array),this._dirty=!0,this},rotateX:function(t){return bt.rotateX(this._array,this._array,t),this._dirty=!0,this},rotateY:function(t){return bt.rotateY(this._array,this._array,t),this._dirty=!0,this},rotateZ:function(t){return bt.rotateZ(this._array,this._array,t),this._dirty=!0,this},rotationTo:function(t,r){return bt.rotationTo(this._array,t._array,r._array),this._dirty=!0,this},setAxes:function(t,r,e){return bt.setAxes(this._array,t._array,r._array,e._array),this._dirty=!0,this},setAxisAngle:function(t,r){return bt.setAxisAngle(this._array,t._array,r),this._dirty=!0,this},slerp:function(t,r,e){return bt.slerp(this._array,t._array,r._array,e),this._dirty=!0,this},sqrLen:function(){return bt.sqrLen(this._array)},squaredLength:function(){return bt.squaredLength(this._array)},fromEuler:function(t,r){return Pt.fromEuler(this,t,r)},toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"},toArray:function(){return Array.prototype.slice.call(this._array)}};var wt=Object.defineProperty;if(wt){var Lt=Pt.prototype;wt(Lt,"x",{get:function(){return this._array[0]},set:function(t){this._array[0]=t,this._dirty=!0}}),wt(Lt,"y",{get:function(){return this._array[1]},set:function(t){this._array[1]=t,this._dirty=!0}}),wt(Lt,"z",{get:function(){return this._array[2]},set:function(t){this._array[2]=t,this._dirty=!0}}),wt(Lt,"w",{get:function(){return this._array[3]},set:function(t){this._array[3]=t,this._dirty=!0}})}Pt.add=function(t,r,e){return bt.add(t._array,r._array,e._array),t._dirty=!0,t},Pt.set=function(t,r,e,i,n){bt.set(t._array,r,e,i,n),t._dirty=!0},Pt.copy=function(t,r){return bt.copy(t._array,r._array),t._dirty=!0,t},Pt.calculateW=function(t,r){return bt.calculateW(t._array,r._array),t._dirty=!0,t},Pt.conjugate=function(t,r){return bt.conjugate(t._array,r._array),t._dirty=!0,t},Pt.identity=function(t){return bt.identity(t._array),t._dirty=!0,t},Pt.invert=function(t,r){return bt.invert(t._array,r._array),t._dirty=!0,t},Pt.dot=function(t,r){return bt.dot(t._array,r._array)},Pt.len=function(t){return bt.length(t._array)},Pt.lerp=function(t,r,e,i){return bt.lerp(t._array,r._array,e._array,i),t._dirty=!0,t},Pt.slerp=function(t,r,e,i){return bt.slerp(t._array,r._array,e._array,i),t._dirty=!0,t},Pt.mul=function(t,r,e){return bt.multiply(t._array,r._array,e._array),t._dirty=!0,t},Pt.multiply=Pt.mul,Pt.rotateX=function(t,r,e){return bt.rotateX(t._array,r._array,e),t._dirty=!0,t},Pt.rotateY=function(t,r,e){return bt.rotateY(t._array,r._array,e),t._dirty=!0,t},Pt.rotateZ=function(t,r,e){return bt.rotateZ(t._array,r._array,e),t._dirty=!0,t},Pt.setAxisAngle=function(t,r,e){return bt.setAxisAngle(t._array,r._array,e),t._dirty=!0,t},Pt.normalize=function(t,r){return bt.normalize(t._array,r._array),t._dirty=!0,t},Pt.sqrLen=function(t){return bt.sqrLen(t._array)},Pt.squaredLength=Pt.sqrLen,Pt.fromMat3=function(t,r){return bt.fromMat3(t._array,r._array),t._dirty=!0,t},Pt.setAxes=function(t,r,e,i){return bt.setAxes(t._array,r._array,e._array,i._array),t._dirty=!0,t},Pt.rotationTo=function(t,r,e){return bt.rotationTo(t._array,r._array,e._array),t._dirty=!0,t},Pt.fromEuler=function(t,r,e){t._dirty=!0,r=r._array;var i=t._array,n=Math.cos(r[0]/2),a=Math.cos(r[1]/2),s=Math.cos(r[2]/2),o=Math.sin(r[0]/2),u=Math.sin(r[1]/2),h=Math.sin(r[2]/2);switch(e=(e||"XYZ").toUpperCase()){case"XYZ":i[0]=o*a*s+n*u*h,i[1]=n*u*s-o*a*h,i[2]=n*a*h+o*u*s,i[3]=n*a*s-o*u*h;break;case"YXZ":i[0]=o*a*s+n*u*h,i[1]=n*u*s-o*a*h,i[2]=n*a*h-o*u*s,i[3]=n*a*s+o*u*h;break;case"ZXY":i[0]=o*a*s-n*u*h,i[1]=n*u*s+o*a*h,i[2]=n*a*h+o*u*s,i[3]=n*a*s-o*u*h;break;case"ZYX":i[0]=o*a*s-n*u*h,i[1]=n*u*s+o*a*h,i[2]=n*a*h-o*u*s,i[3]=n*a*s+o*u*h;break;case"YZX":i[0]=o*a*s+n*u*h,i[1]=n*u*s+o*a*h,i[2]=n*a*h-o*u*s,i[3]=n*a*s-o*u*h;break;case"XZY":i[0]=o*a*s-n*u*h,i[1]=n*u*s-o*a*h,i[2]=n*a*h+o*u*s,i[3]=n*a*s+o*u*h}};var Ct=D.mat4,Dt=0,Ut=M.extend({name:"",position:null,rotation:null,scale:null,worldTransform:null,localTransform:null,autoUpdateLocalTransform:!0,_parent:null,_scene:null,_needsUpdateWorldTransform:!0,_inIterating:!1,__depth:0},function(){this.name||(this.name=(this.type||"NODE")+"_"+Dt++),this.position||(this.position=new B),this.rotation||(this.rotation=new Pt),this.scale||(this.scale=new B(1,1,1)),this.worldTransform=new K,this.localTransform=new K,this._children=[]},{target:null,invisible:!1,isSkinnedMesh:function(){return!1},isRenderable:function(){return!1},setName:function(t){var r=this._scene;if(r){var e=r._nodeRepository;delete e[this.name],e[t]=this}this.name=t},add:function(t){this._inIterating&&console.warn("Add operation can cause unpredictable error when in iterating");var r=t._parent;if(r!==this){r&&r.remove(t),t._parent=this,this._children.push(t);var e=this._scene;e&&e!==t.scene&&t.traverse(this._addSelfToScene,this),t._needsUpdateWorldTransform=!0}},remove:function(t){this._inIterating&&console.warn("Remove operation can cause unpredictable error when in iterating");var r=this._children,e=r.indexOf(t);e<0||(r.splice(e,1),t._parent=null,this._scene&&t.traverse(this._removeSelfFromScene,this))},removeAll:function(){for(var t=this._children,r=0;r<t.length;r++)t[r]._parent=null,this._scene&&t[r].traverse(this._removeSelfFromScene,this);this._children=[]},getScene:function(){return this._scene},getParent:function(){return this._parent},_removeSelfFromScene:function(t){t._scene.removeFromScene(t),t._scene=null},_addSelfToScene:function(t){this._scene.addToScene(t),t._scene=this._scene},isAncestor:function(t){for(var r=t._parent;r;){if(r===this)return!0;r=r._parent}return!1},children:function(){return this._children.slice()},childAt:function(t){return this._children[t]},getChildByName:function(t){for(var r=this._children,e=0;e<r.length;e++)if(r[e].name===t)return r[e]},getDescendantByName:function(t){for(var r=this._children,e=0;e<r.length;e++){var i=r[e];if(i.name===t)return i;var n=i.getDescendantByName(t);if(n)return n}},queryNode:function(t){if(t){for(var r=t.split("/"),e=this,i=0;i<r.length;i++){var n=r[i];if(n){for(var a=!1,s=e._children,o=0;o<s.length;o++){var u=s[o];if(u.name===n){e=u,a=!0;break}}if(!a)return}}return e}},getPath:function(t){if(!this._parent)return"/";for(var r=this._parent,e=this.name;r._parent&&(e=r.name+"/"+e,r._parent!=t);)r=r._parent;return!r._parent&&t?null:e},traverse:function(t,r,e){this._inIterating=!0,e&&!e.call(r,this)||t.call(r,this);for(var i=this._children,n=0,a=i.length;n<a;n++)i[n].traverse(t,r,e);this._inIterating=!1},eachChild:function(t,r,e){this._inIterating=!0;for(var i=this._children,n=null==e,a=0,s=i.length;a<s;a++){var o=i[a];(n||o.constructor===e)&&t.call(r,o,a)}this._inIterating=!1},setLocalTransform:function(t){Ct.copy(this.localTransform._array,t._array),this.decomposeLocalTransform()},decomposeLocalTransform:function(t){var r=t?null:this.scale;this.localTransform.decomposeMatrix(r,this.rotation,this.position)},setWorldTransform:function(t){Ct.copy(this.worldTransform._array,t._array),this.decomposeWorldTransform()},decomposeWorldTransform:function(){var t=Ct.create();return function(r){var e=this.localTransform,i=this.worldTransform;this._parent?(Ct.invert(t,this._parent.worldTransform._array),Ct.multiply(e._array,t,i._array)):Ct.copy(e._array,i._array);var n=r?null:this.scale;e.decomposeMatrix(n,this.rotation,this.position)}}(),transformNeedsUpdate:function(){return this.position._dirty||this.rotation._dirty||this.scale._dirty},updateLocalTransform:function(){var t=this.position,r=this.rotation,e=this.scale;if(this.transformNeedsUpdate()){var i=this.localTransform._array;Ct.fromRotationTranslation(i,r._array,t._array),Ct.scale(i,i,e._array),r._dirty=!1,e._dirty=!1,t._dirty=!1,this._needsUpdateWorldTransform=!0}},_updateWorldTransformTopDown:function(){var t=this.localTransform._array,r=this.worldTransform._array;this._parent?Ct.multiplyAffine(r,this._parent.worldTransform._array,t):Ct.copy(r,t)},updateWorldTransform:function(){for(var t=this;t&&t.getParent()&&t.getParent().transformNeedsUpdate();)t=t.getParent();t.update()},update:function(t){this.autoUpdateLocalTransform?this.updateLocalTransform():t=!0,(t||this._needsUpdateWorldTransform)&&(this._updateWorldTransformTopDown(),t=!0,this._needsUpdateWorldTransform=!1);for(var r=this._children,e=0,i=r.length;e<i;e++)r[e].update(t)},getBoundingBox:function(){function t(t){return!t.invisible&&t.geometry}var r=new z,e=new K,i=new K;return function(n,a){return a=a||new z,n=n||t,this._parent?K.invert(i,this._parent.worldTransform):K.identity(i),this.traverse(function(t){t.geometry&&t.geometry.boundingBox&&(r.copy(t.geometry.boundingBox),K.multiply(e,i,t.worldTransform),r.applyTransform(e),a.union(r))},this,t),a}}(),getWorldPosition:function(t){this.transformNeedsUpdate()&&this.updateWorldTransform();var r=this.worldTransform._array;if(t){var e=t._array;return e[0]=r[12],e[1]=r[13],e[2]=r[14],t}return new B(r[12],r[13],r[14])},clone:function(){var t=new this.constructor,r=this._children;t.setName(this.name),t.position.copy(this.position),t.rotation.copy(this.rotation),t.scale.copy(this.scale);for(var e=0;e<r.length;e++)t.add(r[e].clone());return t},rotateAround:function(){var t=new B,r=new K;return function(e,i,n){t.copy(this.position).subtract(e);var a=this.localTransform;a.identity(),a.translate(e),a.rotate(n,i),r.fromRotationTranslation(this.rotation,t),a.multiply(r),a.scale(this.scale),this.decomposeLocalTransform(),this._needsUpdateWorldTransform=!0}}(),lookAt:function(){var t=new K;return function(r,e){t.lookAt(this.position,r,e||this.localTransform.y).invert(),this.setLocalTransform(t),this.target=r}}()}),Bt=D.vec3,Ft=D.mat4,Vt=D.vec4,Wt=function(t,r){this.normal=t||new B(0,1,0),this.distance=r||0};Wt.prototype={constructor:Wt,distanceToPoint:function(t){return Bt.dot(t._array,this.normal._array)-this.distance},projectPoint:function(t,r){r||(r=new B);var e=this.distanceToPoint(t);return Bt.scaleAndAdd(r._array,t._array,this.normal._array,-e),r._dirty=!0,r},normalize:function(){var t=1/Bt.len(this.normal._array);Bt.scale(this.normal._array,t),this.distance*=t},intersectFrustum:function(t){for(var r=t.vertices,e=this.normal._array,i=Bt.dot(r[0]._array,e)>this.distance,n=1;n<8;n++)if(Bt.dot(r[n]._array,e)>this.distance!=i)return!0},intersectLine:function(){var t=Bt.create();return function(r,e,i){var n=this.distanceToPoint(r),a=this.distanceToPoint(e);if(n>0&&a>0||n<0&&a<0)return null;var s=this.normal._array,o=this.distance,u=r._array;Bt.sub(t,e._array,r._array),Bt.normalize(t,t);var h=Bt.dot(s,t);if(0===h)return null;i||(i=new B);var c=(Bt.dot(s,u)-o)/h;return Bt.scaleAndAdd(i._array,u,t,-c),i._dirty=!0,i}}(),applyTransform:function(){var t=Ft.create(),r=Vt.create(),e=Vt.create();return e[3]=1,function(i){i=i._array,Bt.scale(e,this.normal._array,this.distance),Vt.transformMat4(e,e,i),this.distance=Bt.dot(e,this.normal._array),Ft.invert(t,i),Ft.transpose(t,t),r[3]=0,Bt.copy(r,this.normal._array),Vt.transformMat4(r,r,t),Bt.copy(this.normal._array,r)}}(),copy:function(t){Bt.copy(this.normal._array,t.normal._array),this.normal._dirty=!0,this.distance=t.distance},clone:function(){var t=new Wt;return t.copy(this),t}};var Xt=D.vec3,Gt=Xt.set,kt=Xt.copy,Ht=Xt.transformMat4,qt=Math.min,zt=Math.max,jt=function(){this.planes=[];for(t=0;t<6;t++)this.planes.push(new Wt);this.boundingBox=new z,this.vertices=[];for(var t=0;t<8;t++)this.vertices[t]=Xt.fromValues(0,0,0)};jt.prototype={setFromProjection:function(t){var r=this.planes,e=t._array,i=e[0],n=e[1],a=e[2],s=e[3],o=e[4],u=e[5],h=e[6],c=e[7],_=e[8],l=e[9],f=e[10],d=e[11],m=e[12],y=e[13],p=e[14],v=e[15];Gt(r[0].normal._array,s-i,c-o,d-_),r[0].distance=-(v-m),r[0].normalize(),Gt(r[1].normal._array,s+i,c+o,d+_),r[1].distance=-(v+m),r[1].normalize(),Gt(r[2].normal._array,s+n,c+u,d+l),r[2].distance=-(v+y),r[2].normalize(),Gt(r[3].normal._array,s-n,c-u,d-l),r[3].distance=-(v-y),r[3].normalize(),Gt(r[4].normal._array,s-a,c-h,d-f),r[4].distance=-(v-p),r[4].normalize(),Gt(r[5].normal._array,s+a,c+h,d+f),r[5].distance=-(v+p),r[5].normalize();var E=this.boundingBox;if(0===v){var T=u/i,g=-p/(f-1),A=-p/(f+1),R=-A/u,S=-g/u;E.min.set(-R*T,-R,A),E.max.set(R*T,R,g);L=this.vertices;Gt(L[0],-R*T,-R,A),Gt(L[1],-R*T,R,A),Gt(L[2],R*T,-R,A),Gt(L[3],R*T,R,A),Gt(L[4],-S*T,-S,g),Gt(L[5],-S*T,S,g),Gt(L[6],S*T,-S,g),Gt(L[7],S*T,S,g)}else{var I=(-1-m)/i,N=(1-m)/i,x=(1-y)/u,M=(-1-y)/u,O=(-1-p)/f,b=(1-p)/f;E.min.set(Math.min(I,N),Math.min(M,x),Math.min(b,O)),E.max.set(Math.max(N,I),Math.max(x,M),Math.max(O,b));var P=E.min._array,w=E.max._array,L=this.vertices;Gt(L[0],P[0],P[1],P[2]),Gt(L[1],P[0],w[1],P[2]),Gt(L[2],w[0],P[1],P[2]),Gt(L[3],w[0],w[1],P[2]),Gt(L[4],P[0],P[1],w[2]),Gt(L[5],P[0],w[1],w[2]),Gt(L[6],w[0],P[1],w[2]),Gt(L[7],w[0],w[1],w[2])}},getTransformedBoundingBox:function(){var t=Xt.create();return function(r,e){var i=this.vertices,n=e._array,a=r.min,s=r.max,o=a._array,u=s._array,h=i[0];Ht(t,h,n),kt(o,t),kt(u,t);for(var c=1;c<8;c++)h=i[c],Ht(t,h,n),o[0]=qt(t[0],o[0]),o[1]=qt(t[1],o[1]),o[2]=qt(t[2],o[2]),u[0]=zt(t[0],u[0]),u[1]=zt(t[1],u[1]),u[2]=zt(t[2],u[2]);return a._dirty=!0,s._dirty=!0,r}}()};var Yt=D.vec3,Zt=function(t,r){this.origin=t||new B,this.direction=r||new B};Zt.prototype={constructor:Zt,intersectPlane:function(t,r){var e=t.normal._array,i=t.distance,n=this.origin._array,a=this.direction._array,s=Yt.dot(e,a);if(0===s)return null;r||(r=new B);var o=(Yt.dot(e,n)-i)/s;return Yt.scaleAndAdd(r._array,n,a,-o),r._dirty=!0,r},mirrorAgainstPlane:function(t){var r=Yt.dot(t.normal._array,this.direction._array);Yt.scaleAndAdd(this.direction._array,this.direction._array,t.normal._array,2*-r),this.direction._dirty=!0},distanceToPoint:function(){var t=Yt.create();return function(r){Yt.sub(t,r,this.origin._array);var e=Yt.dot(t,this.direction._array);if(e<0)return Yt.distance(this.origin._array,r);var i=Yt.lenSquared(t);return Math.sqrt(i-e*e)}}(),intersectSphere:function(){var t=Yt.create();return function(r,e,i){var n=this.origin._array,a=this.direction._array;r=r._array,Yt.sub(t,r,n);var s=Yt.dot(t,a),o=Yt.squaredLength(t)-s*s,u=e*e;if(!(o>u)){var h=Math.sqrt(u-o),c=s-h,_=s+h;return i||(i=new B),c<0?_<0?null:(Yt.scaleAndAdd(i._array,n,a,_),i):(Yt.scaleAndAdd(i._array,n,a,c),i)}}}(),intersectBoundingBox:function(t,r){var e,i,n,a,s,o,u=this.direction._array,h=this.origin._array,c=t.min._array,_=t.max._array,l=1/u[0],f=1/u[1],d=1/u[2];if(l>=0?(e=(c[0]-h[0])*l,i=(_[0]-h[0])*l):(i=(c[0]-h[0])*l,e=(_[0]-h[0])*l),f>=0?(n=(c[1]-h[1])*f,a=(_[1]-h[1])*f):(a=(c[1]-h[1])*f,n=(_[1]-h[1])*f),e>a||n>i)return null;if((n>e||e!==e)&&(e=n),(a<i||i!==i)&&(i=a),d>=0?(s=(c[2]-h[2])*d,o=(_[2]-h[2])*d):(o=(c[2]-h[2])*d,s=(_[2]-h[2])*d),e>o||s>i)return null;if((s>e||e!==e)&&(e=s),(o<i||i!==i)&&(i=o),i<0)return null;var m=e>=0?e:i;return r||(r=new B),Yt.scaleAndAdd(r._array,h,u,m),r},intersectTriangle:function(){var t=Yt.create(),r=Yt.create(),e=Yt.create(),i=Yt.create();return function(n,a,s,o,u,h){var c=this.direction._array,_=this.origin._array;n=n._array,a=a._array,s=s._array,Yt.sub(t,a,n),Yt.sub(r,s,n),Yt.cross(i,r,c);var l=Yt.dot(t,i);if(o){if(l>-1e-5)return null}else if(l>-1e-5&&l<1e-5)return null;Yt.sub(e,_,n);var f=Yt.dot(i,e)/l;if(f<0||f>1)return null;Yt.cross(i,t,e);var d=Yt.dot(c,i)/l;if(d<0||d>1||f+d>1)return null;Yt.cross(i,t,r);var m=-Yt.dot(e,i)/l;return m<0?null:(u||(u=new B),h&&B.set(h,1-f-d,f,d),Yt.scaleAndAdd(u._array,_,c,m),u)}}(),applyTransform:function(t){B.add(this.direction,this.direction,this.origin),B.transformMat4(this.origin,this.origin,t),B.transformMat4(this.direction,this.direction,t),B.sub(this.direction,this.direction,this.origin),B.normalize(this.direction,this.direction)},copy:function(t){B.copy(this.origin,t.origin),B.copy(this.direction,t.direction)},clone:function(){var t=new Zt;return t.copy(this),t}};var Jt=D.vec3,Kt=D.vec4,Qt=Ut.extend(function(){return{projectionMatrix:new K,invProjectionMatrix:new K,viewMatrix:new K,frustum:new jt}},function(){this.update(!0)},{update:function(t){Ut.prototype.update.call(this,t),K.invert(this.viewMatrix,this.worldTransform),this.updateProjectionMatrix(),K.invert(this.invProjectionMatrix,this.projectionMatrix),this.frustum.setFromProjection(this.projectionMatrix)},setViewMatrix:function(t){K.copy(this.viewMatrix,t),K.invert(this.worldTransform,t),this.decomposeWorldTransform()},decomposeProjectionMatrix:function(){},setProjectionMatrix:function(t){K.copy(this.projectionMatrix,t),K.invert(this.invProjectionMatrix,t),this.decomposeProjectionMatrix()},updateProjectionMatrix:function(){},castRay:function(){var t=Kt.create();return function(r,e){var i=void 0!==e?e:new Zt,n=r._array[0],a=r._array[1];return Kt.set(t,n,a,-1,1),Kt.transformMat4(t,t,this.invProjectionMatrix._array),Kt.transformMat4(t,t,this.worldTransform._array),Jt.scale(i.origin._array,t,1/t[3]),Kt.set(t,n,a,1,1),Kt.transformMat4(t,t,this.invProjectionMatrix._array),Kt.transformMat4(t,t,this.worldTransform._array),Jt.scale(t,t,1/t[3]),Jt.sub(i.direction._array,t,i.origin._array),Jt.normalize(i.direction._array,i.direction._array),i.direction._dirty=!0,i.origin._dirty=!0,i}}()}),$t=Qt.extend({fov:50,aspect:1,near:.1,far:2e3},{updateProjectionMatrix:function(){var t=this.fov/180*Math.PI;this.projectionMatrix.perspective(t,this.aspect,this.near,this.far)},decomposeProjectionMatrix:function(){var t=this.projectionMatrix._array,r=2*Math.atan(1/t[5]);this.fov=r/Math.PI*180,this.aspect=t[5]/t[0],this.near=t[14]/(t[10]-1),this.far=t[14]/(t[10]+1)},clone:function(){var t=Qt.prototype.clone.call(this);return t.fov=this.fov,t.aspect=this.aspect,t.near=this.near,t.far=this.far,t}}),tr=Ut.extend(function(){return{color:[1,1,1],intensity:1,castShadow:!0,shadowResolution:512,group:0}},{type:"",clone:function(){var t=Ut.prototype.clone.call(this);return t.color=Array.prototype.slice.call(this.color),t.intensity=this.intensity,t.castShadow=this.castShadow,t.shadowResolution=this.shadowResolution,t}}),rr=Ut.extend(function(){return{material:null,autoUpdate:!0,opaqueQueue:[],transparentQueue:[],lights:[],viewBoundingBoxLastFrame:new z,_lightUniforms:{},_lightNumber:{},_opaqueObjectCount:0,_transparentObjectCount:0,_nodeRepository:{}}},function(){this._scene=this},{addToScene:function(t){t.name&&(this._nodeRepository[t.name]=t)},removeFromScene:function(t){t.name&&delete this._nodeRepository[t.name]},getNode:function(t){return this._nodeRepository[t]},cloneNode:function(t){var r=t.clone(),e={},i=function(n,a){n.skeleton&&(a.skeleton=n.skeleton.clone(t,r),a.joints=n.joints.slice()),n.material&&(e[n.material.__GUID__]={oldMat:n.material});for(var s=0;s<n._children.length;s++)i(n._children[s],a._children[s])};i(t,r);for(var n in e)e[n].newMat=e[n].oldMat.clone();return r.traverse(function(t){t.material&&(t.material=e[t.material.__GUID__].newMat)}),r},update:function(t,r){if(this.autoUpdate||t){Ut.prototype.update.call(this,t);var e=this.lights,i=this.material&&this.material.transparent;if(this._opaqueObjectCount=0,this._transparentObjectCount=0,e.length=0,this._updateRenderQueue(this,i),this.opaqueQueue.length=this._opaqueObjectCount,this.transparentQueue.length=this._transparentObjectCount,!r){var n=this._lightNumber;for(var a in n)for(var s in n[a])n[a][s]=0;for(var o=0;o<e.length;o++){var u=e[o];n[a=u.group]||(n[a]={}),n[a][u.type]=n[a][u.type]||0,n[a][u.type]++}this._updateLightUniforms()}}},_updateRenderQueue:function(t,r){if(!t.invisible)for(var e=0;e<t._children.length;e++){var i=t._children[e];i instanceof tr&&this.lights.push(i),i.isRenderable()&&(i.material.transparent||r?this.transparentQueue[this._transparentObjectCount++]=i:this.opaqueQueue[this._opaqueObjectCount++]=i),i._children.length>0&&this._updateRenderQueue(i)}},_updateLightUniforms:function(){var t=this.lights;t.sort(h);var r=this._lightUniforms;for(var e in r)for(var i in r[e])r[e][i].value.length=0;for(var n=0;n<t.length;n++){var a=t[n],e=a.group;for(var i in a.uniformTemplates){var s=a.uniformTemplates[i];r[e]||(r[e]={}),r[e][i]||(r[e][i]={type:"",value:[]});var o=s.value(a),u=r[e][i];switch(u.type=s.type+"v",s.type){case"1i":case"1f":case"t":u.value.push(o);break;case"2f":case"3f":case"4f":for(var c=0;c<o.length;c++)u.value.push(o[c]);break;default:console.error("Unkown light uniform type "+s.type)}}}},isShaderLightNumberChanged:function(t){var r=t.lightGroup;for(var e in this._lightNumber[r])if(this._lightNumber[r][e]!==t.lightNumber[e])return!0;for(var e in t.lightNumber)if(this._lightNumber[r][e]!==t.lightNumber[e])return!0;return!1},setShaderLightNumber:function(t){var r=t.lightGroup;for(var e in this._lightNumber[r])t.lightNumber[e]=this._lightNumber[r][e];t.dirty()},setLightUniforms:function(t,r){var e=t.lightGroup;for(var i in this._lightUniforms[e]){var n=this._lightUniforms[e][i];if("tv"===n.type)for(var a=0;a<n.value.length;a++){var s=n.value[a],o=t.currentTextureSlot();t.setUniform(r.gl,"1i",i,o)&&t.takeCurrentTextureSlot(r,s)}else t.setUniform(r.gl,n.type,i,n.value)}},dispose:function(){this.material=null,this.opaqueQueue=[],this.transparentQueue=[],this.lights=[],this._lightUniforms={},this._lightNumber={},this._nodeRepository={}}}),er={};er.isPowerOfTwo=function(t){return 0==(t&t-1)},er.nextPowerOfTwo=function(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t},er.nearestPowerOfTwo=function(t){return Math.pow(2,Math.round(Math.log(t)/Math.LN2))};var ir=er.isPowerOfTwo,nr=["px","nx","py","ny","pz","nz"],ar=pt.extend(function(){return{image:{px:null,nx:null,py:null,ny:null,pz:null,nz:null},pixels:{px:null,nx:null,py:null,ny:null,pz:null,nz:null},mipmaps:[]}},{update:function(t){var r=t.gl;r.bindTexture(r.TEXTURE_CUBE_MAP,this._cache.get("webgl_texture")),this.updateCommon(t);var e=this.format,i=this.type;r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_S,this.getAvailableWrapS()),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_T,this.getAvailableWrapT()),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAG_FILTER,this.getAvailableMagFilter()),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MIN_FILTER,this.getAvailableMinFilter());var n=t.getGLExtension("EXT_texture_filter_anisotropic");if(n&&this.anisotropic>1&&r.texParameterf(r.TEXTURE_CUBE_MAP,n.TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropic),36193===i&&(t.getGLExtension("OES_texture_half_float")||(i=P.FLOAT)),this.mipmaps.length)for(var a=this.width,s=this.height,o=0;o<this.mipmaps.length;o++){var u=this.mipmaps[o];this._updateTextureData(r,u,o,a,s,e,i),a/=2,s/=2}else this._updateTextureData(r,this,0,this.width,this.height,e,i),!this.NPOT&&this.useMipmap&&r.generateMipmap(r.TEXTURE_CUBE_MAP);r.bindTexture(r.TEXTURE_CUBE_MAP,null)},_updateTextureData:function(t,r,e,i,n,a,s){for(var o=0;o<6;o++){var u=nr[o],h=r.image&&r.image[u];h?t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+o,e,a,a,s,h):t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+o,e,a,i,n,0,a,s,r.pixels&&r.pixels[u])}},generateMipmap:function(t){var r=t.gl;this.useMipmap&&!this.NPOT&&(r.bindTexture(r.TEXTURE_CUBE_MAP,this._cache.get("webgl_texture")),r.generateMipmap(r.TEXTURE_CUBE_MAP))},bind:function(t){t.gl.bindTexture(t.gl.TEXTURE_CUBE_MAP,this.getWebGLTexture(t))},unbind:function(t){t.gl.bindTexture(t.gl.TEXTURE_CUBE_MAP,null)},isPowerOfTwo:function(){return this.image.px?ir(this.image.px.width)&&ir(this.image.px.height):ir(this.width)&&ir(this.height)},isRenderable:function(){return this.image.px?c(this.image.px)&&c(this.image.nx)&&c(this.image.py)&&c(this.image.ny)&&c(this.image.pz)&&c(this.image.nz):!(!this.width||!this.height)},load:function(t,r){var e=0,i=this;return x.each(t,function(t,n){var a=new Image;r&&(a.crossOrigin=r),a.onload=function(){0===--e&&(i.dirty(),i.trigger("success",i)),a.onload=null},a.onerror=function(){e--,a.onerror=null},e++,a.src=t,i.image[n]=a}),this}});Object.defineProperty(ar.prototype,"width",{get:function(){return this.image&&this.image.px?this.image.px.width:this._width},set:function(t){this.image&&this.image.px?console.warn("Texture from image can't set width"):(this._width!==t&&this.dirty(),this._width=t)}}),Object.defineProperty(ar.prototype,"height",{get:function(){return this.image&&this.image.px?this.image.px.height:this._height},set:function(t){this.image&&this.image.px?console.warn("Texture from image can't set height"):(this._height!==t&&this.dirty(),this._height=t)}});var sr=er.isPowerOfTwo,or=pt.extend(function(){return{image:null,pixels:null,mipmaps:[]}},{update:function(t){var r=t.gl;r.bindTexture(r.TEXTURE_2D,this._cache.get("webgl_texture")),this.updateCommon(t);var e=this.format,i=this.type;r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,this.getAvailableWrapS()),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,this.getAvailableWrapT()),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,this.getAvailableMagFilter()),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this.getAvailableMinFilter());var n=t.getGLExtension("EXT_texture_filter_anisotropic");if(n&&this.anisotropic>1&&r.texParameterf(r.TEXTURE_2D,n.TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropic),36193===i&&(t.getGLExtension("OES_texture_half_float")||(i=P.FLOAT)),this.mipmaps.length)for(var a=this.width,s=this.height,o=0;o<this.mipmaps.length;o++){var u=this.mipmaps[o];this._updateTextureData(r,u,o,a,s,e,i),a/=2,s/=2}else this._updateTextureData(r,this,0,this.width,this.height,e,i),this.useMipmap&&!this.NPOT&&r.generateMipmap(r.TEXTURE_2D);r.bindTexture(r.TEXTURE_2D,null)},_updateTextureData:function(t,r,e,i,n,a,s){r.image?t.texImage2D(t.TEXTURE_2D,e,a,a,s,r.image):a<=pt.COMPRESSED_RGBA_S3TC_DXT5_EXT&&a>=pt.COMPRESSED_RGB_S3TC_DXT1_EXT?t.compressedTexImage2D(t.TEXTURE_2D,e,a,i,n,0,r.pixels):t.texImage2D(t.TEXTURE_2D,e,a,i,n,0,a,s,r.pixels)},generateMipmap:function(t){var r=t.gl;this.useMipmap&&!this.NPOT&&(r.bindTexture(r.TEXTURE_2D,this._cache.get("webgl_texture")),r.generateMipmap(r.TEXTURE_2D))},isPowerOfTwo:function(){var t,r;return this.image?(t=this.image.width,r=this.image.height):(t=this.width,r=this.height),sr(t)&&sr(r)},isRenderable:function(){return this.image?"CANVAS"===this.image.nodeName||"VIDEO"===this.image.nodeName||this.image.complete:!(!this.width||!this.height)},bind:function(t){t.gl.bindTexture(t.gl.TEXTURE_2D,this.getWebGLTexture(t))},unbind:function(t){t.gl.bindTexture(t.gl.TEXTURE_2D,null)},load:function(t,r){var e=new Image;r&&(e.crossOrigin=r);var i=this;return e.onload=function(){i.dirty(),i.trigger("success",i),e.onload=null},e.onerror=function(){i.trigger("error",i),e.onerror=null},e.src=t,this.image=e,this}});Object.defineProperty(or.prototype,"width",{get:function(){return this.image?this.image.width:this._width},set:function(t){this.image?console.warn("Texture from image can't set width"):(this._width!==t&&this.dirty(),this._width=t)}}),Object.defineProperty(or.prototype,"height",{get:function(){return this.image?this.image.height:this._height},set:function(t){this.image?console.warn("Texture from image can't set height"):(this._height!==t&&this.dirty(),this._height=t)}});var ur=function(){this._track=[]};ur.prototype={constructor:ur,recognize:function(t,r,e){return this._doTrack(t,r,e),this._recognize(t)},clear:function(){return this._track.length=0,this},_doTrack:function(t,r,e){var i=t.targetTouches;if(i){for(var n={points:[],touches:[],target:r,event:t},a=0,s=i.length;a<s;a++){var o=i[a];n.points.push([o.clientX,o.clientY]),n.touches.push(o)}this._track.push(n)}},_recognize:function(t){for(var r in hr)if(hr.hasOwnProperty(r)){var e=hr[r](this._track,t);if(e)return e}}};var hr={pinch:function(t,r){var e=t.length;if(e){var i=(t[e-1]||{}).points,n=(t[e-2]||{}).points||i;if(n&&n.length>1&&i&&i.length>1){var a=_(i)/_(n);!isFinite(a)&&(a=1),r.pinchScale=a;var s=l(i);return r.pinchX=s[0],r.pinchY=s[1],{type:"pinch",target:t[0].target,event:r}}}}},cr=M.extend(function(){return{animation:null,domElement:null,target:null,_center:new B,minDistance:.1,maxDistance:1e3,minAlpha:-90,maxAlpha:90,minBeta:-1/0,maxBeta:1/0,autoRotateAfterStill:0,autoRotateDirection:"cw",autoRotateSpeed:60,_mode:"rotate",damping:.8,rotateSensitivity:1,zoomSensitivity:1,panSensitivity:1,_needsUpdate:!1,_rotating:!1,_phi:0,_theta:0,_mouseX:0,_mouseY:0,_rotateVelocity:new Tt,_panVelocity:new Tt,_distance:20,_zoomSpeed:0,_stillTimeout:0,_animators:[],_gestureMgr:new ur}},function(){this._mouseDownHandler=this._mouseDownHandler.bind(this),this._mouseWheelHandler=this._mouseWheelHandler.bind(this),this._mouseMoveHandler=this._mouseMoveHandler.bind(this),this._mouseUpHandler=this._mouseUpHandler.bind(this),this._pinchHandler=this._pinchHandler.bind(this),this.update=this.update.bind(this),this.init()},{init:function(){var t=this.domElement;t.addEventListener("touchstart",this._mouseDownHandler),t.addEventListener("mousedown",this._mouseDownHandler),t.addEventListener("mousewheel",this._mouseWheelHandler),this.animation&&this.animation.on("frame",this.update)},dispose:function(){var t=this.domElement;t.removeEventListener("touchstart",this._mouseDownHandler),t.removeEventListener("touchmove",this._mouseMoveHandler),t.removeEventListener("touchend",this._mouseUpHandler),t.removeEventListener("mousedown",this._mouseDownHandler),t.removeEventListener("mousemove",this._mouseMoveHandler),t.removeEventListener("mouseup",this._mouseUpHandler),t.removeEventListener("mousewheel",this._mouseWheelHandler),this.animation&&this.animation.off("frame",this.update),this.stopAllAnimation()},getDistance:function(){return this._distance},setDistance:function(t){this._distance=t,this._needsUpdate=!0},getAlpha:function(){return this._theta/Math.PI*180},getBeta:function(){return-this._phi/Math.PI*180},getCenter:function(){return this._center.toArray()},setAlpha:function(t){t=Math.max(Math.min(this.maxAlpha,t),this.minAlpha),this._theta=t/180*Math.PI,this._needsUpdate=!0},setBeta:function(t){t=Math.max(Math.min(this.maxBeta,t),this.minBeta),this._phi=-t/180*Math.PI,this._needsUpdate=!0},setCenter:function(t){this._center.setArray(t)},setOption:function(t){t=t||{},["autoRotate","autoRotateAfterStill","autoRotateDirection","autoRotateSpeed","damping","minDistance","maxDistance","minAlpha","maxAlpha","minBeta","maxBeta","rotateSensitivity","zoomSensitivity","panSensitivity"].forEach(function(r){null!=t[r]&&(this[r]=t[r])},this),null!=t.distance&&this.setDistance(t.distance),null!=t.alpha&&this.setAlpha(t.alpha),null!=t.beta&&this.setBeta(t.beta),t.center&&this.setCenter(t.center)},animateTo:function(t){var r=this,e={},i={},n=this.animation;if(n)return null!=t.distance&&(e.distance=this.getDistance(),i.distance=t.distance),null!=t.alpha&&(e.alpha=this.getAlpha(),i.alpha=t.alpha),null!=t.beta&&(e.beta=this.getBeta(),i.beta=t.beta),null!=t.center&&(e.center=this.getCenter(),i.center=t.center),this._addAnimator(n.animate(e).when(t.duration||1e3,i).during(function(){null!=e.alpha&&r.setAlpha(e.alpha),null!=e.beta&&r.setBeta(e.beta),null!=e.distance&&r.setDistance(e.distance),null!=e.center&&r.setCenter(e.center),r._needsUpdate=!0}).done(t.done)).start(t.easing||"linear")},stopAllAnimation:function(){for(var t=0;t<this._animators.length;t++)this._animators[t].stop();this._animators.length=0},_isAnimating:function(){return this._animators.length>0},update:function(t){if(t=t||16,this._rotating){var r=("cw"===this.autoRotateDirection?1:-1)*this.autoRotateSpeed/180*Math.PI;this._phi-=r*t/1e3,this._needsUpdate=!0}else this._rotateVelocity.len()>0&&(this._needsUpdate=!0);(Math.abs(this._zoomSpeed)>.01||this._panVelocity.len()>0)&&(this._needsUpdate=!0),this._needsUpdate&&(this._updateDistance(Math.min(t,50)),this._updatePan(Math.min(t,50)),this._updateRotate(Math.min(t,50)),this._updateTransform(),this.target.update(),this.trigger("update"),this._needsUpdate=!1)},_updateRotate:function(t){var r=this._rotateVelocity;this._phi=r.y*t/20+this._phi,this._theta=r.x*t/20+this._theta,this.setAlpha(this.getAlpha()),this.setBeta(this.getBeta()),this._vectorDamping(r,this.damping)},_updateDistance:function(t){this._setDistance(this._distance+this._zoomSpeed*t/20),this._zoomSpeed*=this.damping},_setDistance:function(t){this._distance=Math.max(Math.min(t,this.maxDistance),this.minDistance)},_updatePan:function(t){var r=this._panVelocity,e=this._distance,i=this.target,n=i.worldTransform.y,a=i.worldTransform.x;this._center.scaleAndAdd(a,-r.x*e/200).scaleAndAdd(n,-r.y*e/200),this._vectorDamping(r,0)},_updateTransform:function(){var t=this.target,r=new B,e=this._theta+Math.PI/2,i=this._phi+Math.PI/2,n=Math.sin(e);r.x=n*Math.cos(i),r.y=-Math.cos(e),r.z=n*Math.sin(i),t.position.copy(this._center).scaleAndAdd(r,this._distance),t.rotation.identity().rotateY(-this._phi).rotateX(-this._theta)},_startCountingStill:function(){clearTimeout(this._stillTimeout);var t=this.autoRotateAfterStill,r=this;!isNaN(t)&&t>0&&(this._stillTimeout=setTimeout(function(){r._rotating=!0},1e3*t))},_vectorDamping:function(t,r){var e=t.len();(e*=r)<1e-4&&(e=0),t.normalize().scale(e)},decomposeTransform:function(){if(this.target){var t=new B;t.eulerFromQuat(this.target.rotation.normalize(),"ZYX"),this._theta=-t.x,this._phi=-t.y,this.setBeta(this.getBeta()),this.setAlpha(this.getAlpha()),this._setDistance(this.target.position.dist(this._center))}},_mouseDownHandler:function(t){if(!this._isAnimating()){var r=t.clientX,e=t.clientY;if(t.targetTouches){var i=t.targetTouches[0];r=i.clientX,e=i.clientY,this._mode="rotate",this._processGesture(t,"start")}var n=this.domElement;n.addEventListener("touchmove",this._mouseMoveHandler),n.addEventListener("touchend",this._mouseUpHandler),n.addEventListener("mousemove",this._mouseMoveHandler),n.addEventListener("mouseup",this._mouseUpHandler),0===t.button?this._mode="rotate":1===t.button&&(this._mode="pan"),this._rotateVelocity.set(0,0),this._rotating=!1,this.autoRotate&&this._startCountingStill(),this._mouseX=r,this._mouseY=e}},_mouseMoveHandler:function(t){if(!this._isAnimating()){var r,e=t.clientX,i=t.clientY;if(t.targetTouches){var n=t.targetTouches[0];e=n.clientX,i=n.clientY,r=this._processGesture(t,"change")}var a=f(this.panSensitivity),s=f(this.rotateSensitivity);r||("rotate"===this._mode?(this._rotateVelocity.y=(e-this._mouseX)/this.domElement.clientHeight*2*s[0],this._rotateVelocity.x=(i-this._mouseY)/this.domElement.clientWidth*2*s[1]):"pan"===this._mode&&(this._panVelocity.x=(e-this._mouseX)/this.domElement.clientWidth*a[0]*400,this._panVelocity.y=(-i+this._mouseY)/this.domElement.clientHeight*a[1]*400)),this._mouseX=e,this._mouseY=i,t.preventDefault()}},_mouseWheelHandler:function(t){if(!this._isAnimating()){var r=t.wheelDelta||-t.detail;0!==r&&this._zoomHandler(t,r>0?-1:1)}},_pinchHandler:function(t){this._isAnimating()||this._zoomHandler(t,t.pinchScale>1?-.4:.4)},_zoomHandler:function(t,r){var e=Math.max(Math.min(this._distance-this.minDistance,this.maxDistance-this._distance));this._zoomSpeed=r*Math.max(e/40*this.zoomSensitivity,.2),this._rotating=!1,this.autoRotate&&"rotate"===this._mode&&this._startCountingStill(),t.preventDefault()},_mouseUpHandler:function(t){var r=this.domElement;r.removeEventListener("touchmove",this._mouseMoveHandler),r.removeEventListener("touchend",this._mouseUpHandler),r.removeEventListener("mousemove",this._mouseMoveHandler),r.removeEventListener("mouseup",this._mouseUpHandler),this._processGesture(t,"end")},_addAnimator:function(t){var r=this._animators;return r.push(t),t.done(function(){var e=r.indexOf(t);e>=0&&r.splice(e,1)}),t},_processGesture:function(t,r){var e=this._gestureMgr;"start"===r&&e.clear();var i=e.recognize(t,null,this.domElement);if("end"===r&&e.clear(),i){var n=i.type;t.gestureEvent=n,this._pinchHandler(i.event)}return i}});Object.defineProperty(cr.prototype,"autoRotate",{get:function(){return this._autoRotate},set:function(t){this._autoRotate=t,this._rotating=t}}),Object.defineProperty(cr.prototype,"target",{get:function(){return this._target},set:function(t){t&&t.target&&this.setCenter(t.target.toArray()),this._target=t,this.decomposeTransform()}});var _r,lr=new Pt(-Math.sqrt(.5),0,0,Math.sqrt(.5)),fr=new Pt,dr=new B(0,0,1),mr=M.extend({domElement:null,target:null,alphaOffset:0},function(){this.init()},{init:function(){this.domElement&&(this._orientataionChange=this._orientataionChange.bind(this),this._deviceOrientationChange=this._deviceOrientationChange.bind(this),window.addEventListener("orientationchange",this._orientataionChange),window.addEventListener("deviceorientation",this._deviceOrientationChange),this._screenOrientation=window.orientation||0)},update:function(){var t=this.target;if(t&&this._deviceOrientation){var r=d(this._deviceOrientation.alpha||0)+this.alphaOffset,e=d(this._deviceOrientation.beta||0),i=d(this._deviceOrientation.gamma||0),n=d(this._screenOrientation||0),a=new B(e,r,-i);t.rotation.fromEuler(a,"YXZ"),t.rotation.multiply(lr),t.rotation.multiply(fr.setAxisAngle(dr,-n))}},_orientataionChange:function(t){this._screenOrientation=window.orientation||0},_deviceOrientationChange:function(t){this._deviceOrientation=t},dispose:function(){window.removeEventListener("orientationchange",this._orientataionChange),window.removeEventListener("deviceorientation",this._deviceOrientationChange)}}),yr=0,pr=null,vr=!0,Er=function(){this.triangleCount=0,this.vertexCount=0,this.drawCallCount=0},Tr=Ut.extend({material:null,geometry:null,mode:P.TRIANGLES,_drawCache:null,_renderInfo:null},function(){this._drawCache={},this._renderInfo=new Er},{renderOrder:0,lineWidth:1,culling:!0,cullFace:P.BACK,frontFace:P.CCW,frustumCulling:!0,receiveShadow:!0,castShadow:!0,ignorePicking:!1,ignorePreZ:!1,ignoreGBuffer:!1,isRenderable:function(){return this.geometry&&this.material&&!this.invisible&&this.geometry.vertexCount>0},beforeRender:function(t){},afterRender:function(t,r){},getBoundingBox:function(t,r){return r=Ut.prototype.getBoundingBox.call(this,t,r),this.geometry&&this.geometry.boundingBox&&r.union(this.geometry.boundingBox),r},render:function(t,r){var e=t.gl,r=r||this.material.shader,i=this.geometry,n=this.mode,a=i.vertexCount,s=i.isUseIndices(),o=t.getGLExtension("OES_element_index_uint"),u=o&&a>65535?e.UNSIGNED_INT:e.UNSIGNED_SHORT,h=t.getGLExtension("OES_vertex_array_object"),c=!i.dynamic,_=this._renderInfo;_.vertexCount=a,_.triangleCount=0,_.drawCallCount=0;var l=!1;if((_r=t.__GUID__+"-"+i.__GUID__+"-"+r.__GUID__)!==yr?l=!0:(a>65535&&!o&&s||h&&c||i._cache.isDirty())&&(l=!0),yr=_r,l){var f=this._drawCache[_r];if(!f){var d=i.getBufferChunks(t);if(!d)return;f=[];for(var y=0;y<d.length;y++){for(var p=d[y],v=p.attributeBuffers,E=p.indicesBuffer,T=[],g=[],A=0;A<v.length;A++){var R,S=(C=v[A]).name,I=C.semantic;if(I){var N=r.attribSemantics[I];R=N&&N.symbol}else R=S;R&&r.attributeTemplates[R]&&(T.push(C),g.push(R))}M=new m(T,g,E);f.push(M)}c&&(this._drawCache[_r]=f)}for(var x=0;x<f.length;x++){var M=f[x],O=!0;h&&c&&(null==M.vao?M.vao=h.createVertexArrayOES():O=!1,h.bindVertexArrayOES(M.vao));var T=M.availableAttributes,E=M.indicesBuffer;if(O)for(var b=r.enableAttributes(t,M.availableAttributeSymbols,h&&c&&M.vao),A=0;A<T.length;A++){var w=b[A];if(-1!==w){var L,C=T[A],D=C.buffer,U=C.size;switch(C.type){case"float":L=e.FLOAT;break;case"byte":L=e.BYTE;break;case"ubyte":L=e.UNSIGNED_BYTE;break;case"short":L=e.SHORT;break;case"ushort":L=e.UNSIGNED_SHORT;break;default:L=e.FLOAT}e.bindBuffer(e.ARRAY_BUFFER,D),e.vertexAttribPointer(w,U,L,!1,0,0)}}n!=P.LINES&&n!=P.LINE_STRIP&&n!=P.LINE_LOOP||e.lineWidth(this.lineWidth),pr=E,(vr=i.isUseIndices())?(O&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,E.buffer),e.drawElements(n,E.count,u,0),_.triangleCount+=E.count/3):e.drawArrays(n,0,a),h&&c&&h.bindVertexArrayOES(null),_.drawCallCount++}}else vr?(e.drawElements(n,pr.count,u,0),_.triangleCount=pr.count/3):e.drawArrays(n,0,a),_.drawCallCount=1;return _},clone:function(){var t=["castShadow","receiveShadow","mode","culling","cullFace","frontFace","frustumCulling","renderOrder","lineWidth","ignorePicking","ignorePreZ","ignoreGBuffer"];return function(){var r=Ut.prototype.clone.call(this);r.geometry=this.geometry,r.material=this.material;for(var e=0;e<t.length;e++){var i=t[e];r[i]!==this[i]&&(r[i]=this[i])}return r}}()});Tr.POINTS=P.POINTS,Tr.LINES=P.LINES,Tr.LINE_LOOP=P.LINE_LOOP,Tr.LINE_STRIP=P.LINE_STRIP,Tr.TRIANGLES=P.TRIANGLES,Tr.TRIANGLE_STRIP=P.TRIANGLE_STRIP,Tr.TRIANGLE_FAN=P.TRIANGLE_FAN,Tr.BACK=P.BACK,Tr.FRONT=P.FRONT,Tr.FRONT_AND_BACK=P.FRONT_AND_BACK,Tr.CW=P.CW,Tr.CCW=P.CCW,Tr.RenderInfo=Er;var gr=D.vec3,Ar=D.mat4,Rr=gr.create,Sr=gr.add,Ir=gr.set;v.prototype.init=function(t){if(!this.value||this.value.length!=t*this.size){var r=y(this.type);this.value=new r(t*this.size)}},v.prototype.fromArray=function(t){var r,e=y(this.type);if(t[0]&&t[0].length){var i=0,n=this.size;r=new e(t.length*n);for(var a=0;a<t.length;a++)for(var s=0;s<n;s++)r[i++]=t[a][s]}else r=new e(t);this.value=r},v.prototype.clone=function(t){var r=new v(this.name,this.type,this.size,this.semantic);return t&&console.warn("todo"),r};var Nr=M.extend(function(){return{attributes:{position:new v("position","float",3,"POSITION"),texcoord0:new v("texcoord0","float",2,"TEXCOORD_0"),texcoord1:new v("texcoord1","float",2,"TEXCOORD_1"),normal:new v("normal","float",3,"NORMAL"),tangent:new v("tangent","float",4,"TANGENT"),color:new v("color","float",4,"COLOR"),weight:new v("weight","float",3,"WEIGHT"),joint:new v("joint","float",4,"JOINT"),barycentric:new v("barycentric","float",3,null)},boundingBox:null,indices:null,dynamic:!0,_enabledAttributes:null}},function(){this._cache=new tt,this._attributeList=Object.keys(this.attributes)},{mainAttribute:"position",pick:null,pickByRay:null,updateBoundingBox:function(){var t=this.boundingBox;t||(t=this.boundingBox=new z);var r=this.attributes.position.value;if(r&&r.length){var e=t.min,i=t.max,n=e._array,a=i._array;gr.set(n,r[0],r[1],r[2]),gr.set(a,r[0],r[1],r[2]);for(var s=3;s<r.length;){var o=r[s++],u=r[s++],h=r[s++];o<n[0]&&(n[0]=o),u<n[1]&&(n[1]=u),h<n[2]&&(n[2]=h),o>a[0]&&(a[0]=o),u>a[1]&&(a[1]=u),h>a[2]&&(a[2]=h)}e._dirty=!0,i._dirty=!0}},dirty:function(){for(var t=this.getEnabledAttributes(),r=0;r<t.length;r++)this.dirtyAttribute(t[r]);this.dirtyIndices(),this._enabledAttributes=null},dirtyIndices:function(){this._cache.dirtyAll("indices")},dirtyAttribute:function(t){this._cache.dirtyAll(p(t)),this._cache.dirtyAll("attributes")},getTriangleIndices:function(t,r){if(t<this.triangleCount&&t>=0){r||(r=Rr());var e=this.indices;return r[0]=e[3*t],r[1]=e[3*t+1],r[2]=e[3*t+2],r}},setTriangleIndices:function(t,r){var e=this.indices;e[3*t]=r[0],e[3*t+1]=r[1],e[3*t+2]=r[2]},isUseIndices:function(){return!!this.indices},initIndicesFromArray:function(t){var r,e=this.vertexCount>65535?C.Uint32Array:C.Uint16Array;if(t[0]&&t[0].length){var i=0;r=new e(3*t.length);for(var n=0;n<t.length;n++)for(var a=0;a<3;a++)r[i++]=t[n][a]}else r=new e(t);this.indices=r},createAttribute:function(t,r,e,i){var n=new v(t,r,e,i);return this.attributes[t]&&this.removeAttribute(t),this.attributes[t]=n,this._attributeList.push(t),n},removeAttribute:function(t){var r=this._attributeList,e=r.indexOf(t);return e>=0&&(r.splice(e,1),delete this.attributes[t],!0)},getAttribute:function(t){return this.attribute[t]},getEnabledAttributes:function(){var t=this._enabledAttributes,r=this._attributeList;if(t)return t;for(var e=[],i=this.vertexCount,n=0;n<r.length;n++){var a=r[n],s=this.attributes[a];s.value&&s.value.length===i*s.size&&e.push(a)}return this._enabledAttributes=e,e},getBufferChunks:function(t){var r=this._cache;r.use(t.__GUID__);var e=r.isDirty("attributes"),i=r.isDirty("indices");if(e||i){this._updateBuffer(t.gl,e,i);for(var n=this.getEnabledAttributes(),a=0;a<n.length;a++)r.fresh(p(n[a]));r.fresh("attributes"),r.fresh("indices")}return r.get("chunks")},_updateBuffer:function(t,r,e){var i=this._cache,n=i.get("chunks"),a=!1;n||((n=[])[0]={attributeBuffers:[],indicesBuffer:null},i.put("chunks",n),a=!0);var s=n[0],o=s.attributeBuffers,u=s.indicesBuffer;if(r||a){var h=this.getEnabledAttributes(),c={};if(!a)for(y=0;y<o.length;y++)c[o[y].name]=o[y];for(var _=0;_<h.length;_++){var l,f=h[_],d=this.attributes[f];a||(l=c[f]);var m;m=l?l.buffer:t.createBuffer(),i.isDirty(p(f))&&(t.bindBuffer(t.ARRAY_BUFFER,m),t.bufferData(t.ARRAY_BUFFER,d.value,this.dynamic?P.DYNAMIC_DRAW:P.STATIC_DRAW)),o[_]=new E(f,d.type,m,d.size,d.semantic)}for(var y=_;y<o.length;y++)t.deleteBuffer(o[y].buffer);o.length=_}this.isUseIndices()&&(e||a)&&(u||(u=new T(t.createBuffer()),s.indicesBuffer=u),u.count=this.indices.length,t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,u.buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.indices,this.dynamic?P.DYNAMIC_DRAW:P.STATIC_DRAW))},generateVertexNormals:function(){if(this.vertexCount){var t=this.indices,r=this.attributes,e=r.position.value,i=r.normal.value;if(i&&i.length===e.length)for(m=0;m<i.length;m++)i[m]=0;else i=r.normal.value=new C.Float32Array(e.length);for(var n,a,s,o=Rr(),u=Rr(),h=Rr(),c=Rr(),_=Rr(),l=Rr(),f=t?t.length:this.vertexCount,d=0;d<f;){t?(n=t[d++],a=t[d++],s=t[d++]):(n=d++,a=d++,s=d++),Ir(o,e[3*n],e[3*n+1],e[3*n+2]),Ir(u,e[3*a],e[3*a+1],e[3*a+2]),Ir(h,e[3*s],e[3*s+1],e[3*s+2]),gr.sub(c,o,u),gr.sub(_,u,h),gr.cross(l,c,_);for(m=0;m<3;m++)i[3*n+m]=i[3*n+m]+l[m],i[3*a+m]=i[3*a+m]+l[m],i[3*s+m]=i[3*s+m]+l[m]}for(var m=0;m<i.length;)Ir(l,i[m],i[m+1],i[m+2]),gr.normalize(l,l),i[m++]=l[0],i[m++]=l[1],i[m++]=l[2];this.dirty()}},generateFaceNormals:function(){if(this.vertexCount){this.isUniqueVertex()||this.generateUniqueVertex();var t=this.indices,r=this.attributes,e=r.position.value,i=r.normal.value,n=Rr(),a=Rr(),s=Rr(),o=Rr(),u=Rr(),h=Rr();i||(i=r.normal.value=new Float32Array(e.length));for(var c,_,l,f=t?t.length:this.vertexCount,d=0;d<f;){t?(c=t[d++],_=t[d++],l=t[d++]):(c=d++,_=d++,l=d++),Ir(n,e[3*c],e[3*c+1],e[3*c+2]),Ir(a,e[3*_],e[3*_+1],e[3*_+2]),Ir(s,e[3*l],e[3*l+1],e[3*l+2]),gr.sub(o,n,a),gr.sub(u,a,s),gr.cross(h,o,u),gr.normalize(h,h);for(var m=0;m<3;m++)i[3*c+m]=h[m],i[3*_+m]=h[m],i[3*l+m]=h[m]}this.dirty()}},generateTangents:function(){if(this.vertexCount){var t=this.vertexCount,r=this.attributes;r.tangent.value||(r.tangent.value=new Float32Array(4*t));var e=r.texcoord0.value,i=r.position.value,n=r.tangent.value,a=r.normal.value;if(e){for(var s=[],o=[],u=0;u<t;u++)s[u]=[0,0,0],o[u]=[0,0,0];for(var h,c,_,l=[0,0,0],f=[0,0,0],d=this.indices,m=d?d.length:this.vertexCount,u=0;u<m;){d?(h=d[u++],c=d[u++],_=d[u++]):(h=u++,c=u++,_=u++);var y=e[2*h],p=e[2*c],v=e[2*_],E=e[2*h+1],T=e[2*c+1],g=e[2*_+1],A=i[3*h],R=i[3*c],S=i[3*_],I=i[3*h+1],N=i[3*c+1],x=i[3*_+1],M=i[3*h+2],O=R-A,b=S-A,P=N-I,w=x-I,L=i[3*c+2]-M,C=i[3*_+2]-M,D=p-y,U=v-y,B=T-E,F=g-E,V=1/(D*F-B*U);l[0]=(F*O-B*b)*V,l[1]=(F*P-B*w)*V,l[2]=(F*L-B*C)*V,f[0]=(D*b-U*O)*V,f[1]=(D*w-U*P)*V,f[2]=(D*C-U*L)*V,Sr(s[h],s[h],l),Sr(s[c],s[c],l),Sr(s[_],s[_],l),Sr(o[h],o[h],f),Sr(o[c],o[c],f),Sr(o[_],o[_],f)}for(var W=Rr(),X=Rr(),G=Rr(),u=0;u<t;u++){G[0]=a[3*u],G[1]=a[3*u+1],G[2]=a[3*u+2];var k=s[u];gr.scale(W,G,gr.dot(G,k)),gr.sub(W,k,W),gr.normalize(W,W),gr.cross(X,G,k),n[4*u]=W[0],n[4*u+1]=W[1],n[4*u+2]=W[2],n[4*u+3]=gr.dot(X,o[u])<0?-1:1}this.dirty()}else console.warn("Geometry without texcoords can't generate tangents.")}},isUniqueVertex:function(){return!this.isUseIndices()||this.vertexCount===this.indices.length},generateUniqueVertex:function(){if(this.vertexCount&&this.indices){this.indices.length>65535&&(this.indices=new C.Uint32Array(this.indices));for(var t=this.attributes,r=this.indices,e=this.getEnabledAttributes(),i={},n=0;n<e.length;n++)i[u=e[n]]=t[u].value,t[u].init(this.indices.length);for(var a=0,s=0;s<r.length;s++){for(var o=r[s],n=0;n<e.length;n++)for(var u=e[n],h=t[u].value,c=t[u].size,_=0;_<c;_++)h[a*c+_]=i[u][o*c+_];r[s]=a,a++}this.dirty()}},generateBarycentric:function(){if(this.vertexCount){this.isUniqueVertex()||this.generateUniqueVertex();var t=this.attributes,r=t.barycentric.value,e=this.indices;if(!r||r.length!==3*e.length){r=t.barycentric.value=new Float32Array(3*e.length);for(var i=0;i<(e?e.length:this.vertexCount/3);)for(var n=0;n<3;n++)r[3*(e?e[i++]:3*i+n)+n]=1;this.dirty()}}},applyTransform:function(t){var r=this.attributes,e=r.position.value,i=r.normal.value,n=r.tangent.value;t=t._array;var a=Ar.create();Ar.invert(a,t),Ar.transpose(a,a);var s=gr.transformMat4,o=gr.forEach;o(e,3,0,null,s,t),i&&o(i,3,0,null,s,a),n&&o(n,4,0,null,s,a),this.boundingBox&&this.updateBoundingBox()},dispose:function(t){var r=this._cache;r.use(t.__GUID__);var e=r.get("chunks");if(e)for(var i=0;i<e.length;i++)for(var n=e[i],a=0;a<n.attributeBuffers.length;a++){var s=n.attributeBuffers[a];t.gl.deleteBuffer(s.buffer)}r.deleteContext(t.__GUID__)}});Object.defineProperty&&(Object.defineProperty(Nr.prototype,"vertexCount",{enumerable:!1,get:function(){var t=this.attributes[this.mainAttribute];return t&&t.value?t.value.length/t.size:0}}),Object.defineProperty(Nr.prototype,"triangleCount",{enumerable:!1,get:function(){var t=this.indices;return t?t.length/3:0}})),Nr.STATIC_DRAW=P.STATIC_DRAW,Nr.DYNAMIC_DRAW=P.DYNAMIC_DRAW,Nr.STREAM_DRAW=P.STREAM_DRAW,Nr.AttributeBuffer=E,Nr.IndicesBuffer=T,Nr.Attribute=v;dt.import("@export qtek.particle.vertex\nuniform mat4 worldView : WORLDVIEW;\nuniform mat4 projection : PROJECTION;\nattribute vec3 position : POSITION;\nattribute vec3 normal : NORMAL;\n#ifdef UV_ANIMATION\nattribute vec2 texcoord0 : TEXCOORD_0;\nattribute vec2 texcoord1 : TEXCOORD_1;\nvarying vec2 v_Uv0;\nvarying vec2 v_Uv1;\n#endif\nvarying float v_Age;\nvoid main() {\n    v_Age = normal.x;\n    float rotation = normal.y;\n    vec4 worldViewPosition = worldView * vec4(position, 1.0);\n    gl_Position = projection * worldViewPosition;\n    float w = gl_Position.w;\n    gl_PointSize = normal.z * projection[0].x / w;\n    #ifdef UV_ANIMATION\n        v_Uv0 = texcoord0;\n        v_Uv1 = texcoord1;\n    #endif\n}\n@end\n@export qtek.particle.fragment\nuniform sampler2D sprite;\nuniform sampler2D gradient;\nuniform vec3 color : [1.0, 1.0, 1.0];\nuniform float alpha : 1.0;\nvarying float v_Age;\n#ifdef UV_ANIMATION\nvarying vec2 v_Uv0;\nvarying vec2 v_Uv1;\n#endif\nvoid main() {\n    vec4 color = vec4(color, alpha);\n    #ifdef SPRITE_ENABLED\n        #ifdef UV_ANIMATION\n            color *= texture2D(sprite, mix(v_Uv0, v_Uv1, gl_PointCoord));\n        #else\n            color *= texture2D(sprite, gl_PointCoord);\n        #endif\n    #endif\n    #ifdef GRADIENT_ENABLED\n        color *= texture2D(gradient, vec2(v_Age, 0.5));\n    #endif\n    gl_FragColor = color;\n}\n@end");var xr=new dt({vertex:dt.source("qtek.particle.vertex"),fragment:dt.source("qtek.particle.fragment")});xr.enableTexture("sprite");var Mr=Tr.extend({loop:!0,oneshot:!1,duration:1,spriteAnimationTileX:1,spriteAnimationTileY:1,spriteAnimationRepeat:0,mode:Tr.POINTS,ignorePicking:!0,_elapsedTime:0,_emitting:!0},function(){this.geometry=new Nr({dynamic:!0}),this.material||(this.material=new vt({shader:xr,transparent:!0,depthMask:!1})),this._particles=[],this._fields=[],this._emitters=[]},{culling:!1,frustumCulling:!1,castShadow:!1,receiveShadow:!1,addEmitter:function(t){this._emitters.push(t)},removeEmitter:function(t){this._emitters.splice(this._emitters.indexOf(t),1)},addField:function(t){this._fields.push(t)},removeField:function(t){this._fields.splice(this._fields.indexOf(t),1)},reset:function(){for(var t=0;t<this._particles.length;t++){var r=this._particles[t];r.emitter.kill(r)}this._particles.length=0,this._elapsedTime=0,this._emitting=!0},updateParticles:function(t){t/=1e3,this._elapsedTime+=t;var r=this._particles;if(this._emitting){for(i=0;i<this._emitters.length;i++)this._emitters[i].emit(r);this.oneshot&&(this._emitting=!1)}for(var e=r.length,i=0;i<e;)(n=r[i]).age+=t,n.age>=n.life?(n.emitter.kill(n),r[i]=r[e-1],r.pop(),e--):i++;for(i=0;i<e;i++){var n=r[i];if(this._fields.length>0)for(var a=0;a<this._fields.length;a++)this._fields[a].applyTo(n.velocity,n.position,n.weight,t);n.update(t)}this._updateVertices()},_updateVertices:function(){var t=this.geometry,r=this.spriteAnimationTileX,e=this.spriteAnimationTileY,i=this.spriteAnimationRepeat,n=e*r*i,a=n>1,s=t.attributes.position.value,o=t.attributes.normal.value,u=t.attributes.texcoord0.value,h=t.attributes.texcoord1.value,c=this._particles.length;s&&s.length===3*c||(s=t.attributes.position.value=new Float32Array(3*c),o=t.attributes.normal.value=new Float32Array(3*c),a&&(u=t.attributes.texcoord0.value=new Float32Array(2*c),h=t.attributes.texcoord1.value=new Float32Array(2*c)));for(var _=1/r,l=0;l<c;l++){for(var f=this._particles[l],d=3*l,m=0;m<3;m++)s[d+m]=f.position._array[m],o[d]=f.age/f.life,o[d+1]=0,o[d+2]=f.spriteSize;var y=2*l;if(a){var p=f.age/f.life,v=Math.round(p*(n-1))*i,E=Math.floor(v*_),T=v-E*r;u[y]=T/r,u[y+1]=1-E/e,h[y]=(T+1)/r,h[y+1]=1-(E+1)/e}}t.dirty()},isFinished:function(){return this._elapsedTime>this.duration&&!this.loop},dispose:function(t){for(var r=0;r<this._particles.length;r++){var e=this._particles[r];e.emitter.kill(e)}this.geometry.dispose(t)},clone:function(){var t=new Mr({material:this.material});t.loop=this.loop,t.duration=this.duration,t.oneshot=this.oneshot,t.spriteAnimationRepeat=this.spriteAnimationRepeat,t.spriteAnimationTileY=this.spriteAnimationTileY,t.spriteAnimationTileX=this.spriteAnimationTileX,t.position.copy(this.position),t.rotation.copy(this.rotation),t.scale.copy(this.scale);for(var r=0;r<this._children.length;r++)t.add(this._children[r].clone());return t}}),Or=D.vec3,br=function(){this.position=new B,this.rotation=new B,this.velocity=null,this.angularVelocity=null,this.life=1,this.age=0,this.spriteSize=1,this.weight=1,this.emitter=null};br.prototype.update=function(t){this.velocity&&Or.scaleAndAdd(this.position._array,this.position._array,this.velocity._array,t),this.angularVelocity&&Or.scaleAndAdd(this.rotation._array,this.rotation._array,this.angularVelocity._array,t)};var Pr=function(){};Pr.prototype.get=function(t){};var wr=function(t){this.get=function(){return t}};(wr.prototype=new Pr).constructor=wr;var Lr=function(t){var r=t.constructor;this.get=function(e){return e||(e=new r),e.copy(t),e}};(Lr.prototype=new Pr).constructor=Lr;var Cr=function(t,r){var e=r-t;this.get=function(){return Math.random()*e+t}};(Cr.prototype=new Pr).constructor=Cr;var Dr=function(t,r){var e=r.x-t.x,i=r.y-t.y;this.get=function(r){return r||(r=new Tt),Tt.set(r,e*Math.random()+t._array[0],i*Math.random()+t._array[1]),r}};(Dr.prototype=new Pr).constructor=Dr;var Ur=function(t,r){var e=r.x-t.x,i=r.y-t.y,n=r.z-t.z;this.get=function(r){return r||(r=new B),B.set(r,e*Math.random()+t._array[0],i*Math.random()+t._array[1],n*Math.random()+t._array[2]),r}};(Ur.prototype=new Pr).constructor=Ur,Pr.constant=function(t){return new wr(t)},Pr.vector=function(t){return new Lr(t)},Pr.random1D=function(t,r){return new Cr(t,r)},Pr.random2D=function(t,r){return new Dr(t,r)},Pr.random3D=function(t,r){return new Ur(t,r)};D.vec3;var Br=M.extend({max:1e3,amount:20,life:null,position:null,rotation:null,velocity:null,angularVelocity:null,spriteSize:null,weight:null,_particlePool:null},function(){this._particlePool=[];for(var t=0;t<this.max;t++){var r=new br;r.emitter=this,this._particlePool.push(r),this.velocity&&(r.velocity=new B),this.angularVelocity&&(r.angularVelocity=new B)}},{emit:function(t){for(var r,e=Math.min(this._particlePool.length,this.amount),i=0;i<e;i++)r=this._particlePool.pop(),this.position&&this.position.get(r.position),this.rotation&&this.rotation.get(r.rotation),this.velocity&&this.velocity.get(r.velocity),this.angularVelocity&&this.angularVelocity.get(r.angularVelocity),this.life&&(r.life=this.life.get()),this.spriteSize&&(r.spriteSize=this.spriteSize.get()),this.weight&&(r.weight=this.weight.get()),r.age=0,t.push(r)},kill:function(t){this._particlePool.push(t)}});Br.constant=Pr.constant,Br.vector=Pr.vector,Br.random1D=Pr.random1D,Br.random2D=Pr.random2D,Br.random3D=Pr.random3D;var Fr=Tr.extend({skeleton:null,joints:null,useSkinMatricesTexture:!1},function(){this.joints||(this.joints=[])},{isSkinnedMesh:function(){return!(!this.skeleton||!this.material.shader.isDefined("vertex","SKINNING"))},render:function(t,r){var e=t.gl;if(r=r||this.material.shader,this.skeleton){this.skeleton.update();var i=this.skeleton.getSubSkinMatrices(this.__GUID__,this.joints);if(this.useSkinMatricesTexture){var n,a=this.joints.length;n=a>256?64:a>64?32:a>16?16:8;var s=this.getSkinMatricesTexture();s.width=n,s.height=n,s.pixels&&s.pixels.length===n*n*4||(s.pixels=new Float32Array(n*n*4)),s.pixels.set(i),s.dirty(),r.setUniform(e,"1f","skinMatricesTextureSize",n)}else r.setUniformOfSemantic(e,"SKIN_MATRIX",i)}return Tr.prototype.render.call(this,t,r)},getSkinMatricesTexture:function(){return this._skinMatricesTexture=this._skinMatricesTexture||new or({type:P.FLOAT,minFilter:P.NEAREST,magFilter:P.NEAREST,useMipmap:!1,flipY:!1}),this._skinMatricesTexture}});Fr.POINTS=P.POINTS,Fr.LINES=P.LINES,Fr.LINE_LOOP=P.LINE_LOOP,Fr.LINE_STRIP=P.LINE_STRIP,Fr.TRIANGLES=P.TRIANGLES,Fr.TRIANGLE_STRIP=P.TRIANGLE_STRIP,Fr.TRIANGLE_FAN=P.TRIANGLE_FAN,Fr.BACK=P.BACK,Fr.FRONT=P.FRONT,Fr.FRONT_AND_BACK=P.FRONT_AND_BACK,Fr.CW=P.CW,Fr.CCW=P.CCW;var Vr=Nr.extend({dynamic:!1,widthSegments:1,heightSegments:1},function(){this.build()},{build:function(){for(var t=this.heightSegments,r=this.widthSegments,e=this.attributes,i=[],n=[],a=[],s=[],o=0;o<=t;o++)for(var u=o/t,h=0;h<=r;h++){var c=h/r;if(i.push([2*c-1,2*u-1,0]),n&&n.push([c,u]),a&&a.push([0,0,1]),h<r&&o<t){var _=h+o*(r+1);s.push([_,_+1,_+r+1]),s.push([_+r+1,_+1,_+r+2])}}e.position.fromArray(i),e.texcoord0.fromArray(n),e.normal.fromArray(a),this.initIndicesFromArray(s),this.boundingBox=new z,this.boundingBox.min.set(-1,-1,0),this.boundingBox.max.set(1,1,0)}}),Wr=new K,Xr=Nr.extend({dynamic:!1,widthSegments:1,heightSegments:1,depthSegments:1,inside:!1},function(){this.build()},{build:function(){var t={px:g("px",this.depthSegments,this.heightSegments),nx:g("nx",this.depthSegments,this.heightSegments),py:g("py",this.widthSegments,this.depthSegments),ny:g("ny",this.widthSegments,this.depthSegments),pz:g("pz",this.widthSegments,this.heightSegments),nz:g("nz",this.widthSegments,this.heightSegments)},r=["position","texcoord0","normal"],e=0,i=0;for(var n in t)e+=t[n].vertexCount,i+=t[n].indices.length;for(u=0;u<r.length;u++)this.attributes[r[u]].init(e);this.indices=new C.Uint16Array(i);var a=0,s=0;for(var n in t){for(var o=t[n],u=0;u<r.length;u++)for(var h=r[u],c=o.attributes[h].value,_=o.attributes[h].size,l="normal"===h,f=0;f<c.length;f++){var d=c[f];this.inside&&l&&(d=-d),this.attributes[h].value[f+_*s]=d}for(f=0;f<o.indices.length;f++)this.indices[f+a]=s+o.indices[f];a+=o.indices.length,s+=o.vertexCount}this.boundingBox=new z,this.boundingBox.max.set(1,1,1),this.boundingBox.min.set(-1,-1,-1)}});dt.import("@export qtek.skybox.vertex\nuniform mat4 world : WORLD;\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nattribute vec3 position : POSITION;\nvarying vec3 v_WorldPosition;\nvoid main()\n{\n    v_WorldPosition = (world * vec4(position, 1.0)).xyz;\n    gl_Position = worldViewProjection * vec4(position, 1.0);\n}\n@end\n@export qtek.skybox.fragment\nuniform mat4 viewInverse : VIEWINVERSE;\nuniform samplerCube environmentMap;\nuniform float lod: 0.0;\nvarying vec3 v_WorldPosition;\nvoid main()\n{\n    vec3 eyePos = viewInverse[3].xyz;\n    vec3 viewDirection = normalize(v_WorldPosition - eyePos);\n    vec3 tex = textureCube(environmentMap, viewDirection).rgb;\n#ifdef SRGB_DECODE\n    tex.rgb = pow(tex.rgb, vec3(2.2));\n#endif\n    gl_FragColor = vec4(tex, 1.0);\n}\n@end");var Gr=Fr.extend(function(){var t=new dt({vertex:dt.source("qtek.skybox.vertex"),fragment:dt.source("qtek.skybox.fragment")}),r=new vt({shader:t,depthMask:!1});return{scene:null,geometry:new Xr,material:r,environmentMap:null,culling:!1}},function(){var t=this.scene;t&&this.attachScene(t),this.environmentMap&&this.setEnvironmentMap(this.environmentMap)},{attachScene:function(t){this.scene&&this.detachScene(),this.scene=t,t.on("beforerender",this._beforeRenderScene,this)},detachScene:function(){this.scene&&this.scene.off("beforerender",this._beforeRenderScene),this.scene=null},dispose:function(t){this.detachScene(),this.geometry.dispose(t),this.material.dispose(t)},setEnvironmentMap:function(t){this.material.set("environmentMap",t)},getEnvironmentMap:function(){return this.material.get("environmentMap")},_beforeRenderScene:function(t,r,e){this.renderSkybox(t,e)},renderSkybox:function(t,r){this.position.copy(r.getWorldPosition()),this.update(),t.gl.disable(t.gl.BLEND),t.renderQueue([this],r)}}),kr=window.requestAnimationFrame||window.msRequestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(t){setTimeout(t,16)};return A.prototype={constructor:A,loadCubemap:function(t,r,e){this._cubemap&&this._cubemap.dispose(this._renderer);var i=this._cubemap=new ar({flipY:!1});this._skybox.setEnvironmentMap(i),i.load(t),i.success(function(){if(i.image.py){var t=document.createElement("canvas");t.width=i.image.py.width,t.height=i.image.py.height;var e=t.getContext("2d");e.translate(t.width,t.height),e.scale(-1,-1),e.drawImage(i.image.py,0,0,t.width,t.height),i.image.py=t}r&&r()}),i.error(function(){e&&e()})},initParticleEffect:function(t){if(!this._particleRendeable){var r=(t=t||{}).speed||[[-.1,-2,-.1],[.1,-1,.1]],e=new B,i=new B;e.setArray(r[0]),e.setArray(r[1]);var n=t.size||[20,100],a=t.life||[5,8];this._particleRendeable=new Mr,this._emitter=new Br({amount:t.amount||5,max:t.max||1e3,position:Pr.random3D(new B(-10,-10,-10),new B(10,10,10)),velocity:Pr.random3D(e,i),spriteSize:Pr.random1D(n[0],n[1]),life:Pr.random1D(a[0],a[1])}),this._particleRendeable.addEmitter(this._emitter);var s=new or;s.load(t.sprite).success(function(){this._scene.add(this._particleRendeable)},this),this._particleRendeable.material.shader.enableTexture("sprite"),this._particleRendeable.material.set("sprite",s)}},_doRender:function(){this._renderer.render(this._scene,this._camera)},start:function(){function t(){r._running&&(r._control.update(16),r._particleRendeable&&r._particleRendeable.updateParticles(16),r._doRender(),kr(t))}if(!this._running){this._running=!0;var r=this;kr(t)}},stop:function(){this._running=!1},resize:function(){this._renderer.resize(this._root.clientWidth,this._root.clientHeight),this._camera.aspect=this._renderer.getViewportAspect()},dispose:function(){this.stop(),this._control.dispose(),this._skybox.dispose(this._renderer),this._cubemap.dispose(this._renderer),this._renderer.disposeScene(this._scene),this._renderer.dispose(),this._root.innerHTML=""}},A});
